import { useState, useRef, useEffect, useCallback } from 'react';
import * as XLSX from 'xlsx';
import { supabase, toCamelCase, toSnakeCase } from './lib/supabase';
import jsPDF from 'jspdf';
import 'jspdf-autotable';

const defaultCustomers = [];
const defaultVisaApplications = [];
const defaultTours = [];
const defaultHotels = [];
const defaultHotelReservations = [];
const defaultUsers = [{ id: 1, email: 'onder@paydostur.com', password: '123456', name: 'Ã–nder', role: 'admin' }];

const turkishProvinces = ['Adana', 'AdÄ±yaman', 'Afyonkarahisar', 'AÄŸrÄ±', 'Amasya', 'Ankara', 'Antalya', 'Artvin', 'AydÄ±n', 'BalÄ±kesir', 'Bilecik', 'BingÃ¶l', 'Bitlis', 'Bolu', 'Burdur', 'Bursa', 'Ã‡anakkale', 'Ã‡ankÄ±rÄ±', 'Ã‡orum', 'Denizli', 'DiyarbakÄ±r', 'Edirne', 'ElazÄ±ÄŸ', 'Erzincan', 'Erzurum', 'EskiÅŸehir', 'Gaziantep', 'Giresun', 'GÃ¼mÃ¼ÅŸhane', 'Hakkari', 'Hatay', 'Isparta', 'Mersin', 'Ä°stanbul', 'Ä°zmir', 'Kars', 'Kastamonu', 'Kayseri', 'KÄ±rklareli', 'KÄ±rÅŸehir', 'Kocaeli', 'Konya', 'KÃ¼tahya', 'Malatya', 'Manisa', 'KahramanmaraÅŸ', 'Mardin', 'MuÄŸla', 'MuÅŸ', 'NevÅŸehir', 'NiÄŸde', 'Ordu', 'Rize', 'Sakarya', 'Samsun', 'Siirt', 'Sinop', 'Sivas', 'TekirdaÄŸ', 'Tokat', 'Trabzon', 'Tunceli', 'ÅanlÄ±urfa', 'UÅŸak', 'Van', 'Yozgat', 'Zonguldak', 'Aksaray', 'Bayburt', 'Karaman', 'KÄ±rÄ±kkale', 'Batman', 'ÅÄ±rnak', 'BartÄ±n', 'Ardahan', 'IÄŸdÄ±r', 'Yalova', 'KarabÃ¼k', 'Kilis', 'Osmaniye', 'DÃ¼zce'];
const sectors = ['Adalet ve GÃ¼venlik', 'AÄŸaÃ§ Ä°ÅŸleri, KaÄŸÄ±t ve KaÄŸÄ±t ÃœrÃ¼nleri', 'BiliÅŸim Teknolojileri', 'Cam, Ã‡imento ve Toprak', 'Ã‡evre', 'Devlet Memuru', 'EÄŸitim', 'Elektrik ve Elektronik', 'Enerji', 'Finans', 'GÄ±da', 'Ä°nÅŸaat', 'Ä°ÅŸ ve YÃ¶netim', 'Kimya, Petrol, Lastik ve Plastik', 'KÃ¼ltÃ¼r, Sanat ve TasarÄ±m', 'Maden', 'Makine', 'Medya, Ä°letiÅŸim ve YayÄ±ncÄ±lÄ±k', 'Metal', 'Otomotiv', 'SaÄŸlÄ±k ve Sosyal Hizmetler', 'Spor ve Rekreasyon', 'TarÄ±m, AvcÄ±lÄ±k ve BalÄ±kÃ§Ä±lÄ±k', 'Tekstil, HazÄ±r Giyim, Deri', 'Ticaret (SatÄ±ÅŸ ve Pazarlama)', 'Toplumsal ve KiÅŸisel Hizmetler', 'Turizm, Konaklama, Yiyecek-Ä°Ã§ecek Hizmetleri', 'UlaÅŸtÄ±rma, Lojistik ve HaberleÅŸme'];
const passportTypes = ['Bordo Pasaport (Umuma Mahsus)', 'YeÅŸil Pasaport (Hususi)', 'Gri Pasaport (Hizmet)', 'Siyah Pasaport (Diplomatik)'];
const schengenCountries = ['Almanya', 'Avusturya', 'BelÃ§ika', 'Ã‡ekya', 'Danimarka', 'Estonya', 'Finlandiya', 'Fransa', 'HÄ±rvatistan', 'Hollanda', 'Ä°spanya', 'Ä°sveÃ§', 'Ä°sviÃ§re', 'Ä°talya', 'Ä°zlanda', 'Letonya', 'Liechtenstein', 'Litvanya', 'LÃ¼ksemburg', 'Macaristan', 'Malta', 'NorveÃ§', 'Polonya', 'Portekiz', 'Slovakya', 'Slovenya', 'Yunanistan'];
const visaStatuses = ['Evrak Topluyor', 'Evrak TamamlandÄ±', 'Evraklar GÃ¶nderildi', 'E-posta GÃ¶nderildi', 'Randevu Bekliyor', 'BaÅŸvuru YapÄ±ldÄ±', 'SonuÃ§ Bekliyor', 'MÃ¼ÅŸteri Ä°ptal Etti'];
const tourStatuses = ['Planlama', 'AÃ§Ä±k', 'Dolu', 'Devam Ediyor', 'TamamlandÄ±', 'Ä°ptal'];
const mealPlans = ['Sadece Oda', 'Oda + KahvaltÄ±', 'YarÄ±m Pansiyon', 'Tam Pansiyon', 'Her Åey Dahil'];
const currencies = ['â‚¬ Euro', '$ Dolar', 'â‚º TL', 'Â£ Sterlin'];

const labelStyle = { display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px', fontWeight: '500' };
const inputStyle = { width: '100%', padding: '10px 12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', outline: 'none', boxSizing: 'border-box' };
const selectStyle = { width: '100%', padding: '10px 12px', background: '#0f2744', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', outline: 'none', boxSizing: 'border-box' };
const dateSelectStyle = { padding: '10px 6px', background: '#0f2744', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '8px', color: '#e8f1f8', fontSize: '13px', outline: 'none' };

const isValidEmail = (e) => !e || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
const formatDate = (d) => { if (!d) return '-'; if (typeof d !== 'string') d = String(d); if (d.includes('-')) return d.split('-').reverse().join('.'); if (d.includes('.')) return d; return d; };
const safeParseTags = (val) => { if (!val) return []; if (Array.isArray(val)) return val.filter(t => t && typeof t === 'string'); if (typeof val === 'string') return val.split(',').map(t => t.trim()).filter(Boolean); return []; };
const safeParseActivities = (val) => { if (!val) return []; if (Array.isArray(val)) return val; if (typeof val === 'string') { try { const parsed = JSON.parse(val); return Array.isArray(parsed) ? parsed : []; } catch { return []; } } return []; };
const safeParseJSON = (val) => { if (!val) return []; if (Array.isArray(val)) return val; if (typeof val === 'string') { try { const parsed = JSON.parse(val); return Array.isArray(parsed) ? parsed : []; } catch { return []; } } return []; };
const safeParseDate = (dateStr) => { if (!dateStr || typeof dateStr !== 'string') return null; const parts = dateStr.split('-'); if (parts.length !== 3) return null; const [year, month, day] = parts.map(Number); if (isNaN(year) || isNaN(month) || isNaN(day)) return null; const date = new Date(year, month - 1, day, 12, 0, 0); if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) return null; return date; };
const safeParseNumber = (val) => { if (!val) return 0; const cleaned = String(val).replace(/[â‚¬$Â£â‚º\s]/g, '').replace(',', '.'); const num = parseFloat(cleaned); return isNaN(num) ? 0 : num; };
const getDaysLeft = (dateStr) => { const date = safeParseDate(dateStr); if (!date) return null; const today = new Date(); today.setHours(0, 0, 0, 0); date.setHours(0, 0, 0, 0); return Math.ceil((date - today) / (1000 * 60 * 60 * 24)); };
const generateUniqueId = () => Date.now() + Math.random();

// Telefon formatla: +90 5XX XXX XX XX
const formatPhoneNumber = (value) => {
  let cleaned = value.replace(/\D/g, '');
  // 90 ile baÅŸlÄ±yorsa kaldÄ±r
  if (cleaned.startsWith('90')) cleaned = cleaned.slice(2);
  // 0 ile baÅŸlÄ±yorsa kaldÄ±r
  if (cleaned.startsWith('0')) cleaned = cleaned.slice(1);
  // Max 10 hane
  cleaned = cleaned.slice(0, 10);
  // Format: XXX XXX XX XX
  let formatted = '';
  if (cleaned.length > 0) formatted += cleaned.slice(0, 3);
  if (cleaned.length > 3) formatted += ' ' + cleaned.slice(3, 6);
  if (cleaned.length > 6) formatted += ' ' + cleaned.slice(6, 8);
  if (cleaned.length > 8) formatted += ' ' + cleaned.slice(8, 10);
  return formatted ? '+90 ' + formatted : '+90 5';
};

// Pasaport No formatla: Ä°lk harf bÃ¼yÃ¼k, 9 karakter
const formatPassportNo = (value) => {
  // BoÅŸluk ve Ã¶zel karakterleri temizle
  let cleaned = value.toUpperCase().replace(/[^A-Z0-9]/g, '');
  
  if (cleaned.length === 0) return '';
  
  // Ä°lk karakter HARF olmalÄ±
  let firstChar = cleaned[0];
  if (!/[A-Z]/.test(firstChar)) {
    // Ä°lk karakter harf deÄŸilse, ilk harfi bul veya boÅŸ dÃ¶n
    const firstLetterMatch = cleaned.match(/[A-Z]/);
    if (!firstLetterMatch) return '';
    firstChar = firstLetterMatch[0];
    cleaned = cleaned.replace(firstChar, ''); // Harfi Ã§Ä±kar
  } else {
    cleaned = cleaned.slice(1); // Ä°lk harfi ayÄ±r
  }
  
  // Geriye kalan sadece RAKAM olmalÄ± (8 hane)
  const numbers = cleaned.replace(/[^0-9]/g, '').slice(0, 8);
  
  return firstChar + numbers;
};

// Toast Component
function Toast({ toasts, removeToast }) {
  return (
    <div style={{ position: 'fixed', top: '20px', right: '20px', zIndex: 9999, display: 'flex', flexDirection: 'column', gap: '10px' }}>
      {toasts.map(toast => (
        <div key={toast.id} onClick={() => removeToast(toast.id)} style={{
          padding: '14px 20px',
          borderRadius: '12px',
          background: toast.type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 
                      toast.type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 
                      toast.type === 'warning' ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 
                      'linear-gradient(135deg, #3b82f6, #2563eb)',
          color: 'white',
          boxShadow: '0 10px 40px rgba(0,0,0,0.3)',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '10px',
          minWidth: '250px',
          maxWidth: '400px',
          animation: 'slideIn 0.3s ease',
          fontSize: '14px',
          fontWeight: '500'
        }}>
          <span style={{ fontSize: '18px' }}>
            {toast.type === 'success' ? 'âœ…' : toast.type === 'error' ? 'âŒ' : toast.type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}
          </span>
          <span style={{ flex: 1 }}>{toast.message}</span>
          {toast.undo && (
            <button onClick={(e) => { e.stopPropagation(); toast.undo(); removeToast(toast.id); }} style={{
              background: 'rgba(255,255,255,0.2)',
              border: 'none',
              borderRadius: '6px',
              padding: '6px 12px',
              color: 'white',
              cursor: 'pointer',
              fontSize: '12px',
              fontWeight: '600'
            }}>â†©ï¸ Geri Al</button>
          )}
        </div>
      ))}
      <style>{`@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }`}</style>
    </div>
  );
}

// Loading Button Component
function LoadingButton({ onClick, loading, disabled, children, style, ...props }) {
  return (
    <button 
      onClick={onClick} 
      disabled={loading || disabled}
      style={{
        ...style,
        opacity: (loading || disabled) ? 0.6 : 1,
        cursor: (loading || disabled) ? 'not-allowed' : 'pointer',
        position: 'relative'
      }}
      {...props}
    >
      {loading ? (
        <span style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
          <span style={{ 
            width: '16px', 
            height: '16px', 
            border: '2px solid rgba(255,255,255,0.3)', 
            borderTop: '2px solid white', 
            borderRadius: '50%', 
            animation: 'spin 0.8s linear infinite' 
          }} />
          Ä°ÅŸleniyor...
        </span>
      ) : children}
      <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
    </button>
  );
}

// Form Error Component
function FormError({ error }) {
  if (!error) return null;
  return (
    <p style={{ 
      margin: '4px 0 0', 
      fontSize: '11px', 
      color: '#ef4444',
      display: 'flex',
      alignItems: 'center',
      gap: '4px'
    }}>
      âš ï¸ {error}
    </p>
  );
}

function CalendarPicker({ label, value, onChange, minYear = 1920, maxYear = 2035, maxDate = null, minDate = null }) {
  const [isOpen, setIsOpen] = useState(false);
  const [viewDate, setViewDate] = useState(() => {
    if (value) {
      const parts = value.split('-');
      return { year: parseInt(parts[0]), month: parseInt(parts[1]) - 1 };
    }
    return { year: new Date().getFullYear(), month: new Date().getMonth() };
  });
  
  const months = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
  const days = ['Pt', 'Sa', 'Ã‡a', 'Pe', 'Cu', 'Ct', 'Pz'];
  
  const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
  const getFirstDayOfMonth = (year, month) => {
    const day = new Date(year, month, 1).getDay();
    return day === 0 ? 6 : day - 1;
  };
  
  const formatDisplay = (val) => {
    if (!val) return '';
    const parts = val.split('-');
    if (parts.length !== 3) return val;
    return `${parts[2]}.${parts[1]}.${parts[0]}`;
  };
  
  const handleSelect = (day) => {
    const dateStr = `${viewDate.year}-${String(viewDate.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    onChange(dateStr);
    setIsOpen(false);
  };
  
  const prevMonth = () => {
    setViewDate(prev => {
      if (prev.month === 0) return { year: prev.year - 1, month: 11 };
      return { ...prev, month: prev.month - 1 };
    });
  };
  
  const nextMonth = () => {
    setViewDate(prev => {
      if (prev.month === 11) return { year: prev.year + 1, month: 0 };
      return { ...prev, month: prev.month + 1 };
    });
  };
  
  const isDateDisabled = (day) => {
    const date = new Date(viewDate.year, viewDate.month, day);
    if (maxDate && date > new Date(maxDate)) return true;
    if (minDate && date < new Date(minDate)) return true;
    return false;
  };
  
  const isToday = (day) => {
    const today = new Date();
    return viewDate.year === today.getFullYear() && viewDate.month === today.getMonth() && day === today.getDate();
  };
  
  const isSelected = (day) => {
    if (!value) return false;
    const parts = value.split('-');
    return parseInt(parts[0]) === viewDate.year && parseInt(parts[1]) - 1 === viewDate.month && parseInt(parts[2]) === day;
  };
  
  const years = Array.from({ length: maxYear - minYear + 1 }, (_, i) => minYear + i);
  const daysInMonth = getDaysInMonth(viewDate.year, viewDate.month);
  const firstDay = getFirstDayOfMonth(viewDate.year, viewDate.month);
  const calendarDays = Array.from({ length: 42 }, (_, i) => {
    const day = i - firstDay + 1;
    return day > 0 && day <= daysInMonth ? day : null;
  });

  return (
    <div style={{ position: 'relative' }}>
      <label style={labelStyle}>{label}</label>
      <div 
        onClick={() => setIsOpen(!isOpen)}
        style={{ ...inputStyle, cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}
      >
        <span style={{ color: value ? '#e8f1f8' : '#64748b' }}>{formatDisplay(value) || 'Tarih seÃ§in'}</span>
        <span style={{ fontSize: '14px' }}>ğŸ“…</span>
      </div>
      
      {isOpen && (
        <>
          <div onClick={() => setIsOpen(false)} style={{ position: 'fixed', inset: 0, zIndex: 400 }} />
          <div style={{ position: 'absolute', top: '100%', left: 0, right: 0, marginTop: '4px', background: '#0f2744', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '12px', padding: '12px', zIndex: 401, boxShadow: '0 10px 40px rgba(0,0,0,0.5)', minWidth: '280px' }}>
            {/* Header - Month/Year Select */}
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
              <button type="button" onClick={prevMonth} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', width: '32px', height: '32px', color: '#e8f1f8', cursor: 'pointer', fontSize: '16px' }}>â€¹</button>
              <div style={{ display: 'flex', gap: '8px' }}>
                <select 
                  value={viewDate.month} 
                  onChange={e => setViewDate({ ...viewDate, month: parseInt(e.target.value) })}
                  style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '6px 8px', color: '#e8f1f8', fontSize: '13px', cursor: 'pointer' }}
                >
                  {months.map((m, i) => <option key={i} value={i} style={{ background: '#0f2744' }}>{m}</option>)}
                </select>
                <select 
                  value={viewDate.year} 
                  onChange={e => setViewDate({ ...viewDate, year: parseInt(e.target.value) })}
                  style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '6px 8px', color: '#e8f1f8', fontSize: '13px', cursor: 'pointer' }}
                >
                  {years.map(y => <option key={y} value={y} style={{ background: '#0f2744' }}>{y}</option>)}
                </select>
              </div>
              <button type="button" onClick={nextMonth} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', width: '32px', height: '32px', color: '#e8f1f8', cursor: 'pointer', fontSize: '16px' }}>â€º</button>
            </div>
            
            {/* Day Headers */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '2px', marginBottom: '4px' }}>
              {days.map(d => (
                <div key={d} style={{ textAlign: 'center', fontSize: '11px', color: '#64748b', padding: '4px', fontWeight: '600' }}>{d}</div>
              ))}
            </div>
            
            {/* Calendar Grid */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '2px' }}>
              {calendarDays.map((day, i) => (
                <div key={i}>
                  {day && (
                    <button
                      type="button"
                      onClick={() => !isDateDisabled(day) && handleSelect(day)}
                      disabled={isDateDisabled(day)}
                      style={{
                        width: '100%',
                        aspectRatio: '1',
                        border: 'none',
                        borderRadius: '8px',
                        background: isSelected(day) ? 'linear-gradient(135deg, #f59e0b, #d97706)' : isToday(day) ? 'rgba(59,130,246,0.3)' : 'transparent',
                        color: isSelected(day) ? '#0c1929' : isDateDisabled(day) ? '#4a5568' : '#e8f1f8',
                        cursor: isDateDisabled(day) ? 'not-allowed' : 'pointer',
                        fontSize: '13px',
                        fontWeight: isSelected(day) || isToday(day) ? '600' : '400',
                        transition: 'all 0.15s'
                      }}
                    >
                      {day}
                    </button>
                  )}
                </div>
              ))}
            </div>
            
            {/* Quick Actions */}
            <div style={{ display: 'flex', gap: '8px', marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(255,255,255,0.1)' }}>
              <button 
                type="button"
                onClick={() => { const t = new Date(); handleSelect(t.getDate()); setViewDate({ year: t.getFullYear(), month: t.getMonth() }); }}
                style={{ flex: 1, padding: '8px', background: 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '6px', color: '#3b82f6', fontSize: '11px', cursor: 'pointer' }}
              >
                BugÃ¼n
              </button>
              <button 
                type="button"
                onClick={() => { onChange(''); setIsOpen(false); }}
                style={{ flex: 1, padding: '8px', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '6px', color: '#ef4444', fontSize: '11px', cursor: 'pointer' }}
              >
                Temizle
              </button>
            </div>
          </div>
        </>
      )}
    </div>
  );
}

function BirthDateInput({ label, value, onChange }) {
  return <CalendarPicker label={label} value={value} onChange={onChange} minYear={1920} maxYear={new Date().getFullYear()} maxDate={new Date().toISOString().split('T')[0]} />;
}

function DateInput({ label, value, onChange }) {
  return <CalendarPicker label={label} value={value} onChange={onChange} minYear={2020} maxYear={2040} />;
}

function FormInput({ label, ...p }) { return (<div><label style={labelStyle}>{label}</label><input {...p} style={inputStyle} /></div>); }
function StatCard({ value, label, color }) { return (<div style={{ background: `${color}15`, border: `1px solid ${color}30`, borderRadius: '10px', padding: '14px' }}><div style={{ fontSize: '22px', fontWeight: '700', color }}>{value}</div><div style={{ fontSize: '11px', color: '#94a3b8', marginTop: '2px' }}>{label}</div></div>); }
function Modal({ children, onClose, title }) { return (<div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(5px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 300, padding: '20px' }}><div style={{ background: 'linear-gradient(180deg, #0f2744 0%, #0c1929 100%)', borderRadius: '12px', width: '100%', maxWidth: '400px', maxHeight: '85vh', overflow: 'auto', border: '1px solid rgba(255,255,255,0.1)' }}><div style={{ padding: '14px 16px', borderBottom: '1px solid rgba(255,255,255,0.1)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><h3 style={{ margin: 0, fontSize: '15px', flex: 1 }}>{title}</h3><button onClick={onClose} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', width: '28px', height: '28px', cursor: 'pointer', color: '#94a3b8', fontSize: '14px', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>âœ•</button></div><div style={{ padding: '14px 16px' }}>{children}</div></div></div>); }
function InfoBox({ label, value, highlight }) { return (<div style={{ background: highlight ? 'rgba(245,158,11,0.1)' : 'rgba(255,255,255,0.03)', borderRadius: '6px', padding: '8px', border: highlight ? '1px solid rgba(245,158,11,0.2)' : 'none' }}><p style={{ fontSize: '10px', color: highlight ? '#f59e0b' : '#64748b', marginBottom: '2px', textTransform: 'uppercase' }}>{label}</p><p style={{ fontSize: '12px', margin: 0, color: value ? (highlight ? '#f59e0b' : '#e8f1f8') : '#64748b' }}>{value || '-'}</p></div>); }

function LoginScreen({ onLogin, users }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleLogin = (e) => {
    e.preventDefault();
    setError('');
    if (!email) { setError('E-posta adresi gerekli'); return; }
    if (!password) { setError('Åifre gerekli'); return; }
    setLoading(true);
    const user = users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password);
    if (user) { onLogin(user); } else { setError('E-posta veya ÅŸifre hatalÄ±'); }
    setLoading(false);
  };

  return (
    <div style={{ position: 'fixed', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #0c1929 0%, #1a3a5c 50%, #0d2137 100%)', fontFamily: "'Segoe UI', sans-serif", padding: '20px' }}>
      <div style={{ background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '16px', padding: '40px', width: '100%', maxWidth: '380px' }}>
        <div style={{ textAlign: 'center', marginBottom: '30px' }}>
          <div style={{ fontSize: '48px', marginBottom: '12px' }}>âœˆï¸</div>
          <h1 style={{ margin: 0, fontSize: '24px', color: '#e8f1f8', fontWeight: '700' }}>Paydos Turizm</h1>
          <p style={{ margin: '8px 0 0', fontSize: '13px', color: '#94a3b8' }}>GiriÅŸ yapÄ±n</p>
        </div>
        <form onSubmit={handleLogin}>
          <div style={{ marginBottom: '16px' }}><label style={labelStyle}>E-posta Adresi</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="ornek@paydos.com" style={{ ...inputStyle, padding: '12px 14px', fontSize: '15px' }} /></div>
          <div style={{ marginBottom: '20px' }}><label style={labelStyle}>Åifre</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" style={{ ...inputStyle, padding: '12px 14px', fontSize: '15px' }} /></div>
          {error && <div style={{ background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '8px', padding: '10px', marginBottom: '16px', fontSize: '12px', color: '#ef4444', textAlign: 'center' }}>{error}</div>}
          <button type="submit" disabled={loading} style={{ width: '100%', padding: '14px', background: loading ? 'rgba(245,158,11,0.5)' : 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#0c1929', fontWeight: '700', fontSize: '15px', cursor: loading ? 'not-allowed' : 'pointer' }}>{loading ? 'GiriÅŸ yapÄ±lÄ±yor...' : 'ğŸ”“ GiriÅŸ Yap'}</button>
        </form>
      </div>
    </div>
  );
}

function DashboardModule({ customers, isMobile }) {
  // Schengen vizesi olanlar
  const withSchengen = customers.filter(c => {
    const visas = safeParseJSON(c.schengenVisas);
    return visas.some(v => v.country && v.endDate);
  });
  // USA vizesi olanlar
  const withUsa = customers.filter(c => {
    const visa = c.usaVisa ? (typeof c.usaVisa === 'string' ? JSON.parse(c.usaVisa || '{}') : c.usaVisa) : {};
    return visa.endDate;
  });
  // Pasaportu 6 ay iÃ§inde bitecekler
  const expiringPassports = customers.filter(c => {
    const pList = safeParseJSON(c.passports);
    return pList.some(p => {
      const days = getDaysLeft(p.expiryDate);
      return days !== null && days > 0 && days <= 180;
    });
  });
  // YeÅŸil Pasaportlu Olanlar
  const withGreenPassport = customers.filter(c => {
    const pList = safeParseJSON(c.passports);
    return pList.some(p => p.passportType === 'YeÅŸil Pasaport (Hususi)');
  });

  return (
    <div style={{ padding: isMobile ? '16px' : '24px' }}>
      <h2 style={{ fontSize: '20px', marginBottom: '20px' }}>ğŸ“Š Dashboard</h2>
      <div style={{ display: 'grid', gridTemplateColumns: isMobile ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)', gap: '12px', marginBottom: '24px' }}>
        <StatCard value={customers.length} label="Toplam MÃ¼ÅŸteri" color="#3b82f6" />
        <StatCard value={withSchengen.length} label="Schengen Vizeli" color="#10b981" />
        <StatCard value={withUsa.length} label="ABD Vizeli" color="#8b5cf6" />
        <StatCard value={expiringPassports.length} label="Pasaport UyarÄ±" color="#ef4444" />
        <StatCard value={withGreenPassport.length} label="YeÅŸil Pasaport" color="#059669" />
      </div>
    </div>
  );
}

function CustomerModule({ customers, setCustomers, isMobile, appSettings }) {
  const [activeTab, setActiveTab] = useState('search');
  const [showForm, setShowForm] = useState(false);
  const [showExcelModal, setShowExcelModal] = useState(false);
  const [editingCustomer, setEditingCustomer] = useState(null);
  const [selectedCustomer, setSelectedCustomer] = useState(null);
  const [formData, setFormData] = useState({});
  const [detailTab, setDetailTab] = useState('info');
  const [imagePreview, setImagePreview] = useState({ show: false, src: '', title: '' });
  const [showResults, setShowResults] = useState(false);
  const fileInputRef = useRef(null);

  // Arama filtreleri
  const [filters, setFilters] = useState({
    firstName: '', lastName: '', tcKimlik: '', phone: '', email: '',
    birthDate: '', birthPlace: '', city: '', tkMemberNo: '', sector: '', companyName: ''
  });

  // Pasaport state
  const [passports, setPassports] = useState([]);
  const emptyPassport = { id: '', nationality: 'TÃ¼rkiye', passportType: 'Bordo Pasaport (Umuma Mahsus)', passportNo: '', issueDate: '', expiryDate: '', image: '' };

  // Schengen state (5 adet)
  const [schengenVisas, setSchengenVisas] = useState([
    { id: 1, country: '', startDate: '', endDate: '', image: '' }
  ]);

  // USA state
  const [usaVisa, setUsaVisa] = useState({ startDate: '', endDate: '', image: '' });
  const [formTab, setFormTab] = useState('info');

  const emptyForm = { 
    firstName: '', lastName: '', tcKimlik: '', phone: '', email: '', 
    birthDate: '', birthPlace: '', city: '', tkMemberNo: '', 
    sector: '', companyName: '', notes: '', tags: [], activities: [],
    passports: [], schengenVisas: [], usaVisa: {}
  };

  // === YENÄ° HESAPLAMALAR ===
  
  // Pasaportu 6 ay iÃ§inde bitecek mÃ¼ÅŸteriler
  const expiringPassports = customers.filter(c => {
    const pList = safeParseJSON(c.passports);
    return pList.some(p => {
      const days = getDaysLeft(p.expiryDate);
      return days !== null && days > 0 && days <= 180;
    });
  });

  // BugÃ¼n doÄŸum gÃ¼nÃ¼ olanlar
  const todayBirthdays = customers.filter(c => {
    if (!c.birthDate) return false;
    const today = new Date();
    const birth = safeParseDate(c.birthDate);
    if (!birth) return false;
    return birth.getDate() === today.getDate() && birth.getMonth() === today.getMonth();
  });

  // Schengen vizesi olanlar
  const withSchengen = customers.filter(c => {
    const visas = safeParseJSON(c.schengenVisas);
    return visas.some(v => v.country && v.endDate);
  });

  // Schengen vizesi 3 ay iÃ§inde bitecekler
  const schengenExpiring = customers.filter(c => {
    const visas = safeParseJSON(c.schengenVisas);
    return visas.some(v => {
      if (!v.endDate) return false;
      const days = getDaysLeft(v.endDate);
      return days !== null && days > 0 && days <= 90;
    });
  });

  // USA vizesi olanlar
  const withUsa = customers.filter(c => {
    const visa = c.usaVisa ? (typeof c.usaVisa === 'string' ? JSON.parse(c.usaVisa || '{}') : c.usaVisa) : {};
    return visa.endDate;
  });

  // USA vizesi 1 ay iÃ§inde bitecekler
  const usaExpiring = customers.filter(c => {
    const visa = c.usaVisa ? (typeof c.usaVisa === 'string' ? JSON.parse(c.usaVisa || '{}') : c.usaVisa) : {};
    if (!visa.endDate) return false;
    const days = getDaysLeft(visa.endDate);
    return days !== null && days > 0 && days <= 30;
  });

  // YeÅŸil Pasaportlu Olanlar
  const withGreenPassport = customers.filter(c => {
    const pList = safeParseJSON(c.passports);
    return pList.some(p => p.passportType === 'YeÅŸil Pasaport (Hususi)');
  });

  // Filtreleme fonksiyonu
  const hasActiveFilter = Object.values(filters).some(v => v && v.trim() !== '');
  
  const filtered = customers.filter(c => {
    if (!hasActiveFilter) return false;
    
    const matchField = (field, value) => {
      if (!value || value.trim() === '') return true;
      const fieldVal = c[field] || '';
      return fieldVal.toLowerCase().includes(value.toLowerCase());
    };

    return matchField('firstName', filters.firstName) &&
           matchField('lastName', filters.lastName) &&
           matchField('tcKimlik', filters.tcKimlik) &&
           matchField('phone', filters.phone) &&
           matchField('email', filters.email) &&
           matchField('birthDate', filters.birthDate) &&
           matchField('birthPlace', filters.birthPlace) &&
           matchField('city', filters.city) &&
           matchField('tkMemberNo', filters.tkMemberNo) &&
           matchField('sector', filters.sector) &&
           matchField('companyName', filters.companyName);
  });

  const clearFilters = () => {
    setFilters({ firstName: '', lastName: '', tcKimlik: '', phone: '', email: '', birthDate: '', birthPlace: '', city: '', tkMemberNo: '', sector: '', companyName: '' });
    setShowResults(false);
  };

  const handleSearch = () => {
    if (hasActiveFilter) setShowResults(true);
  };

  // Excel Export
  const exportToExcel = (data, filename) => {
    const exportData = data.map(c => ({
      'Ad': c.firstName || '',
      'Soyad': c.lastName || '',
      'TC Kimlik': c.tcKimlik || '',
      'Telefon': c.phone || '',
      'E-posta': c.email || '',
      'DoÄŸum Tarihi': formatDate(c.birthDate),
      'DoÄŸum Yeri': c.birthPlace || '',
      'Ä°kametgah Ä°li': c.city || '',
      'TK Ãœyelik No': c.tkMemberNo || '',
      'SektÃ¶r': c.sector || '',
      'Firma': c.companyName || '',
      'Notlar': c.notes || ''
    }));
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'MÃ¼ÅŸteriler');
    XLSX.writeFile(wb, `${filename}.xlsx`);
  };

  // Excel Import
  const handleExcelImport = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (evt) => {
      try {
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws);
        
        const newCustomers = data.map(row => ({
          id: generateUniqueId(),
          firstName: row['Ad'] || row['ad'] || row['AD'] || '',
          lastName: row['Soyad'] || row['soyad'] || row['SOYAD'] || '',
          tcKimlik: String(row['TC Kimlik'] || row['TC'] || row['tc'] || ''),
          phone: String(row['Telefon'] || row['telefon'] || row['TEL'] || ''),
          email: row['E-posta'] || row['Email'] || row['email'] || '',
          birthDate: row['DoÄŸum Tarihi'] || '',
          birthPlace: row['DoÄŸum Yeri'] || '',
          city: row['Ä°kametgah Ä°li'] || row['Ä°l'] || row['Åehir'] || '',
          tkMemberNo: row['TK Ãœyelik No'] || row['TK No'] || '',
          sector: row['SektÃ¶r'] || '',
          companyName: row['Firma'] || row['Åirket'] || '',
          notes: row['Notlar'] || row['Not'] || '',
          createdAt: new Date().toISOString().split('T')[0],
          tags: [],
          activities: [],
          passports: [],
          schengenVisas: [],
          usaVisa: {}
        })).filter(c => c.firstName || c.lastName);

        if (newCustomers.length === 0) {
          alert('Excel dosyasÄ±nda geÃ§erli mÃ¼ÅŸteri bulunamadÄ±!');
          return;
        }

        setCustomers([...customers, ...newCustomers]);
        
        for (const c of newCustomers) {
          try { await supabase.from('customers').insert([toSnakeCase(c)]); } catch (err) { console.error(err); }
        }
        
        alert(`${newCustomers.length} mÃ¼ÅŸteri baÅŸarÄ±yla eklendi!`);
        setShowExcelModal(false);
      } catch (err) {
        console.error(err);
        alert('Excel dosyasÄ± okunamadÄ±!');
      }
    };
    reader.readAsBinaryString(file);
    e.target.value = '';
  };

  const resetForm = () => { 
    setFormData(emptyForm); 
    setEditingCustomer(null); 
    setFormTab('info');
    setPassports([{ ...emptyPassport, id: generateUniqueId() }]);
    setSchengenVisas([{ id: 1, country: '', startDate: '', endDate: '', image: '' }]);
    setUsaVisa({ startDate: '', endDate: '', image: '' });
  };
  
  const openNewForm = () => { 
    resetForm(); 
    setShowForm(true); 
  };
  
  const openEditForm = (customer) => { 
    setEditingCustomer(customer); 
    setFormData({ ...emptyForm, ...customer, tags: safeParseTags(customer.tags), activities: safeParseActivities(customer.activities) }); 
    // Pasaport bilgilerini yÃ¼kle
    const savedPassports = safeParseJSON(customer.passports);
    setPassports(savedPassports.length > 0 ? savedPassports : [{ ...emptyPassport, id: generateUniqueId() }]);
    // Schengen bilgilerini yÃ¼kle
    const savedSchengen = safeParseJSON(customer.schengenVisas).filter(v => v.country);
    setSchengenVisas(savedSchengen.length > 0 ? savedSchengen : [{ id: 1, country: '', startDate: '', endDate: '', image: '' }]);
    // USA bilgilerini yÃ¼kle
    const savedUsa = customer.usaVisa ? (typeof customer.usaVisa === 'string' ? JSON.parse(customer.usaVisa) : customer.usaVisa) : {};
    setUsaVisa({ startDate: savedUsa.startDate || '', endDate: savedUsa.endDate || '', image: savedUsa.image || '' });
    setFormTab('info');
    setShowForm(true); 
  };

  const openPassportModal = (customer) => {
    setSelectedCustomer(customer);
    const savedPassports = safeParseJSON(customer.passports);
    setPassports(savedPassports.length > 0 ? savedPassports : [{ ...emptyPassport, id: generateUniqueId() }]);
    setShowPassportModal(true);
  };

  const openSchengenModal = (customer) => {
    setSelectedCustomer(customer);
    const saved = safeParseJSON(customer.schengenVisas).filter(v => v.country);
    setSchengenVisas(saved.length > 0 ? saved : [{ id: 1, country: '', startDate: '', endDate: '', image: '' }]);
    setShowSchengenModal(true);
  };

  const openUsaModal = (customer) => {
    setSelectedCustomer(customer);
    const saved = customer.usaVisa ? (typeof customer.usaVisa === 'string' ? JSON.parse(customer.usaVisa) : customer.usaVisa) : {};
    setUsaVisa({ startDate: saved.startDate || '', endDate: saved.endDate || '', image: saved.image || '' });
    setShowUsaModal(true);
  };

  const addPassport = () => {
    setPassports([...passports, { ...emptyPassport, id: generateUniqueId() }]);
  };

  const removePassport = (id) => {
    if (passports.length <= 1) return;
    setPassports(passports.filter(p => p.id !== id));
  };

  const updatePassport = (id, field, value) => {
    setPassports(passports.map(p => p.id === id ? { ...p, [field]: value } : p));
  };

  const handleImageUpload = (callback) => (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 2 * 1024 * 1024) { alert('Dosya boyutu 2MB\'dan kÃ¼Ã§Ã¼k olmalÄ±'); return; }
      const reader = new FileReader();
      reader.onloadend = () => callback(reader.result);
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async () => {
    if (!formData.firstName || !formData.lastName || !formData.phone) {
      alert('Ad, Soyad ve Telefon alanlarÄ± zorunludur!');
      setFormTab('info');
      return;
    }
    
    const now = new Date().toISOString();
    const fullData = {
      ...formData,
      passports: passports,
      schengenVisas: schengenVisas,
      usaVisa: usaVisa
    };
    
    if (editingCustomer) {
      const updated = customers.map(c => c.id === editingCustomer.id ? { ...c, ...fullData } : c);
      setCustomers(updated);
      try { 
        await supabase.from('customers').update({
          ...toSnakeCase(formData),
          passports: JSON.stringify(passports),
          schengen_visas: JSON.stringify(schengenVisas),
          usa_visa: JSON.stringify(usaVisa)
        }).eq('id', editingCustomer.id); 
      } catch (err) { console.error(err); }
    } else {
      const newCustomer = { ...fullData, id: generateUniqueId(), createdAt: now.split('T')[0] };
      setCustomers([...customers, newCustomer]);
      try { 
        await supabase.from('customers').insert([{
          ...toSnakeCase({ ...formData, id: newCustomer.id, createdAt: newCustomer.createdAt }),
          passports: JSON.stringify(passports),
          schengen_visas: JSON.stringify(schengenVisas),
          usa_visa: JSON.stringify(usaVisa)
        }]); 
      } catch (err) { console.error(err); }
    }
    setShowForm(false);
    resetForm();
  };

  const handlePassportSubmit = async (e) => {
    e.preventDefault();
    if (!selectedCustomer) return;
    const dataToSave = { passports: JSON.stringify(passports) };
    const updatedCustomer = { ...selectedCustomer, passports };
    const updated = customers.map(c => c.id === selectedCustomer.id ? updatedCustomer : c);
    setCustomers(updated);
    setSelectedCustomer(updatedCustomer);
    try { await supabase.from('customers').update(dataToSave).eq('id', selectedCustomer.id); } catch (err) { console.error(err); }
    setShowPassportModal(false);
  };

  const handleSchengenSubmit = async (e) => {
    e.preventDefault();
    if (!selectedCustomer) return;
    const dataToSave = { schengen_visas: JSON.stringify(schengenVisas) };
    const updatedCustomer = { ...selectedCustomer, schengenVisas };
    const updated = customers.map(c => c.id === selectedCustomer.id ? updatedCustomer : c);
    setCustomers(updated);
    setSelectedCustomer(updatedCustomer);
    try { await supabase.from('customers').update(dataToSave).eq('id', selectedCustomer.id); } catch (err) { console.error(err); }
    setShowSchengenModal(false);
  };

  const handleUsaSubmit = async (e) => {
    e.preventDefault();
    if (!selectedCustomer) return;
    const dataToSave = { usa_visa: JSON.stringify(usaVisa) };
    const updatedCustomer = { ...selectedCustomer, usaVisa };
    const updated = customers.map(c => c.id === selectedCustomer.id ? updatedCustomer : c);
    setCustomers(updated);
    setSelectedCustomer(updatedCustomer);
    try { await supabase.from('customers').update(dataToSave).eq('id', selectedCustomer.id); } catch (err) { console.error(err); }
    setShowUsaModal(false);
  };

  const deleteCustomer = async (id) => {
    if (!confirm('Silmek istediÄŸinize emin misiniz?')) return;
    setCustomers(customers.filter(c => c.id !== id));
    try { await supabase.from('customers').delete().eq('id', id); } catch (err) { console.error(err); }
    if (selectedCustomer?.id === id) setSelectedCustomer(null);
  };

  const mainTabStyle = (active) => ({
    flex: 1, padding: '10px 8px', background: active ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.05)',
    border: active ? '1px solid rgba(245,158,11,0.3)' : '1px solid rgba(255,255,255,0.1)',
    borderRadius: '8px', color: active ? '#f59e0b' : '#94a3b8', cursor: 'pointer', fontSize: '11px', fontWeight: active ? '600' : '400',
    display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px'
  });

  const tabStyle = (active) => ({
    flex: 1, padding: '8px', background: active ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.05)',
    border: active ? '1px solid rgba(245,158,11,0.3)' : '1px solid rgba(255,255,255,0.1)',
    borderRadius: '8px', color: active ? '#f59e0b' : '#94a3b8', cursor: 'pointer', fontSize: '11px', fontWeight: active ? '600' : '400'
  });

  const ImageUploadBox = ({ label, value, onUpload, onClear, small }) => (
    <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '6px', padding: small ? '8px' : '10px', border: '1px solid rgba(255,255,255,0.1)' }}>
      {value ? (
        <div style={{ position: 'relative' }}>
          <img src={value} alt={label} style={{ width: '100%', height: small ? '50px' : '70px', objectFit: 'cover', borderRadius: '4px', cursor: 'pointer' }} onClick={() => setImagePreview({ show: true, src: value, title: label })} />
          <button type="button" onClick={onClear} style={{ position: 'absolute', top: '2px', right: '2px', background: 'rgba(239,68,68,0.9)', border: 'none', borderRadius: '50%', width: '18px', height: '18px', color: 'white', cursor: 'pointer', fontSize: '10px' }}>âœ•</button>
        </div>
      ) : (
        <label style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: small ? '50px' : '60px', border: '1px dashed rgba(255,255,255,0.2)', borderRadius: '4px', cursor: 'pointer', color: '#64748b', fontSize: '10px' }}>
          ğŸ“· {label}
          <input type="file" accept="image/*" onChange={onUpload} style={{ display: 'none' }} />
        </label>
      )}
    </div>
  );

  // TAM SAYFA FORM - MÃ¼ÅŸteri Ekleme/DÃ¼zenleme
  const renderFullPageForm = () => (
    <div style={{ position: 'fixed', inset: 0, background: 'linear-gradient(180deg, #0a1628 0%, #132742 50%, #0a1628 100%)', zIndex: 300, overflow: 'auto' }}>
      {/* Header */}
      <div style={{ position: 'sticky', top: 0, background: 'linear-gradient(180deg, rgba(10,22,40,0.98) 0%, rgba(10,22,40,0.95) 100%)', backdropFilter: 'blur(20px)', borderBottom: '1px solid rgba(255,255,255,0.08)', padding: '16px 20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', zIndex: 10 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
          <button onClick={() => { setShowForm(false); resetForm(); }} style={{ background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', padding: '10px 16px', color: '#e8f1f8', cursor: 'pointer', fontSize: '14px', display: 'flex', alignItems: 'center', gap: '6px', transition: 'all 0.2s' }}>
            <span>â†</span> Geri
          </button>
          <div>
            <h2 style={{ margin: 0, fontSize: '18px', color: '#ffffff', fontWeight: '600' }}>{editingCustomer ? 'MÃ¼ÅŸteri DÃ¼zenle' : 'Yeni MÃ¼ÅŸteri'}</h2>
            <p style={{ margin: '2px 0 0', fontSize: '12px', color: '#64748b' }}>{editingCustomer ? 'Bilgileri gÃ¼ncelleyin' : 'MÃ¼ÅŸteri bilgilerini girin'}</p>
          </div>
        </div>
      </div>

      {/* Progress Steps */}
      <div style={{ padding: '20px 20px 0' }}>
        <div style={{ display: 'flex', gap: '8px', background: 'rgba(0,0,0,0.2)', padding: '6px', borderRadius: '16px' }}>
          {[
            { id: 'info', icon: 'ğŸ‘¤', label: 'KiÅŸisel', color: '#f59e0b' },
            { id: 'passport', icon: 'ğŸ›‚', label: 'Pasaport', color: '#3b82f6' },
            { id: 'schengen', icon: 'ğŸ‡ªğŸ‡º', label: 'Schengen', color: '#10b981' },
            { id: 'usa', icon: 'ğŸ‡ºğŸ‡¸', label: 'ABD', color: '#8b5cf6' }
          ].map((tab, idx) => (
            <button 
              key={tab.id}
              onClick={() => setFormTab(tab.id)} 
              style={{ 
                flex: 1, 
                padding: '14px 8px', 
                background: formTab === tab.id ? `linear-gradient(135deg, ${tab.color}20, ${tab.color}10)` : 'transparent',
                border: formTab === tab.id ? `1px solid ${tab.color}40` : '1px solid transparent',
                borderRadius: '12px', 
                color: formTab === tab.id ? tab.color : '#64748b', 
                cursor: 'pointer', 
                fontSize: '12px', 
                fontWeight: formTab === tab.id ? '600' : '500',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '4px',
                transition: 'all 0.2s'
              }}
            >
              <span style={{ fontSize: '20px' }}>{tab.icon}</span>
              <span>{tab.label}</span>
              {formTab === tab.id && <div style={{ width: '20px', height: '3px', background: tab.color, borderRadius: '2px', marginTop: '2px' }} />}
            </button>
          ))}
        </div>
      </div>

      {/* Form Content */}
      <div style={{ padding: '20px', paddingBottom: '120px' }}>
        {/* KÄ°ÅÄ°SEL BÄ°LGÄ°LER */}
        {formTab === 'info' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
            {/* Temel Bilgiler Card */}
            <div style={{ background: 'linear-gradient(135deg, rgba(245,158,11,0.08) 0%, rgba(245,158,11,0.02) 100%)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(245,158,11,0.15)' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' }}>
                <div style={{ width: '36px', height: '36px', borderRadius: '10px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px' }}>ğŸ‘¤</div>
                <div>
                  <h3 style={{ margin: 0, fontSize: '15px', color: '#ffffff', fontWeight: '600' }}>Temel Bilgiler</h3>
                  <p style={{ margin: 0, fontSize: '11px', color: '#94a3b8' }}>Ad, soyad ve iletiÅŸim bilgileri</p>
                </div>
              </div>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                  <FormInput label="Ad *" value={formData.firstName || ''} onChange={e => setFormData({...formData, firstName: e.target.value})} placeholder="AdÄ± girin" />
                  <FormInput label="Soyad *" value={formData.lastName || ''} onChange={e => setFormData({...formData, lastName: e.target.value})} placeholder="SoyadÄ± girin" />
                </div>
                <FormInput label="TC Kimlik No" value={formData.tcKimlik || ''} onChange={e => setFormData({...formData, tcKimlik: e.target.value})} maxLength="11" placeholder="11 haneli TC kimlik numarasÄ±" />
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                  <div>
                    <label style={labelStyle}>Telefon *</label>
                    <input 
                      type="tel" 
                      value={formData.phone || '+90 5'} 
                      onChange={e => setFormData({...formData, phone: formatPhoneNumber(e.target.value)})} 
                      placeholder="+90 5XX XXX XX XX"
                      style={inputStyle}
                    />
                  </div>
                  <FormInput label="E-posta" type="email" value={formData.email || ''} onChange={e => setFormData({...formData, email: e.target.value})} placeholder="ornek@email.com" />
                </div>
              </div>
            </div>

            {/* KiÅŸisel Detaylar Card - Dinamik */}
            <div style={{ background: 'linear-gradient(135deg, rgba(59,130,246,0.08) 0%, rgba(59,130,246,0.02) 100%)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(59,130,246,0.15)' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' }}>
                <div style={{ width: '36px', height: '36px', borderRadius: '10px', background: 'linear-gradient(135deg, #3b82f6, #2563eb)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px' }}>ğŸ“</div>
                <div>
                  <h3 style={{ margin: 0, fontSize: '15px', color: '#ffffff', fontWeight: '600' }}>KiÅŸisel Detaylar</h3>
                  <p style={{ margin: 0, fontSize: '11px', color: '#94a3b8' }}>DoÄŸum ve ikamet bilgileri</p>
                </div>
              </div>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {/* Dinamik alanlarÄ± gÃ¶ster */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                  {(appSettings?.personalDetailsFields || ['DoÄŸum Tarihi', 'DoÄŸum Yeri', 'Ä°kametgah Ä°li', 'TK Ãœyelik No']).map((field, idx) => {
                    if (field === 'DoÄŸum Tarihi') {
                      return <BirthDateInput key={idx} label="DoÄŸum Tarihi" value={formData.birthDate || ''} onChange={v => setFormData({...formData, birthDate: v})} />;
                    } else if (field === 'Ä°kametgah Ä°li') {
                      return (
                        <div key={idx}>
                          <label style={labelStyle}>Ä°kametgah Ä°li</label>
                          <select value={formData.city || ''} onChange={e => setFormData({...formData, city: e.target.value})} style={selectStyle}>
                            <option value="">Ä°l seÃ§in</option>
                            {turkishProvinces.map(p => <option key={p} value={p}>{p}</option>)}
                          </select>
                        </div>
                      );
                    } else {
                      // DiÄŸer alanlar iÃ§in generic input - field ismini key olarak kullan
                      const fieldKey = field.toLowerCase().replace(/\s+/g, '_').replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's').replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c');
                      return <FormInput key={idx} label={field} value={formData[fieldKey] || ''} onChange={e => setFormData({...formData, [fieldKey]: e.target.value})} placeholder={field} />;
                    }
                  })}
                </div>
              </div>
            </div>

            {/* Ä°ÅŸ Bilgileri Card */}
            <div style={{ background: 'linear-gradient(135deg, rgba(16,185,129,0.08) 0%, rgba(16,185,129,0.02) 100%)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(16,185,129,0.15)' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' }}>
                <div style={{ width: '36px', height: '36px', borderRadius: '10px', background: 'linear-gradient(135deg, #10b981, #059669)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px' }}>ğŸ’¼</div>
                <div>
                  <h3 style={{ margin: 0, fontSize: '15px', color: '#ffffff', fontWeight: '600' }}>Ä°ÅŸ Bilgileri</h3>
                  <p style={{ margin: 0, fontSize: '11px', color: '#94a3b8' }}>Meslek ve firma bilgileri</p>
                </div>
              </div>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                  <div>
                    <label style={labelStyle}>SektÃ¶r</label>
                    <select value={formData.sector || ''} onChange={e => setFormData({...formData, sector: e.target.value})} style={selectStyle}>
                      <option value="">SektÃ¶r seÃ§in</option>
                      {sectors.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                  </div>
                  <FormInput label="Firma" value={formData.companyName || ''} onChange={e => setFormData({...formData, companyName: e.target.value})} placeholder="Firma adÄ±" />
                </div>
                <div>
                  <label style={labelStyle}>Notlar</label>
                  <textarea value={formData.notes || ''} onChange={e => setFormData({...formData, notes: e.target.value})} placeholder="MÃ¼ÅŸteri hakkÄ±nda notlar..." style={{ ...inputStyle, minHeight: '100px', resize: 'vertical' }} />
                </div>
              </div>
            </div>
          </div>
        )}

        {/* PASAPORT BÄ°LGÄ°LERÄ° */}
        {formTab === 'passport' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
            <div style={{ background: 'rgba(59,130,246,0.1)', borderRadius: '12px', padding: '12px 16px', border: '1px solid rgba(59,130,246,0.2)', display: 'flex', alignItems: 'center', gap: '10px' }}>
              <span style={{ fontSize: '20px' }}>ğŸ’¡</span>
              <p style={{ margin: 0, fontSize: '12px', color: '#94a3b8' }}>MÃ¼ÅŸterinin birden fazla pasaportu varsa hepsini ekleyebilirsiniz.</p>
            </div>
            
            {passports.map((passport, idx) => (
              <div key={passport.id} style={{ background: 'linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(59,130,246,0.03) 100%)', padding: '16px', borderRadius: '16px', border: '1px solid rgba(59,130,246,0.2)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <div style={{ width: '28px', height: '28px', borderRadius: '8px', background: 'linear-gradient(135deg, #3b82f6, #2563eb)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', color: 'white', fontWeight: '700' }}>{idx + 1}</div>
                    <h4 style={{ margin: 0, fontSize: '13px', color: '#3b82f6', fontWeight: '600' }}>Pasaport #{idx + 1}</h4>
                  </div>
                  {passports.length > 1 && (
                    <button type="button" onClick={() => removePassport(passport.id)} style={{ background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '6px', padding: '6px 10px', color: '#ef4444', fontSize: '11px', cursor: 'pointer' }}>ğŸ—‘ï¸</button>
                  )}
                </div>
                {/* Yatay dÃ¼zen: Sol form, saÄŸ gÃ¶rsel */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 160px', gap: '16px', alignItems: 'start' }}>
                  {/* Sol: Form alanlarÄ± */}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                      <FormInput label="Uyruk" value={passport.nationality || 'TÃ¼rkiye'} onChange={e => updatePassport(passport.id, 'nationality', e.target.value)} />
                      <div>
                        <label style={labelStyle}>Pasaport TÃ¼rÃ¼</label>
                        <select value={passport.passportType || ''} onChange={e => updatePassport(passport.id, 'passportType', e.target.value)} style={{ ...selectStyle, padding: '8px 10px', fontSize: '13px' }}>
                          {passportTypes.map(t => <option key={t} value={t}>{t}</option>)}
                        </select>
                      </div>
                    </div>
                    <div>
                      <label style={labelStyle}>Pasaport No (9 hane, ilk karakter harf)</label>
                      <input 
                        type="text" 
                        value={passport.passportNo || ''} 
                        onChange={e => updatePassport(passport.id, 'passportNo', formatPassportNo(e.target.value))}
                        placeholder="U12345678"
                        maxLength="9"
                        style={{ ...inputStyle, textTransform: 'uppercase', letterSpacing: '2px', fontFamily: 'monospace' }}
                      />
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                      <DateInput label="VeriliÅŸ" value={passport.issueDate || ''} onChange={v => updatePassport(passport.id, 'issueDate', v)} />
                      <DateInput label="GeÃ§erlilik" value={passport.expiryDate || ''} onChange={v => updatePassport(passport.id, 'expiryDate', v)} />
                    </div>
                  </div>
                  {/* SaÄŸ: GÃ¶rsel - TÄ±kla BÃ¼yÃ¼t */}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                    <label style={{ fontSize: '11px', color: '#94a3b8' }}>Pasaport GÃ¶rseli</label>
                    {passport.image ? (
                      <div style={{ position: 'relative' }}>
                        <img 
                          src={passport.image} 
                          alt="Pasaport" 
                          onClick={() => setImagePreview({ show: true, src: passport.image, title: `Pasaport #${idx + 1} - ${passport.passportNo || 'GÃ¶rsel'}` })}
                          style={{ width: '100%', height: '140px', objectFit: 'cover', borderRadius: '10px', border: '2px solid rgba(59,130,246,0.3)', cursor: 'zoom-in' }} 
                        />
                        <div style={{ position: 'absolute', bottom: '6px', left: '6px', background: 'rgba(0,0,0,0.7)', padding: '4px 8px', borderRadius: '6px', fontSize: '10px', color: 'white' }}>ğŸ” BÃ¼yÃ¼tmek iÃ§in tÄ±kla</div>
                        <button type="button" onClick={(e) => { e.stopPropagation(); updatePassport(passport.id, 'image', ''); }} style={{ position: 'absolute', top: '6px', right: '6px', background: 'rgba(239,68,68,0.9)', border: 'none', borderRadius: '50%', width: '24px', height: '24px', color: 'white', cursor: 'pointer', fontSize: '12px' }}>Ã—</button>
                      </div>
                    ) : (
                      <label style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '140px', background: 'rgba(59,130,246,0.1)', border: '2px dashed rgba(59,130,246,0.3)', borderRadius: '10px', cursor: 'pointer' }}>
                        <span style={{ fontSize: '32px', marginBottom: '6px' }}>ğŸ“·</span>
                        <span style={{ fontSize: '11px', color: '#3b82f6', fontWeight: '500' }}>Pasaport YÃ¼kle</span>
                        <input type="file" accept="image/*" onChange={handleImageUpload((img) => updatePassport(passport.id, 'image', img))} style={{ display: 'none' }} />
                      </label>
                    )}
                  </div>
                </div>
              </div>
            ))}
            
            <button type="button" onClick={addPassport} style={{ width: '100%', padding: '14px', background: 'transparent', border: '2px dashed rgba(59,130,246,0.4)', borderRadius: '12px', color: '#3b82f6', fontSize: '13px', cursor: 'pointer', fontWeight: '500', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              <span style={{ fontSize: '18px' }}>+</span> Pasaport Ekle
            </button>
          </div>
        )}

        {/* SCHENGEN VÄ°ZESÄ° */}
        {formTab === 'schengen' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
            <div style={{ background: 'rgba(16,185,129,0.1)', borderRadius: '12px', padding: '12px 16px', border: '1px solid rgba(16,185,129,0.2)', display: 'flex', alignItems: 'center', gap: '10px' }}>
              <span style={{ fontSize: '20px' }}>ğŸ‡ªğŸ‡º</span>
              <p style={{ margin: 0, fontSize: '12px', color: '#94a3b8' }}>Mevcut veya geÃ§miÅŸ Schengen vizelerini ekleyebilirsiniz.</p>
            </div>
            
            {schengenVisas.map((visa, idx) => (
              <div key={visa.id} style={{ background: 'linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.03) 100%)', padding: '16px', borderRadius: '14px', border: '1px solid rgba(16,185,129,0.2)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <div style={{ width: '28px', height: '28px', borderRadius: '8px', background: 'linear-gradient(135deg, #10b981, #059669)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', color: 'white', fontWeight: '700' }}>{idx + 1}</div>
                    <span style={{ fontSize: '13px', color: '#10b981', fontWeight: '600' }}>Schengen Vizesi #{idx + 1}</span>
                  </div>
                  {schengenVisas.length > 1 && (
                    <button type="button" onClick={() => setSchengenVisas(schengenVisas.filter(v => v.id !== visa.id))} style={{ background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '6px', padding: '6px 10px', color: '#ef4444', fontSize: '11px', cursor: 'pointer' }}>ğŸ—‘ï¸</button>
                  )}
                </div>
                {/* Yatay dÃ¼zen: Sol form, saÄŸ gÃ¶rsel - BÃœYÃœK */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 140px', gap: '16px', alignItems: 'start' }}>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    <div>
                      <label style={labelStyle}>VerildiÄŸi Ãœlke</label>
                      <select value={visa.country || ''} onChange={e => setSchengenVisas(schengenVisas.map(v => v.id === visa.id ? {...v, country: e.target.value} : v))} style={selectStyle}>
                        <option value="">Ãœlke seÃ§in</option>
                        {schengenCountries.map(c => <option key={c} value={c}>{c}</option>)}
                      </select>
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                      <DateInput label="BaÅŸlangÄ±Ã§" value={visa.startDate || ''} onChange={v => setSchengenVisas(schengenVisas.map(vs => vs.id === visa.id ? {...vs, startDate: v} : vs))} />
                      <DateInput label="BitiÅŸ" value={visa.endDate || ''} onChange={v => setSchengenVisas(schengenVisas.map(vs => vs.id === visa.id ? {...vs, endDate: v} : vs))} />
                    </div>
                  </div>
                  {/* SaÄŸ: GÃ¶rsel - TÄ±kla BÃ¼yÃ¼t */}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                    <label style={{ fontSize: '11px', color: '#94a3b8' }}>Vize GÃ¶rseli</label>
                    {visa.image ? (
                      <div style={{ position: 'relative' }}>
                        <img 
                          src={visa.image} 
                          alt="Vize" 
                          onClick={() => setImagePreview({ show: true, src: visa.image, title: `Schengen Vizesi #${idx + 1} - ${visa.country || 'GÃ¶rsel'}` })}
                          style={{ width: '100%', height: '120px', objectFit: 'cover', borderRadius: '10px', border: '2px solid rgba(16,185,129,0.3)', cursor: 'zoom-in' }} 
                        />
                        <div style={{ position: 'absolute', bottom: '6px', left: '6px', background: 'rgba(0,0,0,0.7)', padding: '4px 8px', borderRadius: '6px', fontSize: '10px', color: 'white' }}>ğŸ” BÃ¼yÃ¼t</div>
                        <button type="button" onClick={(e) => { e.stopPropagation(); setSchengenVisas(schengenVisas.map(v => v.id === visa.id ? {...v, image: ''} : v)); }} style={{ position: 'absolute', top: '6px', right: '6px', background: 'rgba(239,68,68,0.9)', border: 'none', borderRadius: '50%', width: '24px', height: '24px', color: 'white', cursor: 'pointer', fontSize: '12px' }}>Ã—</button>
                      </div>
                    ) : (
                      <label style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '120px', background: 'rgba(16,185,129,0.1)', border: '2px dashed rgba(16,185,129,0.3)', borderRadius: '10px', cursor: 'pointer' }}>
                        <span style={{ fontSize: '28px', marginBottom: '6px' }}>ğŸ“·</span>
                        <span style={{ fontSize: '11px', color: '#10b981', fontWeight: '500' }}>Vize YÃ¼kle</span>
                        <input type="file" accept="image/*" onChange={handleImageUpload((img) => setSchengenVisas(schengenVisas.map(v => v.id === visa.id ? {...v, image: img} : v)))} style={{ display: 'none' }} />
                      </label>
                    )}
                  </div>
                </div>
              </div>
            ))}

            {/* Vize Ekle Butonu - SÄ±nÄ±rsÄ±z */}
            <button type="button" onClick={() => setSchengenVisas([...schengenVisas, { id: Date.now(), country: '', startDate: '', endDate: '', image: '' }])} style={{ width: '100%', padding: '14px', background: 'transparent', border: '2px dashed rgba(16,185,129,0.4)', borderRadius: '12px', color: '#10b981', fontSize: '13px', cursor: 'pointer', fontWeight: '500', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              <span style={{ fontSize: '18px' }}>+</span> Schengen Vizesi Ekle
            </button>
          </div>
        )}

        {/* ABD VÄ°ZESÄ° */}
        {formTab === 'usa' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
            <div style={{ background: 'linear-gradient(135deg, rgba(139,92,246,0.12) 0%, rgba(139,92,246,0.04) 100%)', padding: '16px', borderRadius: '14px', border: '1px solid rgba(139,92,246,0.25)' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '14px' }}>
                <div style={{ width: '36px', height: '36px', borderRadius: '10px', background: 'linear-gradient(135deg, #8b5cf6, #7c3aed)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px' }}>ğŸ‡ºğŸ‡¸</div>
                <div>
                  <h3 style={{ margin: 0, fontSize: '14px', color: '#ffffff', fontWeight: '600' }}>Amerika Vizesi</h3>
                  <p style={{ margin: 0, fontSize: '11px', color: '#94a3b8' }}>ABD vize bilgilerini girin</p>
                </div>
              </div>
              {/* Yatay dÃ¼zen: Sol form, saÄŸ gÃ¶rsel */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 160px', gap: '16px', alignItems: 'start' }}>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                    <DateInput label="Vize BaÅŸlangÄ±Ã§" value={usaVisa.startDate || ''} onChange={v => setUsaVisa({...usaVisa, startDate: v})} />
                    <DateInput label="Vize BitiÅŸ" value={usaVisa.endDate || ''} onChange={v => setUsaVisa({...usaVisa, endDate: v})} />
                  </div>
                </div>
                {/* SaÄŸ: GÃ¶rsel - TÄ±kla BÃ¼yÃ¼t */}
                <div>
                  <label style={{ fontSize: '11px', color: '#94a3b8', display: 'block', marginBottom: '6px' }}>Vize GÃ¶rseli</label>
                  {usaVisa.image ? (
                    <div style={{ position: 'relative' }}>
                      <img 
                        src={usaVisa.image} 
                        alt="ABD Vizesi" 
                        onClick={() => setImagePreview({ show: true, src: usaVisa.image, title: 'ABD Vizesi' })}
                        style={{ width: '100%', height: '120px', objectFit: 'cover', borderRadius: '10px', border: '2px solid rgba(139,92,246,0.3)', cursor: 'zoom-in' }} 
                      />
                      <div style={{ position: 'absolute', bottom: '6px', left: '6px', background: 'rgba(0,0,0,0.7)', padding: '4px 8px', borderRadius: '6px', fontSize: '10px', color: 'white' }}>ğŸ” BÃ¼yÃ¼t</div>
                      <button type="button" onClick={(e) => { e.stopPropagation(); setUsaVisa({...usaVisa, image: ''}); }} style={{ position: 'absolute', top: '6px', right: '6px', background: 'rgba(239,68,68,0.9)', border: 'none', borderRadius: '50%', width: '24px', height: '24px', color: 'white', cursor: 'pointer', fontSize: '12px' }}>Ã—</button>
                    </div>
                  ) : (
                    <label style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '120px', background: 'rgba(139,92,246,0.1)', border: '2px dashed rgba(139,92,246,0.3)', borderRadius: '10px', cursor: 'pointer' }}>
                      <span style={{ fontSize: '28px', marginBottom: '6px' }}>ğŸ“·</span>
                      <span style={{ fontSize: '11px', color: '#8b5cf6', fontWeight: '500' }}>Vize YÃ¼kle</span>
                      <input type="file" accept="image/*" onChange={handleImageUpload((img) => setUsaVisa({...usaVisa, image: img}))} style={{ display: 'none' }} />
                    </label>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Bottom Save Button */}
      <div style={{ position: 'fixed', bottom: 0, left: 0, right: 0, background: 'linear-gradient(180deg, rgba(10,22,40,0) 0%, rgba(10,22,40,0.95) 20%, rgba(10,22,40,1) 100%)', padding: '20px', paddingTop: '40px' }}>
        <button onClick={handleSubmit} style={{ width: '100%', padding: '16px', background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', border: 'none', borderRadius: '14px', color: '#0c1929', fontWeight: '700', fontSize: '16px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', boxShadow: '0 4px 20px rgba(245,158,11,0.3)' }}>
          <span>ğŸ’¾</span> {editingCustomer ? 'DeÄŸiÅŸiklikleri Kaydet' : 'MÃ¼ÅŸteriyi Kaydet'}
        </button>
      </div>
    </div>
  );

  // TAM SAYFA DETAY - MÃ¼ÅŸteri GÃ¶rÃ¼ntÃ¼leme
  const renderFullPageDetail = () => {
    if (!selectedCustomer) return null;
    const c = selectedCustomer;
    const cPassports = safeParseJSON(c.passports);
    const cSchengen = safeParseJSON(c.schengenVisas).filter(v => v.country);
    const cUsa = c.usaVisa ? (typeof c.usaVisa === 'string' ? JSON.parse(c.usaVisa || '{}') : c.usaVisa) : {};
    const hasGreenPassport = cPassports.some(p => p.passportType === 'YeÅŸil Pasaport (Hususi)');

    return (
      <div style={{ position: 'fixed', inset: 0, background: 'linear-gradient(180deg, #0a1628 0%, #132742 50%, #0a1628 100%)', zIndex: 300, overflow: 'auto' }}>
        {/* Header */}
        <div style={{ position: 'sticky', top: 0, background: 'linear-gradient(180deg, rgba(10,22,40,0.98) 0%, rgba(10,22,40,0.95) 100%)', backdropFilter: 'blur(20px)', borderBottom: '1px solid rgba(255,255,255,0.08)', padding: '16px 20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', zIndex: 10 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
            <button onClick={() => { setSelectedCustomer(null); setDetailTab('info'); }} style={{ background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', padding: '10px 16px', color: '#e8f1f8', cursor: 'pointer', fontSize: '14px' }}>â† Geri</button>
            <div>
              <h2 style={{ margin: 0, fontSize: '18px', color: '#ffffff', fontWeight: '600' }}>{c.firstName} {c.lastName}</h2>
              <p style={{ margin: '2px 0 0', fontSize: '12px', color: '#64748b' }}>{c.phone}</p>
            </div>
          </div>
          <button onClick={() => { setSelectedCustomer(null); openEditForm(c); }} style={{ background: 'linear-gradient(135deg, #3b82f6, #2563eb)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>âœï¸ DÃ¼zenle</button>
        </div>

        {/* Tab Navigation */}
        <div style={{ padding: '20px 20px 0' }}>
          <div style={{ display: 'flex', gap: '8px', background: 'rgba(0,0,0,0.2)', padding: '6px', borderRadius: '16px' }}>
            {[
              { id: 'info', icon: 'ğŸ“‹', label: 'Bilgiler', color: '#f59e0b' },
              { id: 'passport', icon: 'ğŸ›‚', label: 'Pasaport', color: '#3b82f6', count: cPassports.length },
              { id: 'schengen', icon: 'ğŸ‡ªğŸ‡º', label: hasGreenPassport ? 'Muaf âœ“' : 'Schengen', color: '#10b981', count: hasGreenPassport ? null : cSchengen.length },
              { id: 'usa', icon: 'ğŸ‡ºğŸ‡¸', label: 'ABD', color: '#8b5cf6', count: cUsa.endDate ? 1 : 0 }
            ].map((tab) => (
              <button 
                key={tab.id}
                onClick={() => setDetailTab(tab.id)} 
                style={{ 
                  flex: 1, 
                  padding: '12px 8px', 
                  background: detailTab === tab.id ? `linear-gradient(135deg, ${tab.color}20, ${tab.color}10)` : 'transparent',
                  border: detailTab === tab.id ? `1px solid ${tab.color}40` : '1px solid transparent',
                  borderRadius: '12px', 
                  color: detailTab === tab.id ? tab.color : '#64748b', 
                  cursor: 'pointer', 
                  fontSize: '12px', 
                  fontWeight: detailTab === tab.id ? '600' : '500',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <span style={{ fontSize: '18px' }}>{tab.icon}</span>
                <span>{tab.label} {tab.count !== undefined && `(${tab.count})`}</span>
              </button>
            ))}
          </div>
        </div>

        {/* Content */}
        <div style={{ padding: '20px', paddingBottom: '100px' }}>
          {/* KÄ°ÅÄ°SEL BÄ°LGÄ°LER */}
          {detailTab === 'info' && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              {/* Ä°letiÅŸim */}
              <div style={{ background: 'linear-gradient(135deg, rgba(245,158,11,0.08) 0%, rgba(245,158,11,0.02) 100%)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(245,158,11,0.15)' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' }}>
                  <div style={{ width: '36px', height: '36px', borderRadius: '10px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px' }}>ğŸ“</div>
                  <h3 style={{ margin: 0, fontSize: '15px', color: '#ffffff', fontWeight: '600' }}>Ä°letiÅŸim Bilgileri</h3>
                </div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                    <a href={`https://wa.me/90${c.phone?.replace(/\D/g, '').replace(/^0/, '')}`} target="_blank" rel="noopener noreferrer" style={{ background: 'rgba(37,211,102,0.15)', padding: '12px', borderRadius: '10px', textDecoration: 'none', display: 'flex', alignItems: 'center', gap: '10px', border: '1px solid rgba(37,211,102,0.3)' }}>
                      <span style={{ fontSize: '20px' }}>ğŸ“±</span>
                      <div>
                        <p style={{ margin: 0, fontSize: '10px', color: '#94a3b8' }}>WhatsApp</p>
                        <p style={{ margin: 0, fontSize: '13px', color: '#25d366', fontWeight: '600' }}>{c.phone || '-'}</p>
                      </div>
                    </a>
                    {c.email ? (
                      <a href={`mailto:${c.email}`} style={{ background: 'rgba(59,130,246,0.15)', padding: '12px', borderRadius: '10px', textDecoration: 'none', display: 'flex', alignItems: 'center', gap: '10px', border: '1px solid rgba(59,130,246,0.3)' }}>
                        <span style={{ fontSize: '20px' }}>âœ‰ï¸</span>
                        <div>
                          <p style={{ margin: 0, fontSize: '10px', color: '#94a3b8' }}>E-posta</p>
                          <p style={{ margin: 0, fontSize: '13px', color: '#3b82f6', fontWeight: '600' }}>{c.email}</p>
                        </div>
                      </a>
                    ) : (
                      <div style={{ background: 'rgba(255,255,255,0.05)', padding: '12px', borderRadius: '10px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <span style={{ fontSize: '20px' }}>âœ‰ï¸</span>
                        <div>
                          <p style={{ margin: 0, fontSize: '10px', color: '#94a3b8' }}>E-posta</p>
                          <p style={{ margin: 0, fontSize: '13px', color: '#64748b' }}>-</p>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Kimlik Bilgileri */}
              <div style={{ background: 'linear-gradient(135deg, rgba(59,130,246,0.08) 0%, rgba(59,130,246,0.02) 100%)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(59,130,246,0.15)' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' }}>
                  <div style={{ width: '36px', height: '36px', borderRadius: '10px', background: 'linear-gradient(135deg, #3b82f6, #2563eb)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px' }}>ğŸªª</div>
                  <h3 style={{ margin: 0, fontSize: '15px', color: '#ffffff', fontWeight: '600' }}>Kimlik Bilgileri</h3>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                  <InfoBox label="TC Kimlik No" value={c.tcKimlik} />
                  <InfoBox label="TK Ãœyelik No" value={c.tkMemberNo} />
                  <InfoBox label="DoÄŸum Tarihi" value={formatDate(c.birthDate)} />
                  <InfoBox label="DoÄŸum Yeri" value={c.birthPlace} />
                  <InfoBox label="Ä°kametgah Ä°li" value={c.city} />
                </div>
              </div>

              {/* Ä°ÅŸ Bilgileri */}
              <div style={{ background: 'linear-gradient(135deg, rgba(16,185,129,0.08) 0%, rgba(16,185,129,0.02) 100%)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(16,185,129,0.15)' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' }}>
                  <div style={{ width: '36px', height: '36px', borderRadius: '10px', background: 'linear-gradient(135deg, #10b981, #059669)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px' }}>ğŸ’¼</div>
                  <h3 style={{ margin: 0, fontSize: '15px', color: '#ffffff', fontWeight: '600' }}>Ä°ÅŸ Bilgileri</h3>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                  <InfoBox label="SektÃ¶r" value={c.sector} />
                  <InfoBox label="Firma" value={c.companyName} />
                </div>
                {c.notes && (
                  <div style={{ marginTop: '10px' }}>
                    <InfoBox label="Notlar" value={c.notes} />
                  </div>
                )}
              </div>
            </div>
          )}

          {/* PASAPORT */}
          {detailTab === 'passport' && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              {cPassports.length === 0 ? (
                <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: '16px', padding: '40px', textAlign: 'center' }}>
                  <span style={{ fontSize: '48px' }}>ğŸ›‚</span>
                  <p style={{ color: '#64748b', marginTop: '12px' }}>Pasaport bilgisi eklenmemiÅŸ</p>
                  <button onClick={() => openEditForm(c)} style={{ marginTop: '12px', padding: '10px 20px', background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '10px', color: '#3b82f6', cursor: 'pointer', fontSize: '13px' }}>â• Pasaport Ekle</button>
                </div>
              ) : (
                cPassports.map((p, idx) => (
                  <div key={p.id || idx} style={{ background: 'linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(59,130,246,0.03) 100%)', padding: '20px', borderRadius: '16px', border: '1px solid rgba(59,130,246,0.2)' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <div style={{ width: '32px', height: '32px', borderRadius: '8px', background: p.passportType?.includes('YeÅŸil') ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #3b82f6, #2563eb)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', color: 'white', fontWeight: '700' }}>{idx + 1}</div>
                        <div>
                          <h4 style={{ margin: 0, fontSize: '14px', color: p.passportType?.includes('YeÅŸil') ? '#10b981' : '#3b82f6', fontWeight: '600' }}>{p.passportType || 'Pasaport'}</h4>
                          <p style={{ margin: 0, fontSize: '11px', color: '#94a3b8' }}>{p.nationality || 'TÃ¼rkiye'}</p>
                        </div>
                      </div>
                      {p.expiryDate && getDaysLeft(p.expiryDate) <= 180 && getDaysLeft(p.expiryDate) > 0 && (
                        <span style={{ fontSize: '10px', padding: '4px 10px', borderRadius: '8px', background: 'rgba(239,68,68,0.2)', color: '#ef4444', fontWeight: '600' }}>âš ï¸ {getDaysLeft(p.expiryDate)} gÃ¼n</span>
                      )}
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                      <InfoBox label="Pasaport No" value={p.passportNo} />
                      <InfoBox label="VeriliÅŸ Tarihi" value={formatDate(p.issueDate)} />
                      <InfoBox label="GeÃ§erlilik Tarihi" value={formatDate(p.expiryDate)} highlight={p.expiryDate && getDaysLeft(p.expiryDate) <= 180} />
                    </div>
                    {p.image && (
                      <div style={{ marginTop: '12px' }}>
                        <img src={p.image} alt="Pasaport" onClick={() => setImagePreview({ show: true, src: p.image, title: `Pasaport - ${p.passportNo}` })} style={{ width: '100%', height: '120px', objectFit: 'cover', borderRadius: '10px', cursor: 'pointer' }} />
                      </div>
                    )}
                  </div>
                ))
              )}
            </div>
          )}

          {/* SCHENGEN */}
          {detailTab === 'schengen' && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              {hasGreenPassport ? (
                <div style={{ background: 'linear-gradient(135deg, rgba(16,185,129,0.15) 0%, rgba(16,185,129,0.05) 100%)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(16,185,129,0.3)', textAlign: 'center' }}>
                  <div style={{ width: '64px', height: '64px', borderRadius: '50%', background: 'linear-gradient(135deg, #10b981, #059669)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', margin: '0 auto 16px' }}>âœ“</div>
                  <h3 style={{ margin: '0 0 8px', fontSize: '18px', color: '#10b981', fontWeight: '600' }}>Schengen Vizesi Muafiyeti</h3>
                  <p style={{ margin: '0 0 16px', fontSize: '14px', color: '#94a3b8' }}>Bu mÃ¼ÅŸteri <strong style={{ color: '#10b981' }}>YeÅŸil Pasaport</strong> sahibi olduÄŸu iÃ§in Schengen Ã¼lkelerine vizesiz seyahat edebilir.</p>
                  <div style={{ background: 'rgba(16,185,129,0.1)', borderRadius: '10px', padding: '12px', display: 'inline-block' }}>
                    <p style={{ margin: 0, fontSize: '12px', color: '#64748b' }}>ğŸ“‹ 90 gÃ¼n iÃ§inde toplam 90 gÃ¼n kalÄ±ÅŸ hakkÄ±</p>
                  </div>
                </div>
              ) : cSchengen.length === 0 ? (
                <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: '16px', padding: '40px', textAlign: 'center' }}>
                  <span style={{ fontSize: '48px' }}>ğŸ‡ªğŸ‡º</span>
                  <p style={{ color: '#64748b', marginTop: '12px' }}>Schengen vizesi eklenmemiÅŸ</p>
                  <button onClick={() => openEditForm(c)} style={{ marginTop: '12px', padding: '10px 20px', background: 'rgba(16,185,129,0.2)', border: '1px solid rgba(16,185,129,0.3)', borderRadius: '10px', color: '#10b981', cursor: 'pointer', fontSize: '13px' }}>â• Vize Ekle</button>
                </div>
              ) : (
                cSchengen.map((v, idx) => (
                  <div key={v.id || idx} style={{ background: 'linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.03) 100%)', padding: '20px', borderRadius: '16px', border: '1px solid rgba(16,185,129,0.2)' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <span style={{ fontSize: '24px' }}>ğŸ‡ªğŸ‡º</span>
                        <div>
                          <h4 style={{ margin: 0, fontSize: '14px', color: '#10b981', fontWeight: '600' }}>{v.country}</h4>
                          <p style={{ margin: 0, fontSize: '11px', color: '#94a3b8' }}>Schengen Vizesi</p>
                        </div>
                      </div>
                      {v.endDate && getDaysLeft(v.endDate) > 0 && getDaysLeft(v.endDate) <= 90 && (
                        <span style={{ fontSize: '10px', padding: '4px 10px', borderRadius: '8px', background: 'rgba(234,179,8,0.2)', color: '#eab308', fontWeight: '600' }}>â° {getDaysLeft(v.endDate)} gÃ¼n</span>
                      )}
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                      <InfoBox label="BaÅŸlangÄ±Ã§" value={formatDate(v.startDate)} />
                      <InfoBox label="BitiÅŸ" value={formatDate(v.endDate)} highlight={v.endDate && getDaysLeft(v.endDate) <= 90} />
                    </div>
                    {v.image && (
                      <div style={{ marginTop: '12px' }}>
                        <img src={v.image} alt="Vize" onClick={() => setImagePreview({ show: true, src: v.image, title: `Schengen - ${v.country}` })} style={{ width: '100%', height: '100px', objectFit: 'cover', borderRadius: '10px', cursor: 'pointer' }} />
                      </div>
                    )}
                  </div>
                ))
              )}
            </div>
          )}

          {/* ABD */}
          {detailTab === 'usa' && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              {!cUsa.endDate ? (
                <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: '16px', padding: '40px', textAlign: 'center' }}>
                  <span style={{ fontSize: '48px' }}>ğŸ‡ºğŸ‡¸</span>
                  <p style={{ color: '#64748b', marginTop: '12px' }}>ABD vizesi eklenmemiÅŸ</p>
                  <button onClick={() => openEditForm(c)} style={{ marginTop: '12px', padding: '10px 20px', background: 'rgba(139,92,246,0.2)', border: '1px solid rgba(139,92,246,0.3)', borderRadius: '10px', color: '#8b5cf6', cursor: 'pointer', fontSize: '13px' }}>â• Vize Ekle</button>
                </div>
              ) : (
                <div style={{ background: 'linear-gradient(135deg, rgba(139,92,246,0.12) 0%, rgba(139,92,246,0.04) 100%)', padding: '24px', borderRadius: '16px', border: '1px solid rgba(139,92,246,0.25)' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <div style={{ width: '44px', height: '44px', borderRadius: '12px', background: 'linear-gradient(135deg, #8b5cf6, #7c3aed)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '22px' }}>ğŸ‡ºğŸ‡¸</div>
                      <div>
                        <h3 style={{ margin: 0, fontSize: '16px', color: '#ffffff', fontWeight: '600' }}>Amerika Vizesi</h3>
                        <p style={{ margin: 0, fontSize: '12px', color: '#94a3b8' }}>ABD B1/B2 Turist Vizesi</p>
                      </div>
                    </div>
                    {cUsa.endDate && getDaysLeft(cUsa.endDate) > 0 && getDaysLeft(cUsa.endDate) <= 30 && (
                      <span style={{ fontSize: '10px', padding: '4px 10px', borderRadius: '8px', background: 'rgba(239,68,68,0.2)', color: '#ef4444', fontWeight: '600' }}>âš ï¸ {getDaysLeft(cUsa.endDate)} gÃ¼n</span>
                    )}
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                    <InfoBox label="Vize BaÅŸlangÄ±Ã§" value={formatDate(cUsa.startDate)} />
                    <InfoBox label="Vize BitiÅŸ" value={formatDate(cUsa.endDate)} highlight={cUsa.endDate && getDaysLeft(cUsa.endDate) <= 30} />
                  </div>
                  {cUsa.image && (
                    <div style={{ marginTop: '16px' }}>
                      <img src={cUsa.image} alt="ABD Vizesi" onClick={() => setImagePreview({ show: true, src: cUsa.image, title: 'ABD Vizesi' })} style={{ width: '100%', height: '150px', objectFit: 'cover', borderRadius: '12px', cursor: 'pointer' }} />
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>

        {/* Bottom Action Buttons */}
        <div style={{ position: 'fixed', bottom: 0, left: 0, right: 0, background: 'linear-gradient(180deg, rgba(10,22,40,0) 0%, rgba(10,22,40,0.95) 20%, rgba(10,22,40,1) 100%)', padding: '20px', paddingTop: '40px' }}>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
            <button onClick={() => { setSelectedCustomer(null); openEditForm(c); }} style={{ padding: '14px', background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '600', fontSize: '14px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              <span>âœï¸</span> DÃ¼zenle
            </button>
            <button onClick={() => { if(confirm('Bu mÃ¼ÅŸteriyi silmek istediÄŸinize emin misiniz?')) { deleteCustomer(c.id); setSelectedCustomer(null); } }} style={{ padding: '14px', background: 'rgba(239,68,68,0.2)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '12px', color: '#ef4444', fontWeight: '600', fontSize: '14px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              <span>ğŸ—‘ï¸</span> Sil
            </button>
          </div>
        </div>
      </div>
    );
  };

  // MÃ¼ÅŸteri KartÄ± Render
  const renderCustomerCard = (c) => {
    const cPassports = safeParseJSON(c.passports);
    const cSchengen = safeParseJSON(c.schengenVisas).filter(v => v.country);
    const cUsa = c.usaVisa ? (typeof c.usaVisa === 'string' ? JSON.parse(c.usaVisa || '{}') : c.usaVisa) : {};
    const expiringP = cPassports.find(p => { const d = getDaysLeft(p.expiryDate); return d !== null && d > 0 && d <= 180; });
    
    return (
      <div key={c.id} onClick={() => setSelectedCustomer(c)} style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '12px', border: '1px solid rgba(255,255,255,0.05)', cursor: 'pointer' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
          <div>
            <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>{c.firstName} {c.lastName}</h3>
            <p style={{ margin: '2px 0 0', fontSize: '11px', color: '#64748b' }}>{c.phone} {c.city && `â€¢ ${c.city}`}</p>
            {c.sector && <p style={{ margin: '2px 0 0', fontSize: '10px', color: '#94a3b8' }}>{c.sector}</p>}
          </div>
          <div style={{ display: 'flex', gap: '3px', flexWrap: 'wrap', justifyContent: 'flex-end' }}>
            {cPassports.length > 0 && <span style={{ fontSize: '9px', padding: '2px 5px', borderRadius: '4px', background: 'rgba(59,130,246,0.2)', color: '#3b82f6' }}>ğŸ›‚ {cPassports.length}</span>}
            {cSchengen.length > 0 && <span style={{ fontSize: '9px', padding: '2px 5px', borderRadius: '4px', background: 'rgba(16,185,129,0.2)', color: '#10b981' }}>ğŸ‡ªğŸ‡º {cSchengen.length}</span>}
            {cUsa.endDate && <span style={{ fontSize: '9px', padding: '2px 5px', borderRadius: '4px', background: 'rgba(139,92,246,0.2)', color: '#8b5cf6' }}>ğŸ‡ºğŸ‡¸</span>}
            {expiringP && <span style={{ fontSize: '9px', padding: '2px 5px', borderRadius: '4px', background: 'rgba(239,68,68,0.2)', color: '#ef4444' }}>âš ï¸ {getDaysLeft(expiringP.expiryDate)}g</span>}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div style={{ padding: isMobile ? '16px' : '24px' }}>
      {/* Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}>
        <h2 style={{ fontSize: '20px', margin: 0 }}>ğŸ‘¥ MÃ¼ÅŸteriler ({customers.length})</h2>
        <div style={{ display: 'flex', gap: '8px' }}>
          <button onClick={() => setShowExcelModal(true)} style={{ background: 'rgba(16,185,129,0.2)', border: '1px solid rgba(16,185,129,0.3)', borderRadius: '8px', padding: '8px 12px', color: '#10b981', cursor: 'pointer', fontSize: '12px' }}>ğŸ“Š Excel</button>
          <button onClick={openNewForm} style={{ background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: '#0c1929', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>â• Yeni</button>
        </div>
      </div>

      {/* Ana Sekmeler - SatÄ±r 1 */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '6px', marginBottom: '8px' }}>
        <button onClick={() => { setActiveTab('search'); setShowResults(false); }} style={mainTabStyle(activeTab === 'search')}>
          <span style={{ fontSize: '14px' }}>ğŸ”</span>
          <span>Arama</span>
        </button>
        <button onClick={() => setActiveTab('expiring')} style={mainTabStyle(activeTab === 'expiring')}>
          <span style={{ fontSize: '14px' }}>âš ï¸</span>
          <span>Pasaport ({expiringPassports.length})</span>
        </button>
        <button onClick={() => setActiveTab('birthday')} style={mainTabStyle(activeTab === 'birthday')}>
          <span style={{ fontSize: '14px' }}>ğŸ‚</span>
          <span>DoÄŸum GÃ¼nÃ¼ ({todayBirthdays.length})</span>
        </button>
        <button onClick={() => setActiveTab('schengen')} style={{ ...mainTabStyle(activeTab === 'schengen'), background: activeTab === 'schengen' ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'schengen' ? '1px solid rgba(16,185,129,0.3)' : '1px solid rgba(255,255,255,0.1)', color: activeTab === 'schengen' ? '#10b981' : '#94a3b8' }}>
          <span style={{ fontSize: '14px' }}>ğŸ‡ªğŸ‡º</span>
          <span>Schengen ({withSchengen.length})</span>
        </button>
      </div>

      {/* Ana Sekmeler - SatÄ±r 2 */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '6px', marginBottom: '16px' }}>
        <button onClick={() => setActiveTab('schengenExpiring')} style={{ ...mainTabStyle(activeTab === 'schengenExpiring'), background: activeTab === 'schengenExpiring' ? 'rgba(234,179,8,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'schengenExpiring' ? '1px solid rgba(234,179,8,0.3)' : '1px solid rgba(255,255,255,0.1)', color: activeTab === 'schengenExpiring' ? '#eab308' : '#94a3b8' }}>
          <span style={{ fontSize: '14px' }}>ğŸ‡ªğŸ‡ºâ°</span>
          <span>Sch. 3ay ({schengenExpiring.length})</span>
        </button>
        <button onClick={() => setActiveTab('usa')} style={{ ...mainTabStyle(activeTab === 'usa'), background: activeTab === 'usa' ? 'rgba(139,92,246,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'usa' ? '1px solid rgba(139,92,246,0.3)' : '1px solid rgba(255,255,255,0.1)', color: activeTab === 'usa' ? '#8b5cf6' : '#94a3b8' }}>
          <span style={{ fontSize: '14px' }}>ğŸ‡ºğŸ‡¸</span>
          <span>ABD ({withUsa.length})</span>
        </button>
        <button onClick={() => setActiveTab('usaExpiring')} style={{ ...mainTabStyle(activeTab === 'usaExpiring'), background: activeTab === 'usaExpiring' ? 'rgba(239,68,68,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'usaExpiring' ? '1px solid rgba(239,68,68,0.3)' : '1px solid rgba(255,255,255,0.1)', color: activeTab === 'usaExpiring' ? '#ef4444' : '#94a3b8' }}>
          <span style={{ fontSize: '14px' }}>ğŸ‡ºğŸ‡¸â°</span>
          <span>ABD 1ay ({usaExpiring.length})</span>
        </button>
        <button onClick={() => setActiveTab('greenPassport')} style={{ ...mainTabStyle(activeTab === 'greenPassport'), background: activeTab === 'greenPassport' ? 'rgba(5,150,105,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'greenPassport' ? '1px solid rgba(5,150,105,0.3)' : '1px solid rgba(255,255,255,0.1)', color: activeTab === 'greenPassport' ? '#059669' : '#94a3b8' }}>
          <span style={{ fontSize: '14px' }}>ğŸŸ¢</span>
          <span>YeÅŸil Pas. ({withGreenPassport.length})</span>
        </button>
      </div>

      {/* ARAMA SEKMESÄ° */}
      {activeTab === 'search' && (
        <>
          <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '12px', marginBottom: '16px', border: '1px solid rgba(255,255,255,0.05)' }}>
            <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr 1fr', gap: '8px' }}>
              <FormInput label="Ad" value={filters.firstName} onChange={e => setFilters({...filters, firstName: e.target.value})} placeholder="Ad ara..." />
              <FormInput label="Soyad" value={filters.lastName} onChange={e => setFilters({...filters, lastName: e.target.value})} placeholder="Soyad ara..." />
              <FormInput label="TC Kimlik" value={filters.tcKimlik} onChange={e => setFilters({...filters, tcKimlik: e.target.value})} placeholder="TC ara..." />
              <FormInput label="Telefon" value={filters.phone} onChange={e => setFilters({...filters, phone: e.target.value})} placeholder="Telefon ara..." />
              <FormInput label="E-posta" value={filters.email} onChange={e => setFilters({...filters, email: e.target.value})} placeholder="E-posta ara..." />
              <FormInput label="DoÄŸum Yeri" value={filters.birthPlace} onChange={e => setFilters({...filters, birthPlace: e.target.value})} placeholder="DoÄŸum yeri ara..." />
              <div>
                <label style={labelStyle}>Ä°kametgah Ä°li</label>
                <select value={filters.city} onChange={e => setFilters({...filters, city: e.target.value})} style={selectStyle}>
                  <option value="">TÃ¼mÃ¼</option>
                  {turkishProvinces.map(p => <option key={p} value={p}>{p}</option>)}
                </select>
              </div>
              <FormInput label="TK Ãœyelik No" value={filters.tkMemberNo} onChange={e => setFilters({...filters, tkMemberNo: e.target.value})} placeholder="TK No ara..." />
              <div>
                <label style={labelStyle}>SektÃ¶r</label>
                <select value={filters.sector} onChange={e => setFilters({...filters, sector: e.target.value})} style={selectStyle}>
                  <option value="">TÃ¼mÃ¼</option>
                  {sectors.map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <FormInput label="Firma" value={filters.companyName} onChange={e => setFilters({...filters, companyName: e.target.value})} placeholder="Firma ara..." />
            </div>
            <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
              <button onClick={handleSearch} disabled={!hasActiveFilter} style={{ flex: 1, padding: '10px', background: hasActiveFilter ? 'linear-gradient(135deg, #3b82f6, #2563eb)' : 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', color: hasActiveFilter ? 'white' : '#64748b', fontWeight: '600', cursor: hasActiveFilter ? 'pointer' : 'not-allowed', fontSize: '13px' }}>ğŸ” Ara ({hasActiveFilter ? filtered.length : 0} sonuÃ§)</button>
              <button onClick={clearFilters} style={{ padding: '10px 16px', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '8px', color: '#ef4444', cursor: 'pointer', fontSize: '13px' }}>âœ• Temizle</button>
              {showResults && filtered.length > 0 && (
                <button onClick={() => exportToExcel(filtered, `Musteri_Arama_${new Date().toLocaleDateString('tr')}`)} style={{ padding: '10px 16px', background: 'rgba(16,185,129,0.2)', border: 'none', borderRadius: '8px', color: '#10b981', cursor: 'pointer', fontSize: '13px' }}>ğŸ“¥ Excel</button>
              )}
            </div>
          </div>

          {/* Arama SonuÃ§larÄ± */}
          {showResults && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
              {filtered.length === 0 ? (
                <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>Arama kriterlerine uygun mÃ¼ÅŸteri bulunamadÄ±</p>
              ) : (
                filtered.map(c => renderCustomerCard(c))
              )}
            </div>
          )}
          
          {!showResults && (
            <div style={{ textAlign: 'center', padding: '40px', color: '#64748b' }}>
              <p style={{ fontSize: '14px' }}>YukarÄ±daki filtrelerden en az birini doldurup "Ara" butonuna tÄ±klayÄ±n</p>
            </div>
          )}
        </>
      )}

      {/* PASAPORT UYARI SEKMESÄ° */}
      {activeTab === 'expiring' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <p style={{ fontSize: '12px', color: '#f59e0b' }}>âš ï¸ 6 ay iÃ§inde pasaportu bitecek mÃ¼ÅŸteriler</p>
            {expiringPassports.length > 0 && (
              <button onClick={() => exportToExcel(expiringPassports, `Pasaport_Uyari_${new Date().toLocaleDateString('tr')}`)} style={{ padding: '6px 12px', background: 'rgba(16,185,129,0.2)', border: 'none', borderRadius: '6px', color: '#10b981', cursor: 'pointer', fontSize: '11px' }}>ğŸ“¥ Excel</button>
            )}
          </div>
          {expiringPassports.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>6 ay iÃ§inde pasaportu bitecek mÃ¼ÅŸteri yok ğŸ‰</p>
          ) : (
            expiringPassports.map(c => {
              const pList = safeParseJSON(c.passports);
              const expP = pList.find(p => { const d = getDaysLeft(p.expiryDate); return d !== null && d > 0 && d <= 180; });
              return (
                <div key={c.id} style={{ background: 'rgba(239,68,68,0.1)', borderRadius: '10px', padding: '12px', border: '1px solid rgba(239,68,68,0.2)' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div onClick={() => setSelectedCustomer(c)} style={{ cursor: 'pointer' }}>
                      <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>{c.firstName} {c.lastName}</h3>
                      <p style={{ margin: '2px 0 0', fontSize: '11px', color: '#64748b' }}>{c.phone}</p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <span style={{ fontSize: '10px', padding: '3px 8px', borderRadius: '6px', background: 'rgba(239,68,68,0.3)', color: '#ef4444', fontWeight: '600' }}>{getDaysLeft(expP?.expiryDate)} gÃ¼n kaldÄ±</span>
                      <p style={{ margin: '4px 0 0', fontSize: '10px', color: '#94a3b8' }}>BitiÅŸ: {formatDate(expP?.expiryDate)}</p>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {/* DOÄUM GÃœNÃœ SEKMESÄ° */}
      {activeTab === 'birthday' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <p style={{ fontSize: '12px', color: '#f59e0b' }}>ğŸ‚ BugÃ¼n doÄŸum gÃ¼nÃ¼ olanlar</p>
            {todayBirthdays.length > 0 && (
              <button onClick={() => exportToExcel(todayBirthdays, `Dogum_Gunu_${new Date().toLocaleDateString('tr')}`)} style={{ padding: '6px 12px', background: 'rgba(16,185,129,0.2)', border: 'none', borderRadius: '6px', color: '#10b981', cursor: 'pointer', fontSize: '11px' }}>ğŸ“¥ Excel</button>
            )}
          </div>
          {todayBirthdays.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>BugÃ¼n doÄŸum gÃ¼nÃ¼ olan mÃ¼ÅŸteri yok</p>
          ) : (
            todayBirthdays.map(c => (
              <div key={c.id} style={{ background: 'rgba(245,158,11,0.1)', borderRadius: '10px', padding: '12px', border: '1px solid rgba(245,158,11,0.2)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div onClick={() => setSelectedCustomer(c)} style={{ cursor: 'pointer' }}>
                    <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>ğŸ‚ {c.firstName} {c.lastName}</h3>
                    <p style={{ margin: '2px 0 0', fontSize: '11px', color: '#64748b' }}>{c.phone}</p>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <span style={{ fontSize: '11px', color: '#f59e0b' }}>DoÄŸum GÃ¼nÃ¼n Kutlu Olsun!</span>
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
      )}

      {/* SCHENGEN VÄ°ZESÄ° OLANLAR */}
      {activeTab === 'schengen' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <p style={{ fontSize: '12px', color: '#10b981' }}>ğŸ‡ªğŸ‡º Schengen vizesi olan mÃ¼ÅŸteriler</p>
            {withSchengen.length > 0 && (
              <button onClick={() => exportToExcel(withSchengen, `Schengen_Vizeli_${new Date().toLocaleDateString('tr')}`)} style={{ padding: '6px 12px', background: 'rgba(16,185,129,0.2)', border: 'none', borderRadius: '6px', color: '#10b981', cursor: 'pointer', fontSize: '11px' }}>ğŸ“¥ Excel</button>
            )}
          </div>
          {withSchengen.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>Schengen vizesi olan mÃ¼ÅŸteri yok</p>
          ) : (
            withSchengen.map(c => {
              const visas = safeParseJSON(c.schengenVisas).filter(v => v.country);
              const activeVisa = visas.find(v => getDaysLeft(v.endDate) > 0);
              return (
                <div key={c.id} onClick={() => setSelectedCustomer(c)} style={{ background: 'rgba(16,185,129,0.1)', borderRadius: '10px', padding: '12px', border: '1px solid rgba(16,185,129,0.2)', cursor: 'pointer' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>{c.firstName} {c.lastName}</h3>
                      <p style={{ margin: '2px 0 0', fontSize: '11px', color: '#64748b' }}>{c.phone}</p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      {activeVisa && (
                        <>
                          <span style={{ fontSize: '10px', padding: '3px 8px', borderRadius: '6px', background: 'rgba(16,185,129,0.3)', color: '#10b981', fontWeight: '600' }}>{activeVisa.country}</span>
                          <p style={{ margin: '4px 0 0', fontSize: '10px', color: '#94a3b8' }}>BitiÅŸ: {formatDate(activeVisa.endDate)}</p>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {/* SCHENGEN 3 AY Ä°Ã‡Ä°NDE BÄ°TECEK */}
      {activeTab === 'schengenExpiring' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <p style={{ fontSize: '12px', color: '#eab308' }}>ğŸ‡ªğŸ‡ºâ° 3 ay iÃ§inde Schengen vizesi bitecek mÃ¼ÅŸteriler</p>
            {schengenExpiring.length > 0 && (
              <button onClick={() => exportToExcel(schengenExpiring, `Schengen_Uyari_${new Date().toLocaleDateString('tr')}`)} style={{ padding: '6px 12px', background: 'rgba(234,179,8,0.2)', border: 'none', borderRadius: '6px', color: '#eab308', cursor: 'pointer', fontSize: '11px' }}>ğŸ“¥ Excel</button>
            )}
          </div>
          {schengenExpiring.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>3 ay iÃ§inde Schengen vizesi bitecek mÃ¼ÅŸteri yok ğŸ‰</p>
          ) : (
            schengenExpiring.map(c => {
              const visas = safeParseJSON(c.schengenVisas);
              const expVisa = visas.find(v => { const d = getDaysLeft(v.endDate); return d !== null && d > 0 && d <= 90; });
              return (
                <div key={c.id} onClick={() => setSelectedCustomer(c)} style={{ background: 'rgba(234,179,8,0.1)', borderRadius: '10px', padding: '12px', border: '1px solid rgba(234,179,8,0.2)', cursor: 'pointer' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>{c.firstName} {c.lastName}</h3>
                      <p style={{ margin: '2px 0 0', fontSize: '11px', color: '#64748b' }}>{c.phone} â€¢ {expVisa?.country}</p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <span style={{ fontSize: '10px', padding: '3px 8px', borderRadius: '6px', background: 'rgba(234,179,8,0.3)', color: '#eab308', fontWeight: '600' }}>{getDaysLeft(expVisa?.endDate)} gÃ¼n kaldÄ±</span>
                      <p style={{ margin: '4px 0 0', fontSize: '10px', color: '#94a3b8' }}>BitiÅŸ: {formatDate(expVisa?.endDate)}</p>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {/* ABD VÄ°ZESÄ° OLANLAR */}
      {activeTab === 'usa' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <p style={{ fontSize: '12px', color: '#8b5cf6' }}>ğŸ‡ºğŸ‡¸ ABD vizesi olan mÃ¼ÅŸteriler</p>
            {withUsa.length > 0 && (
              <button onClick={() => exportToExcel(withUsa, `ABD_Vizeli_${new Date().toLocaleDateString('tr')}`)} style={{ padding: '6px 12px', background: 'rgba(139,92,246,0.2)', border: 'none', borderRadius: '6px', color: '#8b5cf6', cursor: 'pointer', fontSize: '11px' }}>ğŸ“¥ Excel</button>
            )}
          </div>
          {withUsa.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>ABD vizesi olan mÃ¼ÅŸteri yok</p>
          ) : (
            withUsa.map(c => {
              const visa = c.usaVisa ? (typeof c.usaVisa === 'string' ? JSON.parse(c.usaVisa || '{}') : c.usaVisa) : {};
              return (
                <div key={c.id} onClick={() => setSelectedCustomer(c)} style={{ background: 'rgba(139,92,246,0.1)', borderRadius: '10px', padding: '12px', border: '1px solid rgba(139,92,246,0.2)', cursor: 'pointer' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>{c.firstName} {c.lastName}</h3>
                      <p style={{ margin: '2px 0 0', fontSize: '11px', color: '#64748b' }}>{c.phone}</p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <span style={{ fontSize: '10px', padding: '3px 8px', borderRadius: '6px', background: 'rgba(139,92,246,0.3)', color: '#8b5cf6', fontWeight: '600' }}>ğŸ‡ºğŸ‡¸ ABD</span>
                      <p style={{ margin: '4px 0 0', fontSize: '10px', color: '#94a3b8' }}>BitiÅŸ: {formatDate(visa.endDate)}</p>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {/* ABD 1 AY Ä°Ã‡Ä°NDE BÄ°TECEK */}
      {activeTab === 'usaExpiring' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <p style={{ fontSize: '12px', color: '#ef4444' }}>ğŸ‡ºğŸ‡¸â° 1 ay iÃ§inde ABD vizesi bitecek mÃ¼ÅŸteriler</p>
            {usaExpiring.length > 0 && (
              <button onClick={() => exportToExcel(usaExpiring, `ABD_Uyari_${new Date().toLocaleDateString('tr')}`)} style={{ padding: '6px 12px', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '6px', color: '#ef4444', cursor: 'pointer', fontSize: '11px' }}>ğŸ“¥ Excel</button>
            )}
          </div>
          {usaExpiring.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>1 ay iÃ§inde ABD vizesi bitecek mÃ¼ÅŸteri yok ğŸ‰</p>
          ) : (
            usaExpiring.map(c => {
              const visa = c.usaVisa ? (typeof c.usaVisa === 'string' ? JSON.parse(c.usaVisa || '{}') : c.usaVisa) : {};
              return (
                <div key={c.id} onClick={() => setSelectedCustomer(c)} style={{ background: 'rgba(239,68,68,0.1)', borderRadius: '10px', padding: '12px', border: '1px solid rgba(239,68,68,0.2)', cursor: 'pointer' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>{c.firstName} {c.lastName}</h3>
                      <p style={{ margin: '2px 0 0', fontSize: '11px', color: '#64748b' }}>{c.phone}</p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <span style={{ fontSize: '10px', padding: '3px 8px', borderRadius: '6px', background: 'rgba(239,68,68,0.3)', color: '#ef4444', fontWeight: '600' }}>{getDaysLeft(visa.endDate)} gÃ¼n kaldÄ±</span>
                      <p style={{ margin: '4px 0 0', fontSize: '10px', color: '#94a3b8' }}>BitiÅŸ: {formatDate(visa.endDate)}</p>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {/* YEÅÄ°L PASAPORT SEKMESÄ° */}
      {activeTab === 'greenPassport' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <p style={{ fontSize: '12px', color: '#059669' }}>ğŸŸ¢ YeÅŸil Pasaport (Hususi) sahibi mÃ¼ÅŸteriler</p>
            {withGreenPassport.length > 0 && (
              <button onClick={() => exportToExcel(withGreenPassport, `Yesil_Pasaport_${new Date().toLocaleDateString('tr')}`)} style={{ padding: '6px 12px', background: 'rgba(5,150,105,0.2)', border: 'none', borderRadius: '6px', color: '#059669', cursor: 'pointer', fontSize: '11px' }}>ğŸ“¥ Excel</button>
            )}
          </div>
          {withGreenPassport.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>YeÅŸil Pasaport sahibi mÃ¼ÅŸteri yok</p>
          ) : (
            withGreenPassport.map(c => {
              const pList = safeParseJSON(c.passports);
              const greenPassport = pList.find(p => p.passportType === 'YeÅŸil Pasaport (Hususi)');
              return (
                <div key={c.id} onClick={() => setSelectedCustomer(c)} style={{ background: 'rgba(5,150,105,0.1)', borderRadius: '10px', padding: '12px', border: '1px solid rgba(5,150,105,0.2)', cursor: 'pointer' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>{c.firstName} {c.lastName}</h3>
                      <p style={{ margin: '2px 0 0', fontSize: '11px', color: '#64748b' }}>{c.phone}</p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <span style={{ fontSize: '10px', padding: '3px 8px', borderRadius: '6px', background: 'rgba(5,150,105,0.3)', color: '#059669', fontWeight: '600' }}>ğŸŸ¢ YeÅŸil</span>
                      {greenPassport?.passportNo && (
                        <p style={{ margin: '4px 0 0', fontSize: '10px', color: '#94a3b8' }}>No: {greenPassport.passportNo}</p>
                      )}
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {/* Excel Modal */}
      {showExcelModal && (
        <Modal title="ğŸ“Š Excel Ä°ÅŸlemleri" onClose={() => setShowExcelModal(false)}>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
            <div style={{ background: 'rgba(16,185,129,0.1)', padding: '16px', borderRadius: '10px', border: '1px solid rgba(16,185,129,0.2)' }}>
              <h4 style={{ margin: '0 0 10px', fontSize: '13px', color: '#10b981' }}>ğŸ“¥ Excel'den YÃ¼kle</h4>
              <p style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '10px' }}>Excel dosyanÄ±zda ÅŸu sÃ¼tunlar olmalÄ±: Ad, Soyad, TC Kimlik, Telefon, E-posta, DoÄŸum Tarihi, DoÄŸum Yeri, Ä°kametgah Ä°li, TK Ãœyelik No, SektÃ¶r, Firma, Notlar</p>
              <input ref={fileInputRef} type="file" accept=".xlsx,.xls" onChange={handleExcelImport} style={{ display: 'none' }} />
              <button onClick={() => fileInputRef.current?.click()} style={{ width: '100%', padding: '10px', background: 'rgba(16,185,129,0.2)', border: '1px solid rgba(16,185,129,0.3)', borderRadius: '8px', color: '#10b981', cursor: 'pointer', fontSize: '12px' }}>ğŸ“‚ Dosya SeÃ§</button>
            </div>
            
            <div style={{ background: 'rgba(59,130,246,0.1)', padding: '16px', borderRadius: '10px', border: '1px solid rgba(59,130,246,0.2)' }}>
              <h4 style={{ margin: '0 0 10px', fontSize: '13px', color: '#3b82f6' }}>ğŸ“¤ Excel'e Aktar</h4>
              <button onClick={() => exportToExcel(customers, `Tum_Musteriler_${new Date().toLocaleDateString('tr')}`)} style={{ width: '100%', padding: '10px', background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '8px', color: '#3b82f6', cursor: 'pointer', fontSize: '12px' }}>ğŸ“¥ TÃ¼m MÃ¼ÅŸterileri Ä°ndir ({customers.length})</button>
            </div>
          </div>
        </Modal>
      )}

      {showForm && renderFullPageForm()}
      {selectedCustomer && renderFullPageDetail()}

      {/* Image Preview */}
      {imagePreview.show && (
        <div onClick={() => setImagePreview({ show: false, src: '', title: '' })} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.95)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 400, padding: '20px' }}>
          <div style={{ maxWidth: '90%', maxHeight: '90%' }}>
            <p style={{ color: 'white', textAlign: 'center', marginBottom: '10px', fontSize: '14px' }}>{imagePreview.title}</p>
            <img src={imagePreview.src} alt={imagePreview.title} style={{ maxWidth: '100%', maxHeight: '80vh', borderRadius: '8px' }} />
            <p style={{ color: '#64748b', textAlign: 'center', marginTop: '10px', fontSize: '12px' }}>Kapatmak iÃ§in tÄ±klayÄ±n</p>
          </div>
        </div>
      )}
    </div>
  );
}

// VÄ°ZE MODÃœLÃœ
function VisaModule({ customers, visaApplications, setVisaApplications, isMobile, onNavigateToCustomers, appSettings, showToast, addToUndo }) {
  const [activeTab, setActiveTab] = useState('calendar');
  const [showForm, setShowForm] = useState(false);
  const [formStep, setFormStep] = useState('search');
  const [searchQuery, setSearchQuery] = useState('');
  const [visaSearchQuery, setVisaSearchQuery] = useState('');
  const [selectedCustomer, setSelectedCustomer] = useState(null);
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [dayDetailModal, setDayDetailModal] = useState(null);
  const [editingVisa, setEditingVisa] = useState(null);
  const [formData, setFormData] = useState({});
  const [checklist, setChecklist] = useState({ passportValid: null, passportCondition: null, addressChecked: null });
  const [selectedVisa, setSelectedVisa] = useState(null);

  const paymentStatuses = ['Ã–denmedi', 'KÄ±smi Ã–dendi', 'Ã–dendi'];

  // Vize kategorileri - durations appSettings'ten alÄ±nÄ±r
  const visaCategories = [
    { id: 'schengen', label: 'Schengen', icon: 'ğŸ‡ªğŸ‡º', color: '#10b981', countries: ['Almanya', 'Fransa', 'Ä°talya', 'Ä°spanya', 'Hollanda', 'BelÃ§ika', 'Avusturya', 'Yunanistan', 'Portekiz', 'Polonya', 'Ã‡ekya', 'Macaristan', 'Ä°sviÃ§re', 'Danimarka', 'Ä°sveÃ§', 'NorveÃ§', 'Finlandiya'], durations: null },
    { id: 'usa', label: 'Amerika', icon: 'ğŸ‡ºğŸ‡¸', color: '#3b82f6', countries: ['Amerika BirleÅŸik Devletleri'], durations: appSettings?.visaDurations?.usa || null },
    { id: 'russia', label: 'Rusya', icon: 'ğŸ‡·ğŸ‡º', color: '#ef4444', countries: ['Rusya'], durations: appSettings?.visaDurations?.russia || null },
    { id: 'uk', label: 'Ä°ngiltere', icon: 'ğŸ‡¬ğŸ‡§', color: '#8b5cf6', countries: ['Ä°ngiltere'], durations: appSettings?.visaDurations?.uk || null },
    { id: 'uae', label: 'BAE', icon: 'ğŸ‡¦ğŸ‡ª', color: '#f59e0b', countries: ['BirleÅŸik Arap Emirlikleri', 'Dubai', 'Abu Dabi'], durations: appSettings?.visaDurations?.uae || null },
    { id: 'china', label: 'Ã‡in', icon: 'ğŸ‡¨ğŸ‡³', color: '#dc2626', countries: ['Ã‡in'], durations: appSettings?.visaDurations?.china || null },
    { id: 'other', label: 'DiÄŸer', icon: 'ğŸŒ', color: '#64748b', countries: ['Kanada', 'Avustralya', 'Japonya', 'Hindistan', 'GÃ¼ney Kore', 'Brezilya', 'Meksika', 'DiÄŸer'], durations: null }
  ];

  const visaTypes = ['Ticari', 'Turistik', 'Aile/ArkadaÅŸ Ziyareti', 'Fuar KatÄ±lÄ±mcÄ±', 'Tedavi', 'EÄŸitim', 'Transit', 'DiÄŸer'];
  const visaStatuses = ['Evrak Topluyor', 'Evrak TamamlandÄ±', 'Randevu AlÄ±ndÄ±', 'BaÅŸvuru YapÄ±ldÄ±', 'SonuÃ§ Bekliyor', 'OnaylandÄ±', 'Reddedildi'];

  // Hex to RGBA helper
  const hexToRgb = (hex) => {
    const colorMap = {
      '#10b981': '16,185,129',
      '#3b82f6': '59,130,246',
      '#ef4444': '239,68,68',
      '#8b5cf6': '139,92,246',
      '#f59e0b': '245,158,11',
      '#dc2626': '220,38,38',
      '#64748b': '100,116,139'
    };
    return colorMap[hex] || '100,116,139';
  };

  // Vize baÅŸvurularÄ± arama/filtreleme
  const filteredVisaApplications = visaSearchQuery.length >= 2
    ? visaApplications.filter(v =>
        v.customerName?.toLowerCase().includes(visaSearchQuery.toLowerCase()) ||
        v.customerPhone?.includes(visaSearchQuery) ||
        v.country?.toLowerCase().includes(visaSearchQuery.toLowerCase()) ||
        v.pnr?.toLowerCase().includes(visaSearchQuery.toLowerCase())
      )
    : visaApplications;

  // Excel export fonksiyonu
  const exportToExcel = () => {
    if (visaApplications.length === 0) {
      showToast?.('Export edilecek vize baÅŸvurusu yok', 'warning');
      return;
    }
    const data = visaApplications.map(v => ({
      'MÃ¼ÅŸteri AdÄ±': v.customerName || '',
      'Telefon': v.customerPhone || '',
      'Kategori': getCategoryInfo(v.category)?.label || v.category || '',
      'Ãœlke': v.country || '',
      'Vize TÃ¼rÃ¼': v.visaType || '',
      'Vize SÃ¼resi': v.visaDuration || '',
      'BaÅŸvuru Tarihi': formatDate(v.applicationDate) || '',
      'Randevu Tarihi': formatDate(v.appointmentDate) || '',
      'Randevu Saati': v.appointmentTime || '',
      'PNR': v.pnr || '',
      'Ä°ÅŸlem': v.processor || '',
      'Ã–deme Durumu': v.paymentStatus || '',
      'Durum': v.status || '',
      'Notlar': v.notes || ''
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Vize BaÅŸvurularÄ±');
    XLSX.writeFile(wb, `vize-basvurulari-${new Date().toISOString().split('T')[0]}.xlsx`);
    showToast?.(`${visaApplications.length} baÅŸvuru Excel'e aktarÄ±ldÄ±`, 'success');
  };

  // Arama sonuÃ§larÄ± (form iÃ§in mÃ¼ÅŸteri arama)
  const searchResults = searchQuery.length >= 2 
    ? customers.filter(c => 
        `${c.firstName} ${c.lastName}`.toLowerCase().includes(searchQuery.toLowerCase()) ||
        c.phone?.includes(searchQuery)
      ).slice(0, 10)
    : [];

  // 10 gÃ¼n ve altÄ± randevular
  const upcomingReminders = visaApplications.filter(v => {
    if (!v.appointmentDate) return false;
    const days = getDaysLeft(v.appointmentDate);
    return days !== null && days >= 0 && days <= 10;
  }).sort((a, b) => new Date(a.appointmentDate) - new Date(b.appointmentDate));

  // Takvim
  const today = new Date();
  const [calendarMonth, setCalendarMonth] = useState(today.getMonth());
  const [calendarYear, setCalendarYear] = useState(today.getFullYear());

  const getMonthDays = (year, month) => {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const days = [];
    const startPadding = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
    for (let i = 0; i < startPadding; i++) days.push({ day: null, date: null });
    for (let d = 1; d <= lastDay.getDate(); d++) {
      const date = new Date(year, month, d);
      const dateStr = date.toISOString().split('T')[0];
      const appointments = visaApplications.filter(v => v.appointmentDate === dateStr);
      days.push({ day: d, date: dateStr, appointments });
    }
    return days;
  };

  const monthNames = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
  const month1Days = getMonthDays(calendarYear, calendarMonth);
  const month2Year = calendarMonth === 11 ? calendarYear + 1 : calendarYear;
  const month2Month = calendarMonth === 11 ? 0 : calendarMonth + 1;
  const month2Days = getMonthDays(month2Year, month2Month);

  const resetForm = () => {
    setFormStep('search');
    setSearchQuery('');
    setSelectedCustomer(null);
    setSelectedCategory(null);
    setChecklist({ passportValid: null, passportCondition: null, addressChecked: null });
    setFormData({});
    setEditingVisa(null);
  };

  const openNewForm = () => { resetForm(); setShowForm(true); };

  const selectCustomer = (customer) => {
    setSelectedCustomer(customer);
    setFormStep('checklist');
  };

  const handleChecklistNext = () => {
    if (checklist.passportValid !== 'yes') {
      alert('âš ï¸ Pasaport geÃ§erlilik tarihi uygun deÄŸil!\n\nSeyahat dÃ¶nÃ¼ÅŸ tarihinden itibaren 6 ay geÃ§erli olmalÄ±.');
      return;
    }
    if (checklist.passportCondition !== 'no') {
      alert('âš ï¸ Pasaportta yÄ±rtÄ±k/Ã§izik var!\n\nBaÅŸvuru yapÄ±lamaz, yeni pasaport gerekli.');
      return;
    }
    if (checklist.addressChecked !== 'yes') {
      alert('âš ï¸ Ä°kametgah adresi kontrol edilmeli!\n\nBÃ¶lge ayrÄ±mÄ± Ã¶nemli, doÄŸru konsolosluk belirlenmeli.');
      return;
    }
    setFormStep('category');
  };

  const selectCategory = (cat) => {
    setSelectedCategory(cat);
    setFormStep('details');
    const today = new Date().toISOString().split('T')[0];
    setFormData({
      customerId: selectedCustomer.id,
      customerName: `${selectedCustomer.firstName} ${selectedCustomer.lastName}`,
      customerPhone: selectedCustomer.phone,
      customerEmail: selectedCustomer.email || '',
      category: cat.id,
      country: '',
      visaType: '',
      applicationDate: today,
      appointmentDate: '',
      appointmentTime: '',
      pnr: '',
      processor: appSettings?.processors?.[0] || 'Paydos',
      paymentStatus: 'Ã–denmedi',
      status: 'Evrak Topluyor',
      notes: '',
      price: '',
      cost: '',
      currency: 'â‚¬'
    });
  };

  const sendWhatsAppReminder = (visa) => {
    if (!visa.appointmentDate || !visa.customerPhone) {
      alert('Randevu tarihi veya telefon numarasÄ± eksik!');
      return;
    }
    let message = appSettings?.whatsappTemplate || 'Randevu bilgileriniz: {tarih}';
    message = message
      .replace('{isim}', visa.customerName || '')
      .replace('{ulke}', visa.country || '')
      .replace('{tarih}', formatDate(visa.appointmentDate) || '')
      .replace('{saat}', visa.appointmentTime || '')
      .replace('{pnr}', visa.pnr || '-');
    
    const phone = visa.customerPhone.replace(/\D/g, '');
    const fullPhone = phone.startsWith('90') ? phone : `90${phone}`;
    window.open(`https://wa.me/${fullPhone}?text=${encodeURIComponent(message)}`, '_blank');
  };

  const sendEmail = (visa) => {
    if (!visa.customerEmail) {
      alert('MÃ¼ÅŸteri e-posta adresi bulunamadÄ±!');
      return;
    }
    const subject = `${visa.country} Vize Randevu Bilgisi`;
    const body = `SayÄ±n ${visa.customerName},\n\n${visa.country} vize randevunuz ${formatDate(visa.appointmentDate)} tarihinde${visa.appointmentTime ? ` saat ${visa.appointmentTime}` : ''} iÃ§in alÄ±nmÄ±ÅŸtÄ±r.\n\nPNR: ${visa.pnr || '-'}\n\nPaydos Turizm`;
    window.open(`mailto:${visa.customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
  };

  const sendWhatsApp = (visa) => {
    const phone = visa.customerPhone?.replace(/\D/g, '');
    if (!phone) return;
    const fullPhone = phone.startsWith('90') ? phone : `90${phone}`;
    window.open(`https://wa.me/${fullPhone}`, '_blank');
  };

  const generateProforma = async (visa) => {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Logo ve Header
      doc.setFontSize(20);
      doc.setTextColor(15, 23, 42);
      doc.text('PAYDOS TURÄ°ZM', 105, 20, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setTextColor(100, 116, 139);
      doc.text('Proforma Fatura', 105, 28, { align: 'center' });
      
      // MÃ¼ÅŸteri Bilgileri
      doc.setFontSize(12);
      doc.setTextColor(15, 23, 42);
      doc.text('MÃ¼ÅŸteri Bilgileri', 20, 45);
      
      doc.setFontSize(10);
      doc.setTextColor(51, 65, 85);
      doc.text(`Ad Soyad: ${visa.customerName}`, 20, 55);
      doc.text(`Telefon: ${visa.customerPhone || '-'}`, 20, 62);
      doc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR')}`, 20, 69);
      
      // Vize DetaylarÄ±
      doc.setFontSize(12);
      doc.setTextColor(15, 23, 42);
      doc.text('Vize DetaylarÄ±', 20, 85);
      
      doc.setFontSize(10);
      doc.setTextColor(51, 65, 85);
      doc.text(`Ãœlke: ${visa.country}`, 20, 95);
      doc.text(`Vize TÃ¼rÃ¼: ${visa.visaDuration || visa.visaType}`, 20, 102);
      
      if (visa.applicationDate) {
        doc.text(`BaÅŸvuru Tarihi: ${formatDate(visa.applicationDate)}`, 20, 109);
      }
      
      if (visa.appointmentDate) {
        doc.text(`Randevu Tarihi: ${formatDate(visa.appointmentDate)} ${visa.appointmentTime || ''}`, 20, 116);
      }
      
      if (visa.pnr) {
        doc.text(`PNR: ${visa.pnr}`, 20, 123);
      }
      
      // Fiyat Tablosu
      doc.setFillColor(248, 250, 252);
      doc.rect(20, 140, 170, 10, 'F');
      
      doc.setFontSize(10);
      doc.setTextColor(15, 23, 42);
      doc.text('Hizmet', 25, 146);
      doc.text('Fiyat', 170, 146, { align: 'right' });
      
      // Fiyat satÄ±rÄ±
      const price = visa.visaPrice || 0;
      const currency = visa.visaCurrency || 'â‚¬';
      const serviceName = visa.visaDuration || visa.visaType || 'Vize Hizmeti';
      
      doc.setTextColor(51, 65, 85);
      doc.text(serviceName, 25, 158);
      doc.text(`${price} ${currency}`, 170, 158, { align: 'right' });
      
      // Toplam
      doc.setDrawColor(226, 232, 240);
      doc.line(20, 165, 190, 165);
      
      doc.setFontSize(12);
      doc.setTextColor(15, 23, 42);
      doc.text('TOPLAM', 25, 175);
      doc.text(`${price} ${currency}`, 170, 175, { align: 'right' });
      
      // Ã–deme Durumu
      doc.setFontSize(9);
      if (visa.paymentStatus === 'Ã–dendi') {
        doc.setTextColor(16, 185, 129);
        doc.text('âœ“ Ã–DENDÄ°', 25, 185);
      } else {
        doc.setTextColor(239, 68, 68);
        doc.text('âœ— Ã–DENMEDÄ°', 25, 185);
      }
      
      // Banka Bilgileri
      const bankInfo = appSettings?.bankInfo;
      if (bankInfo && bankInfo.iban) {
        doc.setFontSize(11);
        doc.setTextColor(15, 23, 42);
        doc.text('Banka Bilgileri', 20, 205);
        
        doc.setFontSize(9);
        doc.setTextColor(51, 65, 85);
        let yPos = 213;
        
        if (bankInfo.bankName) {
          doc.text(`Banka: ${bankInfo.bankName}`, 20, yPos);
          yPos += 6;
        }
        
        if (bankInfo.accountName) {
          doc.text(`Hesap Sahibi: ${bankInfo.accountName}`, 20, yPos);
          yPos += 6;
        }
        
        doc.text(`IBAN: ${bankInfo.iban}`, 20, yPos);
        yPos += 6;
        
        if (bankInfo.swift) {
          doc.text(`SWIFT: ${bankInfo.swift}`, 20, yPos);
        }
      }
      
      // Notlar
      if (visa.notes) {
        doc.setFontSize(10);
        doc.setTextColor(15, 23, 42);
        doc.text('Notlar', 20, 250);
        
        doc.setFontSize(9);
        doc.setTextColor(100, 116, 139);
        const lines = doc.splitTextToSize(visa.notes, 170);
        doc.text(lines, 20, 257);
      }
      
      // Footer
      doc.setFontSize(8);
      doc.setTextColor(148, 163, 184);
      doc.text('Bu proforma fatura bilgilendirme amaÃ§lÄ±dÄ±r.', 105, 280, { align: 'center' });
      doc.text('Paydos Turizm - www.paydostur.com', 105, 285, { align: 'center' });
      
      // PDF'i indir
      doc.save(`Proforma_${visa.customerName}_${new Date().toLocaleDateString('tr-TR')}.pdf`);
      
      showToast?.('Proforma baÅŸarÄ±yla indirildi', 'success');
    } catch (error) {
      console.error('Proforma oluÅŸturma hatasÄ±:', error);
      showToast?.('Proforma oluÅŸturulamadÄ±', 'error');
    }
  };

  const [saving, setSaving] = useState(false);

  const handleSubmit = async () => {
    if (!formData.country || !formData.visaType) {
      showToast?.('Ãœlke ve vize tÃ¼rÃ¼ seÃ§iniz', 'error');
      return;
    }
    setSaving(true);
    try {
      if (editingVisa) {
        const oldVisa = visaApplications.find(v => v.id === editingVisa.id);
        const updated = visaApplications.map(v => v.id === editingVisa.id ? { ...formData, id: editingVisa.id } : v);
        setVisaApplications(updated);
        addToUndo?.({ type: 'update', undo: () => setVisaApplications(visaApplications.map(v => v.id === editingVisa.id ? oldVisa : v)) });
        try { await supabase.from('visa_applications').update(toSnakeCase(formData)).eq('id', editingVisa.id); } catch (err) { console.error(err); }
        showToast?.('Vize baÅŸvurusu gÃ¼ncellendi', 'success');
      } else {
        const newVisa = { ...formData, id: generateUniqueId(), createdAt: new Date().toISOString() };
        setVisaApplications([...visaApplications, newVisa]);
        addToUndo?.({ type: 'create', undo: () => setVisaApplications(prev => prev.filter(v => v.id !== newVisa.id)) });
        try { await supabase.from('visa_applications').insert([toSnakeCase(newVisa)]); } catch (err) { console.error(err); }
        showToast?.(`${formData.customerName} iÃ§in vize baÅŸvurusu oluÅŸturuldu`, 'success');
      }
      setShowForm(false);
      resetForm();
    } finally {
      setSaving(false);
    }
  };

  const deleteVisa = async (id) => {
    const visaToDelete = visaApplications.find(v => v.id === id);
    if (!visaToDelete) return;
    
    setVisaApplications(visaApplications.filter(v => v.id !== id));
    setSelectedVisa(null);
    
    // Undo ile geri alÄ±nabilir toast
    showToast?.(`${visaToDelete.customerName} baÅŸvurusu silindi`, 'warning', () => {
      setVisaApplications(prev => [...prev, visaToDelete]);
      supabase.from('visa_applications').insert([toSnakeCase(visaToDelete)]).catch(console.error);
    });
    
    try { await supabase.from('visa_applications').delete().eq('id', id); } catch (err) { console.error(err); }
  };

  const openEditVisa = (visa) => {
    const customer = customers.find(c => c.id === visa.customerId);
    const cat = visaCategories.find(c => c.id === visa.category);
    setSelectedCustomer(customer);
    setSelectedCategory(cat);
    setFormData(visa);
    setEditingVisa(visa);
    setFormStep('details');
    setShowForm(true);
  };

  const getStatusColor = (status) => ({
    'Evrak Topluyor': '#f59e0b', 'Evrak TamamlandÄ±': '#3b82f6', 'Randevu AlÄ±ndÄ±': '#8b5cf6',
    'BaÅŸvuru YapÄ±ldÄ±': '#6366f1', 'SonuÃ§ Bekliyor': '#14b8a6', 'OnaylandÄ±': '#10b981', 'Reddedildi': '#ef4444'
  }[status] || '#94a3b8');

  const getCategoryInfo = (catId) => visaCategories.find(c => c.id === catId) || visaCategories[5];

  // Takvim renderÄ±
  const renderCalendar = (days, monthName, year) => (
    <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '12px', padding: '12px', border: '1px solid rgba(255,255,255,0.05)' }}>
      <h4 style={{ margin: '0 0 10px', fontSize: '13px', color: '#f59e0b', textAlign: 'center' }}>{monthName} {year}</h4>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '2px', fontSize: '10px' }}>
        {['Pt', 'Sa', 'Ã‡a', 'Pe', 'Cu', 'Ct', 'Pz'].map(d => (
          <div key={d} style={{ textAlign: 'center', color: '#64748b', padding: '4px', fontWeight: '600' }}>{d}</div>
        ))}
        {days.map((d, idx) => {
          const isToday = d.date === today.toISOString().split('T')[0];
          const hasAppointments = d.appointments?.length > 0;
          return (
            <div 
              key={idx} 
              onClick={() => hasAppointments && setDayDetailModal({ date: d.date, appointments: d.appointments })}
              style={{ 
                textAlign: 'center', padding: '4px 2px', borderRadius: '6px', minHeight: '32px',
                background: hasAppointments ? 'rgba(245,158,11,0.2)' : 'transparent',
                border: isToday ? '2px solid #f59e0b' : '1px solid transparent',
                color: d.day ? '#e8f1f8' : 'transparent',
                cursor: hasAppointments ? 'pointer' : 'default',
                display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center'
              }}
            >
              <span style={{ fontWeight: isToday ? '700' : '400' }}>{d.day || ''}</span>
              {hasAppointments && (
                <span style={{ fontSize: '8px', color: '#f59e0b', marginTop: '1px' }}>
                  {d.appointments.length > 2 ? `${d.appointments.length} randevu` : d.appointments.map(a => a.customerName?.split(' ')[0]).join(', ')}
                </span>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );

  // FORM RENDER
  const renderForm = () => (
    <div style={{ position: 'fixed', inset: 0, background: 'linear-gradient(180deg, #0a1628 0%, #132742 50%, #0a1628 100%)', zIndex: 300, overflow: 'auto' }}>
      <div style={{ position: 'sticky', top: 0, background: 'rgba(10,22,40,0.98)', backdropFilter: 'blur(20px)', borderBottom: '1px solid rgba(255,255,255,0.08)', padding: '16px 20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', zIndex: 10 }}>
        <button onClick={() => {
          console.log('Geri tÄ±klandÄ±, mevcut step:', formStep);
          if (formStep === 'search') {
            // AdÄ±m 1'deyse formu kapat
            console.log('AdÄ±m 1, kapatÄ±lÄ±yor');
            resetForm();
            setShowForm(false);
          } else if (formStep === 'checklist') {
            // AdÄ±m 2'deyse AdÄ±m 1'e dÃ¶n
            console.log('AdÄ±m 2 â†’ 1');
            setSelectedCustomer(null);
            setChecklist({ passportValid: null, passportCondition: null, addressChecked: null });
            setFormStep('search');
          } else if (formStep === 'category') {
            // AdÄ±m 3'teyse AdÄ±m 2'ye dÃ¶n
            console.log('AdÄ±m 3 â†’ 2');
            setSelectedCategory(null);
            setFormData({});
            setFormStep('checklist');
          } else if (formStep === 'details') {
            // AdÄ±m 4'teyse AdÄ±m 3'e dÃ¶n
            console.log('AdÄ±m 4 â†’ 3');
            setFormData({});
            setFormStep('category');
          }
        }} style={{ background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', padding: '10px 16px', color: '#e8f1f8', cursor: 'pointer', fontSize: '14px' }}>â† Geri</button>
        <h2 style={{ margin: 0, fontSize: '16px', color: '#ffffff' }}>{editingVisa ? 'âœï¸ Vize DÃ¼zenle' : 'ğŸŒ Yeni Vize BaÅŸvurusu'}</h2>
        <div style={{ width: '70px' }}></div>
      </div>

      <div style={{ padding: '20px', paddingBottom: '100px' }}>
        {/* ADIM 1: MÃœÅTERÄ° ARA */}
        {formStep === 'search' && (
          <div>
            <div style={{ background: 'rgba(59,130,246,0.1)', padding: '16px', borderRadius: '12px', marginBottom: '20px', border: '1px solid rgba(59,130,246,0.2)' }}>
              <p style={{ margin: 0, fontSize: '13px', color: '#3b82f6' }}>ğŸ“‹ AdÄ±m 1/4: MÃ¼ÅŸteri SeÃ§imi</p>
            </div>
            
            <input
              type="text"
              placeholder="ğŸ” MÃ¼ÅŸteri ara (ad, soyad veya telefon)..."
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              style={{ width: '100%', padding: '14px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: '#e8f1f8', fontSize: '14px', marginBottom: '16px', boxSizing: 'border-box' }}
            />

            {searchResults.length > 0 && (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {searchResults.map(c => (
                  <div key={c.id} onClick={() => selectCustomer(c)} style={{ background: 'rgba(255,255,255,0.03)', padding: '14px', borderRadius: '10px', border: '1px solid rgba(255,255,255,0.05)', cursor: 'pointer' }}>
                    <h4 style={{ margin: 0, fontSize: '14px' }}>{c.firstName} {c.lastName}</h4>
                    <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>{c.phone} â€¢ {c.city || '-'}</p>
                  </div>
                ))}
              </div>
            )}

            {searchQuery.length >= 2 && searchResults.length === 0 && (
              <div style={{ textAlign: 'center', padding: '30px' }}>
                <p style={{ color: '#64748b', marginBottom: '16px' }}>MÃ¼ÅŸteri bulunamadÄ±</p>
                <button onClick={onNavigateToCustomers} style={{ padding: '12px 24px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#0c1929', fontWeight: '600', cursor: 'pointer' }}>
                  â• Yeni MÃ¼ÅŸteri Ekle
                </button>
              </div>
            )}

            {searchQuery.length < 2 && (
              <p style={{ textAlign: 'center', color: '#64748b', padding: '30px' }}>En az 2 karakter girin</p>
            )}
          </div>
        )}

        {/* ADIM 2: KONTROL LÄ°STESÄ° */}
        {formStep === 'checklist' && selectedCustomer && (
          <div>
            <div style={{ background: 'rgba(245,158,11,0.1)', padding: '16px', borderRadius: '12px', marginBottom: '20px', border: '1px solid rgba(245,158,11,0.2)' }}>
              <p style={{ margin: 0, fontSize: '13px', color: '#f59e0b' }}>ğŸ“‹ AdÄ±m 2/4: Kontrol Listesi</p>
              <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#94a3b8' }}>MÃ¼ÅŸteri: <strong style={{ color: '#fff' }}>{selectedCustomer.firstName} {selectedCustomer.lastName}</strong></p>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              {/* Soru 1 */}
              <div style={{ background: 'rgba(255,255,255,0.03)', padding: '16px', borderRadius: '12px', border: '1px solid rgba(255,255,255,0.05)' }}>
                <p style={{ margin: '0 0 12px', fontSize: '14px', fontWeight: '600' }}>ğŸ›‚ Pasaportun geÃ§erlilik tarihini kontrol ettiniz mi?</p>
                <p style={{ margin: '0 0 12px', fontSize: '11px', color: '#64748b' }}>Seyahat dÃ¶nÃ¼ÅŸ tarihinden itibaren 6 ay geÃ§erli olmalÄ±.</p>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setChecklist({...checklist, passportValid: 'yes'})} style={{ flex: 1, padding: '12px', background: checklist.passportValid === 'yes' ? 'rgba(16,185,129,0.3)' : 'rgba(255,255,255,0.05)', border: checklist.passportValid === 'yes' ? '2px solid #10b981' : '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: checklist.passportValid === 'yes' ? '#10b981' : '#94a3b8', cursor: 'pointer', fontWeight: '600' }}>âœ“ Evet, GeÃ§erli</button>
                  <button onClick={() => setChecklist({...checklist, passportValid: 'no'})} style={{ flex: 1, padding: '12px', background: checklist.passportValid === 'no' ? 'rgba(239,68,68,0.3)' : 'rgba(255,255,255,0.05)', border: checklist.passportValid === 'no' ? '2px solid #ef4444' : '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: checklist.passportValid === 'no' ? '#ef4444' : '#94a3b8', cursor: 'pointer', fontWeight: '600' }}>âœ— HayÄ±r</button>
                </div>
              </div>

              {/* Soru 2 */}
              <div style={{ background: 'rgba(255,255,255,0.03)', padding: '16px', borderRadius: '12px', border: '1px solid rgba(255,255,255,0.05)' }}>
                <p style={{ margin: '0 0 12px', fontSize: '14px', fontWeight: '600' }}>ğŸ“„ Pasaportta yÄ±rtÄ±k veya Ã§izik var mÄ±?</p>
                <p style={{ margin: '0 0 12px', fontSize: '11px', color: '#64748b' }}>HasarlÄ± pasaportla baÅŸvuru yapÄ±lamaz.</p>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setChecklist({...checklist, passportCondition: 'yes'})} style={{ flex: 1, padding: '12px', background: checklist.passportCondition === 'yes' ? 'rgba(239,68,68,0.3)' : 'rgba(255,255,255,0.05)', border: checklist.passportCondition === 'yes' ? '2px solid #ef4444' : '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: checklist.passportCondition === 'yes' ? '#ef4444' : '#94a3b8', cursor: 'pointer', fontWeight: '600' }}>âœ— Evet, Var</button>
                  <button onClick={() => setChecklist({...checklist, passportCondition: 'no'})} style={{ flex: 1, padding: '12px', background: checklist.passportCondition === 'no' ? 'rgba(16,185,129,0.3)' : 'rgba(255,255,255,0.05)', border: checklist.passportCondition === 'no' ? '2px solid #10b981' : '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: checklist.passportCondition === 'no' ? '#10b981' : '#94a3b8', cursor: 'pointer', fontWeight: '600' }}>âœ“ HayÄ±r, Temiz</button>
                </div>
              </div>

              {/* Soru 3 */}
              <div style={{ background: 'rgba(255,255,255,0.03)', padding: '16px', borderRadius: '12px', border: '1px solid rgba(255,255,255,0.05)' }}>
                <p style={{ margin: '0 0 12px', fontSize: '14px', fontWeight: '600' }}>ğŸ“ Ä°kametgah adresini kontrol ettiniz mi?</p>
                <p style={{ margin: '0 0 12px', fontSize: '11px', color: '#64748b' }}>BÃ¶lge ayrÄ±mÄ± var, doÄŸru konsolosluk belirlenmeli.</p>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setChecklist({...checklist, addressChecked: 'yes'})} style={{ flex: 1, padding: '12px', background: checklist.addressChecked === 'yes' ? 'rgba(16,185,129,0.3)' : 'rgba(255,255,255,0.05)', border: checklist.addressChecked === 'yes' ? '2px solid #10b981' : '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: checklist.addressChecked === 'yes' ? '#10b981' : '#94a3b8', cursor: 'pointer', fontWeight: '600' }}>âœ“ Evet, Kontrol Ettim</button>
                  <button onClick={() => setChecklist({...checklist, addressChecked: 'no'})} style={{ flex: 1, padding: '12px', background: checklist.addressChecked === 'no' ? 'rgba(239,68,68,0.3)' : 'rgba(255,255,255,0.05)', border: checklist.addressChecked === 'no' ? '2px solid #ef4444' : '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: checklist.addressChecked === 'no' ? '#ef4444' : '#94a3b8', cursor: 'pointer', fontWeight: '600' }}>âœ— HayÄ±r</button>
                </div>
              </div>
            </div>

            <button onClick={handleChecklistNext} disabled={!checklist.passportValid || !checklist.passportCondition || !checklist.addressChecked} style={{ width: '100%', marginTop: '24px', padding: '16px', background: (checklist.passportValid && checklist.passportCondition && checklist.addressChecked) ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '12px', color: (checklist.passportValid && checklist.passportCondition && checklist.addressChecked) ? '#0c1929' : '#64748b', fontWeight: '700', fontSize: '15px', cursor: (checklist.passportValid && checklist.passportCondition && checklist.addressChecked) ? 'pointer' : 'not-allowed' }}>
              Devam Et â†’
            </button>
          </div>
        )}

        {/* ADIM 3: VÄ°ZE KATEGORÄ°SÄ° SEÃ‡ */}
        {formStep === 'category' && (
          <div>
            <div style={{ background: 'rgba(139,92,246,0.1)', padding: '16px', borderRadius: '12px', marginBottom: '20px', border: '1px solid rgba(139,92,246,0.2)' }}>
              <p style={{ margin: 0, fontSize: '13px', color: '#8b5cf6' }}>ğŸ“‹ AdÄ±m 3/4: Vize TÃ¼rÃ¼ SeÃ§imi</p>
              <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#94a3b8' }}>MÃ¼ÅŸteri: <strong style={{ color: '#fff' }}>{selectedCustomer?.firstName} {selectedCustomer?.lastName}</strong></p>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px' }}>
              {visaCategories.map(cat => (
                <button key={cat.id} onClick={() => selectCategory(cat)} style={{ padding: '20px', background: `rgba(${hexToRgb(cat.color)},0.15)`, border: `1px solid ${cat.color}40`, borderRadius: '12px', cursor: 'pointer', textAlign: 'center' }}>
                  <span style={{ fontSize: '32px', display: 'block', marginBottom: '8px' }}>{cat.icon}</span>
                  <span style={{ fontSize: '14px', fontWeight: '600', color: cat.color }}>{cat.label}</span>
                </button>
              ))}
            </div>
          </div>
        )}

        {/* ADIM 4: DETAYLAR */}
        {formStep === 'details' && selectedCategory && (
          <div>
            <div style={{ background: `rgba(${hexToRgb(selectedCategory.color)},0.1)`, padding: '16px', borderRadius: '12px', marginBottom: '20px', border: `1px solid ${selectedCategory.color}30` }}>
              <p style={{ margin: 0, fontSize: '13px', color: selectedCategory.color }}>{selectedCategory.icon} AdÄ±m 4/4: {selectedCategory.label} Vize DetaylarÄ±</p>
              <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#94a3b8' }}>MÃ¼ÅŸteri: <strong style={{ color: '#fff' }}>{selectedCustomer?.firstName} {selectedCustomer?.lastName}</strong></p>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              {/* Ãœlke SeÃ§imi - Butonlar */}
              <div>
                <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '8px' }}>Ãœlke * {formData.country && <span style={{ color: '#10b981' }}>âœ“ {formData.country}</span>}</label>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px', maxHeight: '180px', overflowY: 'auto', padding: '4px' }}>
                  {selectedCategory.countries.map(c => (
                    <button key={c} type="button" onClick={() => setFormData({...formData, country: c})} style={{ padding: '10px 8px', background: formData.country === c ? 'rgba(16,185,129,0.3)' : 'rgba(255,255,255,0.05)', border: formData.country === c ? '2px solid #10b981' : '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: formData.country === c ? '#10b981' : '#e8f1f8', cursor: 'pointer', fontSize: '12px', fontWeight: formData.country === c ? '600' : '400' }}>
                      {c}
                    </button>
                  ))}
                </div>
              </div>

              {/* Vize TÃ¼rÃ¼ (ayarlardan gelen) */}
              {selectedCategory?.durations && (
                <div>
                  <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '8px' }}>Vize TÃ¼rÃ¼ * {formData.visaDuration && <span style={{ color: selectedCategory.color }}>âœ“ {formData.visaDuration}</span>}</label>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px' }}>
                    {selectedCategory.durations.map((d, idx) => {
                      const duration = typeof d === 'string' ? d : d.name;
                      const price = typeof d === 'object' ? d.price : 0;
                      const currency = typeof d === 'object' ? d.currency : 'â‚¬';
                      return (
                        <button 
                          key={idx} 
                          type="button" 
                          onClick={() => setFormData({
                            ...formData, 
                            visaDuration: duration,
                            visaPrice: price,
                            visaCurrency: currency
                          })} 
                          style={{ 
                            padding: '12px 8px', 
                            background: formData.visaDuration === duration ? `${selectedCategory.color}30` : 'rgba(255,255,255,0.05)', 
                            border: formData.visaDuration === duration ? `2px solid ${selectedCategory.color}` : '1px solid rgba(255,255,255,0.1)', 
                            borderRadius: '8px', 
                            color: formData.visaDuration === duration ? selectedCategory.color : '#e8f1f8', 
                            cursor: 'pointer', 
                            fontSize: '11px', 
                            fontWeight: formData.visaDuration === duration ? '600' : '400',
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '4px',
                            textAlign: 'left'
                          }}
                        >
                          <span>{selectedCategory.icon} {duration}</span>
                          {price > 0 && <span style={{ fontSize: '10px', opacity: 0.7 }}>{price} {currency}</span>}
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* BaÅŸvuru Tarihi ve Ä°ÅŸlem */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                <div>
                  <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>BaÅŸvuru Tarihi</label>
                  <input type="date" value={formData.applicationDate || ''} onChange={e => setFormData({...formData, applicationDate: e.target.value})} style={{ width: '100%', padding: '12px', background: '#0d1f33', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#ffffff', fontSize: '14px', boxSizing: 'border-box' }} />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>Ä°ÅŸlem</label>
                  <select value={formData.processor || ''} onChange={e => setFormData({...formData, processor: e.target.value})} style={{ width: '100%', padding: '12px', background: '#0d1f33', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#ffffff', fontSize: '14px' }}>
                    {(appSettings?.processors || ['Paydos', 'Ä°data', 'OÄŸuz']).map(p => <option key={p} value={p} style={{ background: '#ffffff', color: '#000000' }}>{p}</option>)}
                  </select>
                </div>
              </div>

              {/* Randevu Tarihi ve Saati */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                <div>
                  <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>Randevu Tarihi</label>
                  <input type="date" value={formData.appointmentDate || ''} onChange={e => setFormData({...formData, appointmentDate: e.target.value})} style={{ width: '100%', padding: '12px', background: '#0d1f33', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#ffffff', fontSize: '14px', boxSizing: 'border-box' }} />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>Randevu Saati</label>
                  <input type="time" value={formData.appointmentTime || ''} onChange={e => setFormData({...formData, appointmentTime: e.target.value})} style={{ width: '100%', padding: '12px', background: '#0d1f33', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#ffffff', fontSize: '14px', boxSizing: 'border-box' }} />
                </div>
              </div>

              {/* PNR */}
              <div>
                <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>PNR / Referans No</label>
                <input type="text" value={formData.pnr || ''} onChange={e => setFormData({...formData, pnr: e.target.value})} placeholder="Randevu PNR numarasÄ±" style={{ width: '100%', padding: '12px', background: '#0d1f33', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#ffffff', fontSize: '14px', boxSizing: 'border-box' }} />
              </div>

              {/* Ã–deme Durumu */}
              <div>
                <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '8px' }}>Vize Ãœcreti</label>
                <div style={{ display: 'flex', gap: '8px' }}>
                  {paymentStatuses.map(ps => (
                    <button key={ps} type="button" onClick={() => setFormData({...formData, paymentStatus: ps})} style={{ flex: 1, padding: '10px', background: formData.paymentStatus === ps ? (ps === 'Ã–dendi' ? 'rgba(16,185,129,0.3)' : 'rgba(239,68,68,0.3)') : 'rgba(255,255,255,0.05)', border: formData.paymentStatus === ps ? `2px solid ${ps === 'Ã–dendi' ? '#10b981' : '#ef4444'}` : '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: formData.paymentStatus === ps ? (ps === 'Ã–dendi' ? '#10b981' : '#ef4444') : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: formData.paymentStatus === ps ? '600' : '400' }}>
                      {ps === 'Ã–dendi' ? 'âœ“' : 'âœ—'} {ps}
                    </button>
                  ))}
                </div>
              </div>

              {/* Durum - Butonlar - Dinamik */}
              <div>
                <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '8px' }}>BaÅŸvuru Durumu</label>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                  {(appSettings?.visaStatuses || ['Evrak Topluyor', 'Evrak TamamlandÄ±', 'Randevu AlÄ±ndÄ±', 'BaÅŸvuru YapÄ±ldÄ±', 'SonuÃ§ Bekliyor', 'OnaylandÄ±', 'Reddedildi']).map(s => (
                    <button key={s} type="button" onClick={() => setFormData({...formData, status: s})} style={{ padding: '8px 12px', background: formData.status === s ? 'rgba(245,158,11,0.3)' : 'rgba(255,255,255,0.05)', border: formData.status === s ? '2px solid #f59e0b' : '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: formData.status === s ? '#f59e0b' : '#94a3b8', cursor: 'pointer', fontSize: '11px', fontWeight: formData.status === s ? '600' : '400' }}>
                      {s}
                    </button>
                  ))}
                </div>
              </div>

              {/* Notlar */}
              <div>
                <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>Notlar</label>
                <textarea value={formData.notes || ''} onChange={e => setFormData({...formData, notes: e.target.value})} placeholder="Ek notlar..." style={{ width: '100%', padding: '12px', background: '#0d1f33', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#ffffff', fontSize: '14px', minHeight: '80px', resize: 'vertical', boxSizing: 'border-box' }} />
              </div>

              {/* Ä°letiÅŸim ButonlarÄ± */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                <button type="button" onClick={() => { const phone = formData.customerPhone?.replace(/\D/g, ''); if (phone) window.open(`https://wa.me/90${phone}`, '_blank'); }} style={{ padding: '12px', background: 'rgba(37,211,102,0.2)', border: '1px solid rgba(37,211,102,0.3)', borderRadius: '8px', color: '#25d366', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}>
                  ğŸ’¬ WhatsApp
                </button>
                <button type="button" onClick={() => { if (formData.customerEmail) window.open(`mailto:${formData.customerEmail}`, '_blank'); else alert('E-posta adresi bulunamadÄ±'); }} style={{ padding: '12px', background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '8px', color: '#3b82f6', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}>
                  ğŸ“§ E-posta
                </button>
              </div>

              {/* Randevu Bilgisi GÃ¶nder */}
              {formData.appointmentDate && (
                <button type="button" onClick={() => {
                  if (!formData.customerPhone) { alert('Telefon numarasÄ± bulunamadÄ±!'); return; }
                  let message = appSettings?.whatsappTemplate || 'Randevu: {tarih} {saat}';
                  message = message.replace('{isim}', formData.customerName || '').replace('{ulke}', formData.country || '').replace('{tarih}', formatDate(formData.appointmentDate) || '').replace('{saat}', formData.appointmentTime || '-').replace('{pnr}', formData.pnr || '-');
                  const phone = formData.customerPhone.replace(/\D/g, '');
                  const fullPhone = phone.startsWith('90') ? phone : `90${phone}`;
                  window.open(`https://wa.me/${fullPhone}?text=${encodeURIComponent(message)}`, '_blank');
                }} style={{ width: '100%', padding: '14px', background: 'linear-gradient(135deg, #25d366, #128c7e)', border: 'none', borderRadius: '10px', color: 'white', cursor: 'pointer', fontWeight: '700', fontSize: '14px' }}>
                  ğŸ“± Randevu Bilgisi GÃ¶nder (WhatsApp)
                </button>
              )}
            </div>

            <LoadingButton 
              onClick={handleSubmit} 
              loading={saving}
              style={{ width: '100%', marginTop: '24px', padding: '16px', background: 'linear-gradient(135deg, #10b981, #059669)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '700', fontSize: '15px' }}
            >
              {editingVisa ? 'ğŸ’¾ DeÄŸiÅŸiklikleri Kaydet' : 'âœ… BaÅŸvuruyu Kaydet'}
            </LoadingButton>

            {/* Proforma Ä°ndir - Sadece dÃ¼zenleme modunda */}
            {editingVisa && (
              <div style={{ marginTop: '12px', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                <button 
                  type="button"
                  onClick={() => generateProforma(formData)}
                  style={{ 
                    padding: '14px', 
                    background: 'linear-gradient(135deg, #f59e0b, #d97706)', 
                    border: 'none', 
                    borderRadius: '10px', 
                    color: 'white', 
                    cursor: 'pointer', 
                    fontWeight: '600', 
                    fontSize: '13px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '6px'
                  }}
                >
                  ğŸ“„ Proforma Ä°ndir
                </button>
                <button 
                  type="button"
                  onClick={() => sendProformaWhatsApp(formData)}
                  style={{ 
                    padding: '14px', 
                    background: 'linear-gradient(135deg, #25d366, #128c7e)', 
                    border: 'none', 
                    borderRadius: '10px', 
                    color: 'white', 
                    cursor: 'pointer', 
                    fontWeight: '600', 
                    fontSize: '13px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '6px'
                  }}
                >
                  ğŸ’¬ Proforma GÃ¶nder
                </button>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );

  return (
    <div style={{ padding: isMobile ? '16px' : '24px' }}>
      {/* Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}>
        <h2 style={{ fontSize: '20px', margin: 0 }}>ğŸŒ Vize BaÅŸvurularÄ± ({visaApplications.length})</h2>
        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
          <button onClick={exportToExcel} style={{ background: 'rgba(16,185,129,0.2)', border: '1px solid rgba(16,185,129,0.3)', borderRadius: '10px', padding: '10px 16px', color: '#10b981', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>ğŸ“¥ Excel</button>
          <button onClick={openNewForm} style={{ background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: '#0c1929', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>â• Yeni BaÅŸvuru</button>
        </div>
      </div>

      {/* Arama Kutusu */}
      <div style={{ marginBottom: '16px' }}>
        <div style={{ position: 'relative' }}>
          <input
            type="text"
            value={visaSearchQuery}
            onChange={e => setVisaSearchQuery(e.target.value)}
            placeholder="ğŸ” MÃ¼ÅŸteri adÄ±, telefon, Ã¼lke veya PNR ile ara..."
            style={{ width: '100%', padding: '12px 16px', paddingRight: visaSearchQuery ? '40px' : '16px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }}
          />
          {visaSearchQuery && (
            <button onClick={() => setVisaSearchQuery('')} style={{ position: 'absolute', right: '12px', top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', color: '#94a3b8', cursor: 'pointer', fontSize: '18px' }}>Ã—</button>
          )}
        </div>
        {visaSearchQuery.length >= 2 && (
          <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#64748b' }}>
            {filteredVisaApplications.length} sonuÃ§ bulundu
          </p>
        )}
      </div>

      {/* Sekmeler */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '8px', marginBottom: '16px' }}>
        <button onClick={() => setActiveTab('calendar')} style={{ padding: '12px', background: activeTab === 'calendar' ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'calendar' ? '1px solid rgba(245,158,11,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'calendar' ? '#f59e0b' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'calendar' ? '600' : '400' }}>
          ğŸ“… Takvim
        </button>
        <button onClick={() => setActiveTab('reminders')} style={{ padding: '12px', background: activeTab === 'reminders' ? 'rgba(239,68,68,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'reminders' ? '1px solid rgba(239,68,68,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'reminders' ? '#ef4444' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'reminders' ? '600' : '400' }}>
          â° HatÄ±rlatmalar ({upcomingReminders.length})
        </button>
        <button onClick={() => setActiveTab('all')} style={{ padding: '12px', background: activeTab === 'all' ? 'rgba(59,130,246,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'all' ? '1px solid rgba(59,130,246,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'all' ? '#3b82f6' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'all' ? '600' : '400' }}>
          ğŸ“‹ TÃ¼m BaÅŸvurular
        </button>
      </div>

      {/* TAKVÄ°M */}
      {activeTab === 'calendar' && (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
            <button onClick={() => { if (calendarMonth === 0) { setCalendarMonth(11); setCalendarYear(calendarYear - 1); } else { setCalendarMonth(calendarMonth - 1); } }} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '8px 12px', color: '#e8f1f8', cursor: 'pointer' }}>â†</button>
            <span style={{ fontSize: '14px', color: '#94a3b8' }}>{calendarYear}</span>
            <button onClick={() => { if (calendarMonth === 11) { setCalendarMonth(0); setCalendarYear(calendarYear + 1); } else { setCalendarMonth(calendarMonth + 1); } }} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '8px 12px', color: '#e8f1f8', cursor: 'pointer' }}>â†’</button>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '12px' }}>
            {renderCalendar(month1Days, monthNames[calendarMonth], calendarYear)}
            {renderCalendar(month2Days, monthNames[month2Month], month2Year)}
          </div>
        </div>
      )}

      {/* HATIRLATMALAR */}
      {activeTab === 'reminders' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          {upcomingReminders.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>10 gÃ¼n iÃ§inde randevu yok ğŸ‰</p>
          ) : (
            upcomingReminders.map(v => {
              const cat = getCategoryInfo(v.category);
              const daysLeft = getDaysLeft(v.appointmentDate);
              return (
                <div key={v.id} onClick={() => setSelectedVisa(v)} style={{ background: daysLeft <= 3 ? 'rgba(239,68,68,0.15)' : 'rgba(245,158,11,0.1)', padding: '14px', borderRadius: '10px', border: daysLeft <= 3 ? '1px solid rgba(239,68,68,0.3)' : '1px solid rgba(245,158,11,0.2)', cursor: 'pointer' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                    <div>
                      <h4 style={{ margin: 0, fontSize: '14px' }}>{cat.icon} {v.customerName}</h4>
                      <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#94a3b8' }}>{formatDate(v.appointmentDate)} {v.appointmentTime && `â€¢ ${v.appointmentTime}`}</p>
                      <p style={{ margin: '4px 0 0', fontSize: '11px', color: '#64748b' }}>{v.country} - {v.visaType}</p>
                    </div>
                    <span style={{ fontSize: '11px', padding: '4px 10px', borderRadius: '8px', background: daysLeft <= 3 ? 'rgba(239,68,68,0.3)' : 'rgba(245,158,11,0.3)', color: daysLeft <= 3 ? '#ef4444' : '#f59e0b', fontWeight: '600' }}>
                      {daysLeft === 0 ? 'BUGÃœN!' : `${daysLeft} gÃ¼n`}
                    </span>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {/* TÃœM BAÅVURULAR */}
      {activeTab === 'all' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          {filteredVisaApplications.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>{visaSearchQuery ? 'SonuÃ§ bulunamadÄ±' : 'HenÃ¼z baÅŸvuru yok'}</p>
          ) : (
            filteredVisaApplications.map(v => {
              const cat = getCategoryInfo(v.category);
              return (
                <div key={v.id} onClick={() => setSelectedVisa(v)} style={{ background: 'rgba(255,255,255,0.03)', padding: '14px', borderRadius: '10px', border: '1px solid rgba(255,255,255,0.05)', cursor: 'pointer' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                    <div>
                      <h4 style={{ margin: 0, fontSize: '14px' }}>{cat.icon} {v.customerName}</h4>
                      <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#94a3b8' }}>{v.country} - {v.visaType} {v.visaDuration && `(${v.visaDuration})`}</p>
                      {v.appointmentDate && <p style={{ margin: '4px 0 0', fontSize: '11px', color: '#64748b' }}>ğŸ“… {formatDate(v.appointmentDate)} {v.pnr && `â€¢ PNR: ${v.pnr}`}</p>}
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '4px' }}>
                      <span style={{ fontSize: '10px', padding: '4px 8px', borderRadius: '6px', background: `${getStatusColor(v.status)}20`, color: getStatusColor(v.status) }}>{v.status}</span>
                      {v.paymentStatus && <span style={{ fontSize: '9px', padding: '2px 6px', borderRadius: '4px', background: v.paymentStatus === 'Ã–dendi' ? 'rgba(16,185,129,0.2)' : 'rgba(239,68,68,0.2)', color: v.paymentStatus === 'Ã–dendi' ? '#10b981' : '#ef4444' }}>{v.paymentStatus}</span>}
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {/* FORM */}
      {showForm && renderForm()}

      {/* GÃœN DETAY MODAL */}
      {dayDetailModal && (
        <div onClick={() => setDayDetailModal(null)} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 400, padding: '20px' }}>
          <div onClick={e => e.stopPropagation()} style={{ background: 'linear-gradient(135deg, #0c1929, #1a3a5c)', borderRadius: '16px', padding: '20px', maxWidth: '400px', width: '100%', maxHeight: '80vh', overflow: 'auto' }}>
            <h3 style={{ margin: '0 0 16px', fontSize: '16px' }}>ğŸ“… {formatDate(dayDetailModal.date)}</h3>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {dayDetailModal.appointments.map(v => {
                const cat = getCategoryInfo(v.category);
                return (
                  <div key={v.id} onClick={() => { setDayDetailModal(null); setSelectedVisa(v); }} style={{ background: 'rgba(255,255,255,0.05)', padding: '12px', borderRadius: '10px', cursor: 'pointer' }}>
                    <h4 style={{ margin: 0, fontSize: '14px' }}>{cat.icon} {v.customerName}</h4>
                    <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#94a3b8' }}>{v.appointmentTime || '-'} â€¢ {v.country}</p>
                    <span style={{ fontSize: '10px', padding: '2px 6px', borderRadius: '4px', background: `${getStatusColor(v.status)}20`, color: getStatusColor(v.status) }}>{v.status}</span>
                  </div>
                );
              })}
            </div>
            <button onClick={() => setDayDetailModal(null)} style={{ width: '100%', marginTop: '16px', padding: '12px', background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '10px', color: '#e8f1f8', cursor: 'pointer' }}>Kapat</button>
          </div>
        </div>
      )}

      {/* BAÅVURU DETAY MODAL */}
      {selectedVisa && (
        <div onClick={() => setSelectedVisa(null)} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 400, padding: '20px' }}>
          <div onClick={e => e.stopPropagation()} style={{ background: 'linear-gradient(135deg, #0c1929, #1a3a5c)', borderRadius: '16px', padding: '20px', maxWidth: '400px', width: '100%', maxHeight: '85vh', overflow: 'auto' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '16px' }}>
              <div>
                <h3 style={{ margin: 0, fontSize: '18px' }}>{getCategoryInfo(selectedVisa.category).icon} {selectedVisa.customerName}</h3>
                <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>{selectedVisa.customerPhone}</p>
              </div>
              <span style={{ fontSize: '11px', padding: '4px 10px', borderRadius: '8px', background: `${getStatusColor(selectedVisa.status)}20`, color: getStatusColor(selectedVisa.status) }}>{selectedVisa.status}</span>
            </div>
            
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '16px' }}>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                <div style={{ background: 'rgba(255,255,255,0.05)', padding: '10px', borderRadius: '8px' }}>
                  <p style={{ margin: 0, fontSize: '10px', color: '#64748b' }}>Ãœlke</p>
                  <p style={{ margin: '2px 0 0', fontSize: '14px' }}>{selectedVisa.country}</p>
                </div>
                <div style={{ background: 'rgba(255,255,255,0.05)', padding: '10px', borderRadius: '8px' }}>
                  <p style={{ margin: 0, fontSize: '10px', color: '#64748b' }}>Vize TÃ¼rÃ¼</p>
                  <p style={{ margin: '2px 0 0', fontSize: '14px' }}>{selectedVisa.visaType}</p>
                </div>
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                <div style={{ background: 'rgba(255,255,255,0.05)', padding: '10px', borderRadius: '8px' }}>
                  <p style={{ margin: 0, fontSize: '10px', color: '#64748b' }}>BaÅŸvuru Tarihi</p>
                  <p style={{ margin: '2px 0 0', fontSize: '14px' }}>{formatDate(selectedVisa.applicationDate) || '-'}</p>
                </div>
                <div style={{ background: 'rgba(255,255,255,0.05)', padding: '10px', borderRadius: '8px' }}>
                  <p style={{ margin: 0, fontSize: '10px', color: '#64748b' }}>Ä°ÅŸlem</p>
                  <p style={{ margin: '2px 0 0', fontSize: '14px' }}>{selectedVisa.processor || '-'}</p>
                </div>
              </div>
              {selectedVisa.appointmentDate && (
                <div style={{ background: 'rgba(59,130,246,0.1)', padding: '10px', borderRadius: '8px', border: '1px solid rgba(59,130,246,0.2)' }}>
                  <p style={{ margin: 0, fontSize: '10px', color: '#3b82f6' }}>ğŸ“… Randevu</p>
                  <p style={{ margin: '2px 0 0', fontSize: '14px', fontWeight: '600' }}>{formatDate(selectedVisa.appointmentDate)} {selectedVisa.appointmentTime && `â€¢ ${selectedVisa.appointmentTime}`}</p>
                  {selectedVisa.pnr && <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#94a3b8' }}>PNR: {selectedVisa.pnr}</p>}
                </div>
              )}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                <div style={{ background: `rgba(${selectedVisa.paymentStatus === 'Ã–dendi' ? '16,185,129' : '239,68,68'},0.1)`, padding: '10px', borderRadius: '8px' }}>
                  <p style={{ margin: 0, fontSize: '10px', color: '#64748b' }}>Vize Ãœcreti</p>
                  <p style={{ margin: '2px 0 0', fontSize: '14px', color: selectedVisa.paymentStatus === 'Ã–dendi' ? '#10b981' : '#ef4444' }}>{selectedVisa.paymentStatus || 'Ã–denmedi'}</p>
                </div>
                <div style={{ background: 'rgba(255,255,255,0.05)', padding: '10px', borderRadius: '8px' }}>
                  <p style={{ margin: 0, fontSize: '10px', color: '#64748b' }}>Durum</p>
                  <p style={{ margin: '2px 0 0', fontSize: '14px', color: getStatusColor(selectedVisa.status) }}>{selectedVisa.status}</p>
                </div>
              </div>
              {selectedVisa.notes && (
                <div style={{ background: 'rgba(255,255,255,0.05)', padding: '10px', borderRadius: '8px' }}>
                  <p style={{ margin: 0, fontSize: '10px', color: '#64748b' }}>Notlar</p>
                  <p style={{ margin: '2px 0 0', fontSize: '13px' }}>{selectedVisa.notes}</p>
                </div>
              )}
            </div>

            {/* Ä°letiÅŸim ButonlarÄ± */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '8px', marginBottom: '12px' }}>
              <button onClick={() => sendWhatsApp(selectedVisa)} style={{ padding: '10px', background: 'rgba(37,211,102,0.2)', border: '1px solid rgba(37,211,102,0.3)', borderRadius: '8px', color: '#25d366', cursor: 'pointer', fontSize: '12px' }}>ğŸ’¬ WhatsApp</button>
              <button onClick={() => sendEmail(selectedVisa)} style={{ padding: '10px', background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '8px', color: '#3b82f6', cursor: 'pointer', fontSize: '12px' }}>ğŸ“§ E-posta</button>
              <button onClick={() => generateProforma(selectedVisa)} style={{ padding: '10px', background: 'rgba(245,158,11,0.2)', border: '1px solid rgba(245,158,11,0.3)', borderRadius: '8px', color: '#f59e0b', cursor: 'pointer', fontSize: '12px' }}>ğŸ“„ Proforma</button>
            </div>

            {/* Randevu Bilgisi GÃ¶nder */}
            {selectedVisa.appointmentDate && (
              <button onClick={() => sendWhatsAppReminder(selectedVisa)} style={{ width: '100%', padding: '12px', background: 'linear-gradient(135deg, #25d366, #128c7e)', border: 'none', borderRadius: '10px', color: 'white', cursor: 'pointer', fontWeight: '600', fontSize: '13px', marginBottom: '12px' }}>
                ğŸ“± Randevu Bilgisi GÃ¶nder (WhatsApp)
              </button>
            )}

            <div style={{ display: 'flex', gap: '8px' }}>
              <button onClick={() => { setSelectedVisa(null); openEditVisa(selectedVisa); }} style={{ flex: 1, padding: '12px', background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '10px', color: '#3b82f6', cursor: 'pointer', fontWeight: '600' }}>âœï¸ DÃ¼zenle</button>
              <button onClick={() => deleteVisa(selectedVisa.id)} style={{ flex: 1, padding: '12px', background: 'rgba(239,68,68,0.2)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '10px', color: '#ef4444', cursor: 'pointer', fontWeight: '600' }}>ğŸ—‘ï¸ Sil</button>
            </div>
            <button onClick={() => setSelectedVisa(null)} style={{ width: '100%', marginTop: '8px', padding: '12px', background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '10px', color: '#e8f1f8', cursor: 'pointer' }}>Kapat</button>
          </div>
        </div>
      )}
    </div>
  );
}

// TEKLÄ°F & PROFORMA MODÃœLÃœ
function QuotesModule({ quotes, setQuotes, customers, isMobile, showToast }) {
  const [showForm, setShowForm] = useState(false);
  const [viewingQuote, setViewingQuote] = useState(null);
  const [filterType, setFilterType] = useState('all'); // all, teklif, proforma
  const [searchQuery, setSearchQuery] = useState('');
  const [formStep, setFormStep] = useState('type'); // type, customer, details
  const [formData, setFormData] = useState({
    type: '', // 'teklif' veya 'proforma'
    customer: null,
    subject: '',
    optionDate: '',
    currency: 'EUR',
    items: [{ service: '', description: '', quantity: 1, unitPrice: 0 }],
    subtotal: 0,
    vatIncluded: false,
    vatRate: 20,
    discount: 0,
    total: 0,
    notes: ''
  });
  const [customerSearchQuery, setCustomerSearchQuery] = useState('');

  const emptyForm = {
    type: '', customer: null, subject: '', optionDate: '', currency: 'EUR',
    items: [{ service: '', description: '', quantity: 1, unitPrice: 0 }],
    subtotal: 0, vatIncluded: false, vatRate: 20, discount: 0, total: 0, notes: ''
  };

  const calculateTotal = () => {
    const subtotal = formData.items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
    const vatAmount = formData.vatIncluded ? (subtotal * formData.vatRate / 100) : 0;
    const total = subtotal + vatAmount - formData.discount;
    setFormData({ ...formData, subtotal, total });
  };

  const generatePDF = (quote) => {
    try {
      const doc = new jsPDF();
      
      // TÃ¼rkÃ§e karakter Ã§evirme fonksiyonu
      const toTurkishChars = (text) => {
        if (!text) return '';
        return text
          .replace(/Ä±/g, 'i').replace(/Ä°/g, 'I')
          .replace(/ÄŸ/g, 'g').replace(/Ä/g, 'G')
          .replace(/Ã¼/g, 'u').replace(/Ãœ/g, 'U')
          .replace(/ÅŸ/g, 's').replace(/Å/g, 'S')
          .replace(/Ã¶/g, 'o').replace(/Ã–/g, 'O')
          .replace(/Ã§/g, 'c').replace(/Ã‡/g, 'C');
      };
      
      // Logo ve BaÅŸlÄ±k
      doc.setFontSize(20);
      doc.setTextColor(220, 53, 69);
      doc.text('Paydos Tur', 20, 20);
      
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text('Paydos Turizm Ve Seyahat Acentaligi Sanayi Ve Ticaret Limited Sirketi', 20, 28);
      doc.text('Mehmetcik Mahallesi Ulus Caddesi No: 124/1 Denizli / Turkiye', 20, 33);
    doc.text('Tax: Pamukkale VD 7230433632 | Tel: 0 258 263 71 76', 20, 38);
    
    // Teklif/Proforma BaÅŸlÄ±k
    doc.setFontSize(24);
    doc.setTextColor(220, 53, 69);
    doc.text(quote.type === 'teklif' ? 'TEKLIF' : 'PROFORMA FATURA', 150, 20);
    
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(quote.number, 150, 28);
    
    // Bilgiler
    doc.setFontSize(10);
    doc.setTextColor(60);
    doc.text('TARIH', 20, 50);
    doc.text('OPSIYON TARIHI', 70, 50);
    doc.text('PARA BIRIMI', 120, 50);
    doc.text('HAZIRLAYAN', 150, 50);
    
    doc.setTextColor(0);
    doc.text(new Date(quote.createdAt).toLocaleDateString('tr-TR'), 20, 56);
    doc.text(quote.optionDate ? new Date(quote.optionDate).toLocaleDateString('tr-TR') : '-', 70, 56);
    doc.text(quote.currency, 120, 56);
    doc.text(toTurkishChars(quote.createdBy || 'Onder Tasci'), 150, 56);
    
    // Konu
    doc.setTextColor(60);
    doc.text('KONU', 20, 66);
    doc.setTextColor(0);
    doc.text(toTurkishChars(quote.subject), 20, 72);
    
    // MÃ¼ÅŸteri Bilgileri
    doc.setFontSize(12);
    doc.setTextColor(220, 53, 69);
    doc.text('MUSTERI BILGILERI', 20, 85);
    
    doc.setFontSize(10);
    doc.setTextColor(60);
    doc.text('Firma / Ad Soyad', 20, 93);
    if (quote.type === 'proforma') {
      doc.text('Vergi Dairesi', 110, 93);
    } else {
      doc.text('Yetkili Kisi', 110, 93);
    }
    
    doc.setTextColor(0);
    doc.text(toTurkishChars(`${quote.customer.firstName} ${quote.customer.lastName}`), 20, 99);
    doc.text('-', 110, 99);
    
    doc.setTextColor(60);
    doc.text('Telefon', 20, 107);
    doc.text('E-posta', 110, 107);
    
    doc.setTextColor(0);
    doc.text(quote.customer.phone || '-', 20, 113);
    doc.text(quote.customer.email || '-', 110, 113);
    
    // Hizmet Kalemleri Tablosu
    doc.setFontSize(12);
    doc.setTextColor(220, 53, 69);
    doc.text('HIZMET KALEMLERI', 20, 126);
    
    const tableData = quote.items.map(item => [
      item.service,
      item.description,
      item.quantity.toString(),
      item.unitPrice.toFixed(2),
      (item.quantity * item.unitPrice).toFixed(2)
    ]);
    
    // Manuel tablo Ã§izimi (autoTable yerine)
    let currentY = 132;
    
    // Tablo baÅŸlÄ±ÄŸÄ±
    doc.setFillColor(31, 41, 55);
    doc.rect(20, currentY, 170, 8, 'F');
    doc.setFontSize(9);
    doc.setTextColor(255);
    doc.text('HIZMET', 22, currentY + 5);
    doc.text('ACIKLAMA', 62, currentY + 5);
    doc.text('ADET', 125, currentY + 5);
    doc.text('BIRIM', 145, currentY + 5);
    doc.text('TOPLAM', 170, currentY + 5);
    currentY += 8;
    
    // Tablo satÄ±rlarÄ±
    doc.setTextColor(0);
    quote.items.forEach((item, idx) => {
      if (idx % 2 === 0) {
        doc.setFillColor(245, 245, 245);
        doc.rect(20, currentY, 170, 7, 'F');
      }
      doc.text(toTurkishChars(item.service.substring(0, 15)), 22, currentY + 5);
      doc.text(toTurkishChars(item.description.substring(0, 25)), 62, currentY + 5);
      doc.text(item.quantity.toString(), 130, currentY + 5);
      doc.text(item.unitPrice.toFixed(2), 150, currentY + 5);
      doc.text((item.quantity * item.unitPrice).toFixed(2), 175, currentY + 5);
      currentY += 7;
    });
    
    // Hesaplamalar
    const finalY = currentY + 10;
    
    doc.setFontSize(10);
    doc.setTextColor(60);
    doc.text('Ara Toplam:', 130, finalY);
    doc.setTextColor(0);
    doc.text(`${quote.subtotal.toFixed(2)} ${quote.currency}`, 180, finalY, { align: 'right' });
    
    if (quote.vatIncluded) {
      doc.setTextColor(60);
      doc.text(`KDV (${quote.vatRate}%):`, 130, finalY + 6);
      doc.setTextColor(0);
      doc.text(`${(quote.subtotal * quote.vatRate / 100).toFixed(2)} ${quote.currency}`, 180, finalY + 6, { align: 'right' });
    }
    
    if (quote.discount > 0) {
      doc.setTextColor(60);
      doc.text('Indirim:', 130, finalY + (quote.vatIncluded ? 12 : 6));
      doc.setTextColor(0);
      doc.text(`-${quote.discount.toFixed(2)} ${quote.currency}`, 180, finalY + (quote.vatIncluded ? 12 : 6), { align: 'right' });
    }
    
    // Toplam
    const totalY = finalY + (quote.vatIncluded ? 18 : 12) + (quote.discount > 0 ? 6 : 0);
    doc.setFillColor(220, 53, 69);
    doc.rect(120, totalY - 5, 70, 12, 'F');
    doc.setFontSize(12);
    doc.setTextColor(255);
    doc.text('TOPLAM:', 130, totalY + 2);
    doc.text(`${quote.total.toFixed(2)} ${quote.currency}`, 180, totalY + 2, { align: 'right' });
    
    // Banka Bilgileri (Sadece Proforma iÃ§in)
    if (quote.type === 'proforma') {
      const bankY = totalY + 15;
      doc.setFontSize(11);
      doc.setTextColor(220, 53, 69);
      doc.text('BANKA BILGILERI', 20, bankY);
      
      doc.setFontSize(9);
      doc.setTextColor(60);
      doc.text('Garanti Bankasi A.S. - Denizli Cinar Subesi (781)', 20, bankY + 6);
      doc.text('Hesap Sahibi: Paydos Turizm Seyahat ve Acenteligi San. Tic. Ltd. Sti.', 20, bankY + 11);
      
      doc.setTextColor(0);
      doc.text('IBAN (TL):', 20, bankY + 18);
      doc.text('TR40 0006 2000 7810 0006 2962 46', 50, bankY + 18);
      
      doc.text('IBAN (EUR):', 20, bankY + 23);
      doc.text('TR73 0006 2000 7810 0009 0910 95', 50, bankY + 23);
      
      doc.text('IBAN (USD):', 20, bankY + 28);
      doc.text('TR46 0006 2000 7810 0009 0910 96', 50, bankY + 28);
    }
    
    // Notlar
    if (quote.notes) {
      const notesY = quote.type === 'proforma' ? totalY + 50 : totalY + 15;
      doc.setFontSize(11);
      doc.setTextColor(220, 53, 69);
      doc.text('NOTLAR', 20, notesY);
      
      doc.setFontSize(9);
      doc.setTextColor(0);
      const splitNotes = doc.splitTextToSize(toTurkishChars(quote.notes), 170);
      doc.text(splitNotes, 20, notesY + 6);
    }
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(100);
    const footerText = quote.type === 'teklif' 
      ? 'â€¢ Bu teklif opsiyon tarihine kadar gecerlidir. â€¢ Fiyatlar doviz kuruna gore degisiklik gosterebilir.'
      : 'Bu proforma fatura bilgi amaclidir ve yasal belge niteligi tasimaz.';
    doc.text(footerText, 105, 285, { align: 'center' });
    doc.text('www.paydosturizm.com', 105, 290, { align: 'center' });
    
    return doc;
    } catch (error) {
      console.error('PDF oluÅŸturma hatasÄ±:', error);
      throw new Error('PDF oluÅŸturulamadÄ±: ' + error.message);
    }
  };

  const downloadPDF = (quote) => {
    try {
      console.log('PDF oluÅŸturuluyor...', quote);
      const doc = generatePDF(quote);
      doc.save(`${quote.number}.pdf`);
      showToast?.('PDF indirildi', 'success');
    } catch (error) {
      console.error('PDF oluÅŸturma hatasÄ±:', error);
      showToast?.('PDF oluÅŸturma hatasÄ±: ' + error.message, 'error');
    }
  };

  const sendWhatsApp = async (quote) => {
    try {
      console.log('WhatsApp gÃ¶nderiliyor...', quote);
      const message = `Merhaba ${quote.customer.firstName},\n\n${quote.type === 'teklif' ? 'Teklifiniz' : 'Proforma faturanÄ±z'} hazÄ±r.\n\nBelge No: ${quote.number}\nToplam: ${quote.total.toFixed(2)} ${quote.currency}`;
      
      const phone = quote.customer.phone?.replace(/\D/g, '');
      if (!phone) {
        showToast?.('MÃ¼ÅŸterinin telefon numarasÄ± yok!', 'error');
        return;
      }
      
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
      showToast?.('WhatsApp aÃ§Ä±ldÄ±', 'success');
    } catch (error) {
      console.error('WhatsApp hatasÄ±:', error);
      showToast?.('WhatsApp hatasÄ±: ' + error.message, 'error');
    }
  };

  const sendEmail = (quote) => {
    try {
      console.log('E-posta gÃ¶nderiliyor...', quote);
      const subject = `${quote.type === 'teklif' ? 'Teklif' : 'Proforma Fatura'} - ${quote.subject}`;
      const body = `Merhaba ${quote.customer.firstName} ${quote.customer.lastName},\n\n${quote.type === 'teklif' ? 'Teklifiniz' : 'Proforma faturanÄ±z'} ektedir.\n\nBelge No: ${quote.number}\nToplam: ${quote.total.toFixed(2)} ${quote.currency}\n\nÄ°yi gÃ¼nler dileriz.\n\nPaydos Turizm`;
      
      if (!quote.customer.email) {
        showToast?.('MÃ¼ÅŸterinin e-posta adresi yok!', 'error');
        return;
      }
      
      window.location.href = `mailto:${quote.customer.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      showToast?.('E-posta istemcisi aÃ§Ä±ldÄ±', 'success');
    } catch (error) {
      console.error('E-posta hatasÄ±:', error);
      showToast?.('E-posta hatasÄ±: ' + error.message, 'error');
    }
  };

  const addItem = () => {
    setFormData({ ...formData, items: [...formData.items, { service: '', description: '', quantity: 1, unitPrice: 0 }] });
  };

  const removeItem = (index) => {
    if (formData.items.length > 1) {
      setFormData({ ...formData, items: formData.items.filter((_, i) => i !== index) });
    }
  };

  const updateItem = (index, field, value) => {
    const updated = formData.items.map((item, i) => i === index ? { ...item, [field]: value } : item);
    setFormData({ ...formData, items: updated });
  };

  const resetForm = () => {
    setFormData(emptyForm);
    setFormStep('type');
    setShowForm(false);
    setSearchQuery('');
  };

  const handleSave = () => {
    if (!formData.type || !formData.customer || !formData.subject) {
      alert('TÃ¼r, mÃ¼ÅŸteri ve konu zorunludur!');
      return;
    }

    const newQuote = {
      ...formData,
      id: Date.now(),
      number: `${formData.type === 'teklif' ? 'TKL' : 'PF'}-${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-${String(quotes.length + 1).padStart(3, '0')}`,
      createdAt: new Date().toISOString(),
      createdBy: 'Ã–nder TaÅŸcÄ±'
    };

    setQuotes([...quotes, newQuote]);
    showToast?.(`${formData.type === 'teklif' ? 'Teklif' : 'Proforma'} oluÅŸturuldu`, 'success');
    resetForm();
  };

  const searchResults = customerSearchQuery.length >= 2
    ? customers.filter(c =>
        `${c.firstName} ${c.lastName}`.toLowerCase().includes(customerSearchQuery.toLowerCase()) ||
        c.phone?.includes(customerSearchQuery) ||
        c.email?.toLowerCase().includes(customerSearchQuery.toLowerCase())
      ).slice(0, 10)
    : [];

  const filteredQuotes = quotes
    .filter(q => filterType === 'all' || q.type === filterType)
    .filter(q => 
      searchQuery.length < 2 || 
      q.subject?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      q.number?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      `${q.customer?.firstName} ${q.customer?.lastName}`.toLowerCase().includes(searchQuery.toLowerCase())
    );

  useEffect(() => {
    calculateTotal();
  }, [formData.items, formData.vatIncluded, formData.vatRate, formData.discount]);

  // GÃ¶rÃ¼ntÃ¼leme Modal
  if (viewingQuote) {
    return (
      <div style={{ position: 'fixed', inset: 0, background: 'linear-gradient(180deg, #0a1628 0%, #132742 50%, #0a1628 100%)', zIndex: 300, overflow: 'auto' }}>
        <div style={{ position: 'sticky', top: 0, background: 'rgba(10,22,40,0.98)', backdropFilter: 'blur(20px)', borderBottom: '1px solid rgba(255,255,255,0.08)', padding: '16px 20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', zIndex: 10 }}>
          <button onClick={() => setViewingQuote(null)} style={{ background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', padding: '10px 16px', color: '#e8f1f8', cursor: 'pointer', fontSize: '14px' }}>â† Geri</button>
          <h2 style={{ margin: 0, fontSize: '16px', color: '#ffffff' }}>{viewingQuote.type === 'teklif' ? 'ğŸ“ Teklif' : 'ğŸ’° Proforma'}</h2>
          <div style={{ width: '70px' }}></div>
        </div>

        <div style={{ padding: '20px', maxWidth: '900px', margin: '0 auto' }}>
          <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(255,255,255,0.05)' }}>
            {/* Header Info */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '24px', paddingBottom: '16px', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
              <div>
                <h3 style={{ margin: '0 0 8px', fontSize: '20px', color: '#ffffff' }}>{viewingQuote.subject}</h3>
                <p style={{ margin: 0, fontSize: '13px', color: '#64748b' }}>Belge No: {viewingQuote.number}</p>
              </div>
              <div style={{ textAlign: 'right' }}>
                <p style={{ margin: '0 0 4px', fontSize: '12px', color: '#64748b' }}>MÃ¼ÅŸteri</p>
                <p style={{ margin: 0, fontSize: '14px', color: '#e8f1f8', fontWeight: '600' }}>{viewingQuote.customer.firstName} {viewingQuote.customer.lastName}</p>
              </div>
            </div>

            {/* Ä°temler */}
            <div style={{ marginBottom: '24px' }}>
              <h4 style={{ margin: '0 0 12px', fontSize: '14px', color: '#94a3b8' }}>Hizmet Kalemleri</h4>
              {viewingQuote.items.map((item, idx) => (
                <div key={idx} style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '2fr 3fr 80px 100px 100px', gap: '12px', padding: '12px', background: 'rgba(0,0,0,0.2)', borderRadius: '8px', marginBottom: '8px' }}>
                  <div>
                    <span style={{ fontSize: '11px', color: '#64748b', display: 'block' }}>Hizmet</span>
                    <span style={{ fontSize: '13px', color: '#e8f1f8' }}>{item.service}</span>
                  </div>
                  <div>
                    <span style={{ fontSize: '11px', color: '#64748b', display: 'block' }}>AÃ§Ä±klama</span>
                    <span style={{ fontSize: '13px', color: '#e8f1f8' }}>{item.description}</span>
                  </div>
                  <div>
                    <span style={{ fontSize: '11px', color: '#64748b', display: 'block' }}>Adet</span>
                    <span style={{ fontSize: '13px', color: '#e8f1f8' }}>{item.quantity}</span>
                  </div>
                  <div>
                    <span style={{ fontSize: '11px', color: '#64748b', display: 'block' }}>Birim</span>
                    <span style={{ fontSize: '13px', color: '#e8f1f8' }}>{item.unitPrice.toFixed(2)}</span>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <span style={{ fontSize: '11px', color: '#64748b', display: 'block' }}>Toplam</span>
                    <span style={{ fontSize: '13px', color: '#10b981', fontWeight: '600' }}>{(item.quantity * item.unitPrice).toFixed(2)}</span>
                  </div>
                </div>
              ))}
            </div>

            {/* Totals */}
            <div style={{ background: 'rgba(0,0,0,0.3)', padding: '20px', borderRadius: '12px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                <span style={{ fontSize: '13px', color: '#94a3b8' }}>Ara Toplam:</span>
                <span style={{ fontSize: '14px', color: '#e8f1f8' }}>{viewingQuote.subtotal.toFixed(2)} {viewingQuote.currency}</span>
              </div>
              {viewingQuote.vatIncluded && (
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                  <span style={{ fontSize: '13px', color: '#94a3b8' }}>KDV ({viewingQuote.vatRate}%):</span>
                  <span style={{ fontSize: '14px', color: '#f59e0b' }}>+{(viewingQuote.subtotal * viewingQuote.vatRate / 100).toFixed(2)} {viewingQuote.currency}</span>
                </div>
              )}
              {viewingQuote.discount > 0 && (
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                  <span style={{ fontSize: '13px', color: '#94a3b8' }}>Ä°ndirim:</span>
                  <span style={{ fontSize: '14px', color: '#ef4444' }}>-{viewingQuote.discount.toFixed(2)} {viewingQuote.currency}</span>
                </div>
              )}
              <div style={{ borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: '12px', marginTop: '12px', display: 'flex', justifyContent: 'space-between' }}>
                <span style={{ fontSize: '16px', color: '#ffffff', fontWeight: '700' }}>TOPLAM:</span>
                <span style={{ fontSize: '20px', color: '#10b981', fontWeight: '700' }}>{viewingQuote.total.toFixed(2)} {viewingQuote.currency}</span>
              </div>
            </div>

            {viewingQuote.notes && (
              <div style={{ marginTop: '20px', padding: '16px', background: 'rgba(59,130,246,0.1)', borderRadius: '12px', border: '1px solid rgba(59,130,246,0.2)' }}>
                <p style={{ margin: '0 0 8px', fontSize: '12px', color: '#3b82f6', fontWeight: '600' }}>Notlar:</p>
                <p style={{ margin: 0, fontSize: '13px', color: '#e8f1f8', whiteSpace: 'pre-wrap' }}>{viewingQuote.notes}</p>
              </div>
            )}
          </div>
        </div>

        {/* Footer Buttons */}
        <div style={{ position: 'fixed', bottom: 0, left: 0, right: 0, background: 'rgba(10,22,40,0.98)', backdropFilter: 'blur(20px)', borderTop: '1px solid rgba(255,255,255,0.08)', padding: '16px 20px', display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
          <button onClick={() => downloadPDF(viewingQuote)} style={{ flex: 1, minWidth: '140px', padding: '14px', background: 'linear-gradient(135deg, #ef4444, #dc2626)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '700', fontSize: '15px', cursor: 'pointer' }}>ğŸ“„ PDF Ä°ndir</button>
          <button onClick={() => sendWhatsApp(viewingQuote)} style={{ flex: 1, minWidth: '140px', padding: '14px', background: 'linear-gradient(135deg, #25d366, #128c7e)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '700', fontSize: '15px', cursor: 'pointer' }}>ğŸ“± WhatsApp</button>
          <button onClick={() => sendEmail(viewingQuote)} style={{ flex: 1, minWidth: '140px', padding: '14px', background: 'linear-gradient(135deg, #3b82f6, #2563eb)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '700', fontSize: '15px', cursor: 'pointer' }}>âœ‰ï¸ E-posta</button>
        </div>
      </div>
    );
  }

  if (showForm) {
    return (
      <div style={{ position: 'fixed', inset: 0, background: 'linear-gradient(180deg, #0a1628 0%, #132742 50%, #0a1628 100%)', zIndex: 300, overflow: 'auto' }}>
        {/* Header */}
        <div style={{ position: 'sticky', top: 0, background: 'rgba(10,22,40,0.98)', backdropFilter: 'blur(20px)', borderBottom: '1px solid rgba(255,255,255,0.08)', padding: '16px 20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', zIndex: 10 }}>
          <button onClick={resetForm} style={{ background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', padding: '10px 16px', color: '#e8f1f8', cursor: 'pointer', fontSize: '14px' }}>â† Ä°ptal</button>
          <h2 style={{ margin: 0, fontSize: '16px', color: '#ffffff' }}>ğŸ“„ Yeni {formData.type === 'teklif' ? 'Teklif' : 'Proforma'}</h2>
          <div style={{ width: '70px' }}></div>
        </div>

        <div style={{ padding: '20px', paddingBottom: '100px' }}>
          {/* ADIM 1: TÃœR SEÃ‡Ä°MÄ° */}
          {formStep === 'type' && (
            <div>
              <div style={{ background: 'rgba(59,130,246,0.1)', padding: '16px', borderRadius: '12px', marginBottom: '20px', border: '1px solid rgba(59,130,246,0.2)' }}>
                <p style={{ margin: 0, fontSize: '13px', color: '#3b82f6' }}>ğŸ“‹ AdÄ±m 1/3: TÃ¼r SeÃ§imi</p>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)', gap: '16px' }}>
                <button onClick={() => { setFormData({ ...formData, type: 'teklif' }); setFormStep('customer'); }} style={{ padding: '40px', background: 'linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(59,130,246,0.05) 100%)', border: '2px solid rgba(59,130,246,0.3)', borderRadius: '16px', cursor: 'pointer', textAlign: 'center' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ“</div>
                  <div style={{ fontSize: '18px', fontWeight: '600', color: '#3b82f6', marginBottom: '8px' }}>TEKLÄ°F</div>
                  <div style={{ fontSize: '13px', color: '#64748b' }}>Fiyat teklifi hazÄ±rla</div>
                </button>

                <button onClick={() => { setFormData({ ...formData, type: 'proforma' }); setFormStep('customer'); }} style={{ padding: '40px', background: 'linear-gradient(135deg, rgba(16,185,129,0.15) 0%, rgba(16,185,129,0.05) 100%)', border: '2px solid rgba(16,185,129,0.3)', borderRadius: '16px', cursor: 'pointer', textAlign: 'center' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ’°</div>
                  <div style={{ fontSize: '18px', fontWeight: '600', color: '#10b981', marginBottom: '8px' }}>PROFORMA FATURA</div>
                  <div style={{ fontSize: '13px', color: '#64748b' }}>Ã–n fatura oluÅŸtur</div>
                </button>
              </div>
            </div>
          )}

          {/* ADIM 2: MÃœÅTERÄ° SEÃ‡Ä°MÄ° */}
          {formStep === 'customer' && (
            <div>
              <div style={{ background: 'rgba(139,92,246,0.1)', padding: '16px', borderRadius: '12px', marginBottom: '20px', border: '1px solid rgba(139,92,246,0.2)' }}>
                <p style={{ margin: 0, fontSize: '13px', color: '#8b5cf6' }}>ğŸ“‹ AdÄ±m 2/3: MÃ¼ÅŸteri SeÃ§imi</p>
                <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#94a3b8' }}>TÃ¼r: <strong style={{ color: '#fff' }}>{formData.type === 'teklif' ? 'Teklif' : 'Proforma Fatura'}</strong></p>
              </div>

              <input
                type="text"
                placeholder="ğŸ” MÃ¼ÅŸteri ara (ad, soyad, telefon, e-posta)..."
                value={customerSearchQuery}
                onChange={e => setCustomerSearchQuery(e.target.value)}
                style={{ width: '100%', padding: '14px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: '#e8f1f8', fontSize: '14px', marginBottom: '16px', boxSizing: 'border-box' }}
              />

              {searchResults.length > 0 && (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  {searchResults.map(customer => (
                    <div key={customer.id} onClick={() => { setFormData({ ...formData, customer }); setFormStep('details'); }} style={{ background: 'rgba(255,255,255,0.03)', padding: '16px', borderRadius: '12px', border: '1px solid rgba(255,255,255,0.05)', cursor: 'pointer' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                          <p style={{ margin: '0 0 4px', fontSize: '14px', fontWeight: '600', color: '#e8f1f8' }}>{customer.firstName} {customer.lastName}</p>
                          <p style={{ margin: 0, fontSize: '12px', color: '#64748b' }}>{customer.phone} â€¢ {customer.email}</p>
                        </div>
                        <span style={{ fontSize: '20px' }}>â†’</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {customerSearchQuery.length < 2 && (
                <p style={{ textAlign: 'center', color: '#64748b', padding: '30px' }}>En az 2 karakter girin</p>
              )}
            </div>
          )}

          {/* ADIM 3: DETAYLAR */}
          {formStep === 'details' && formData.customer && (
            <div>
              <div style={{ background: 'rgba(16,185,129,0.1)', padding: '16px', borderRadius: '12px', marginBottom: '20px', border: '1px solid rgba(16,185,129,0.2)' }}>
                <p style={{ margin: 0, fontSize: '13px', color: '#10b981' }}>ğŸ“‹ AdÄ±m 3/3: Detaylar</p>
                <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#94a3b8' }}>MÃ¼ÅŸteri: <strong style={{ color: '#fff' }}>{formData.customer.firstName} {formData.customer.lastName}</strong></p>
              </div>

              <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.05)', marginBottom: '100px' }}>
                {/* Konu ve Tarih */}
                <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 200px 120px', gap: '12px', marginBottom: '20px' }}>
                  <div>
                    <label style={{ fontSize: '12px', color: '#94a3b8', display: 'block', marginBottom: '6px' }}>Konu *</label>
                    <input type="text" value={formData.subject} onChange={e => setFormData({ ...formData, subject: e.target.value })} placeholder="Ã–rn: Almanya Vize BaÅŸvurusu" style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }} />
                  </div>

                  <div>
                    <label style={{ fontSize: '12px', color: '#94a3b8', display: 'block', marginBottom: '6px' }}>Opsiyon Tarihi</label>
                    <input type="date" value={formData.optionDate} onChange={e => setFormData({ ...formData, optionDate: e.target.value })} style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }} />
                  </div>

                  <div>
                    <label style={{ fontSize: '12px', color: '#94a3b8', display: 'block', marginBottom: '6px' }}>Para Birimi</label>
                    <select value={formData.currency} onChange={e => setFormData({ ...formData, currency: e.target.value })} style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px' }}>
                      <option value="EUR">EUR (â‚¬)</option>
                      <option value="USD">USD ($)</option>
                      <option value="GBP">GBP (Â£)</option>
                      <option value="TRY">TRY (â‚º)</option>
                    </select>
                  </div>
                </div>

                {/* Hizmet Kalemleri */}
                <div style={{ marginBottom: '20px' }}>
                  <h4 style={{ margin: '0 0 12px', fontSize: '14px', color: '#ffffff' }}>Hizmet Kalemleri</h4>
                  {formData.items.map((item, idx) => (
                    <div key={idx} style={{ background: 'rgba(0,0,0,0.2)', padding: '16px', borderRadius: '10px', marginBottom: '12px', border: '1px solid rgba(255,255,255,0.05)' }}>
                      <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '2fr 3fr 80px 120px 120px 40px', gap: '10px', alignItems: 'end' }}>
                        <div>
                          <label style={{ fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px' }}>Hizmet</label>
                          <input type="text" value={item.service} onChange={e => updateItem(idx, 'service', e.target.value)} placeholder="Vize" style={{ width: '100%', padding: '10px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: '#e8f1f8', fontSize: '13px', boxSizing: 'border-box' }} />
                        </div>

                        <div>
                          <label style={{ fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px' }}>AÃ§Ä±klama</label>
                          <input type="text" value={item.description} onChange={e => updateItem(idx, 'description', e.target.value)} placeholder="Detaylar" style={{ width: '100%', padding: '10px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: '#e8f1f8', fontSize: '13px', boxSizing: 'border-box' }} />
                        </div>

                        <div>
                          <label style={{ fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px' }}>Adet</label>
                          <input type="number" value={item.quantity} onChange={e => updateItem(idx, 'quantity', Number(e.target.value))} min="1" style={{ width: '100%', padding: '10px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: '#e8f1f8', fontSize: '13px', boxSizing: 'border-box' }} />
                        </div>

                        <div>
                          <label style={{ fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px' }}>Birim Fiyat</label>
                          <input type="number" value={item.unitPrice} onChange={e => updateItem(idx, 'unitPrice', Number(e.target.value))} min="0" step="0.01" style={{ width: '100%', padding: '10px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: '#e8f1f8', fontSize: '13px', boxSizing: 'border-box' }} />
                        </div>

                        <div>
                          <label style={{ fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px' }}>Toplam</label>
                          <div style={{ padding: '10px', background: 'rgba(16,185,129,0.1)', borderRadius: '6px', fontSize: '13px', color: '#10b981', fontWeight: '600', textAlign: 'right' }}>
                            {(item.quantity * item.unitPrice).toFixed(2)}
                          </div>
                        </div>

                        <button onClick={() => removeItem(idx)} disabled={formData.items.length === 1} style={{ padding: '10px', background: formData.items.length === 1 ? 'rgba(100,116,139,0.1)' : 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '6px', color: formData.items.length === 1 ? '#64748b' : '#ef4444', cursor: formData.items.length === 1 ? 'not-allowed' : 'pointer', fontSize: '16px' }}>ğŸ—‘ï¸</button>
                      </div>
                    </div>
                  ))}

                  <button onClick={addItem} style={{ width: '100%', padding: '12px', background: 'rgba(59,130,246,0.1)', border: '1px dashed rgba(59,130,246,0.3)', borderRadius: '10px', color: '#3b82f6', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}>â• Kalem Ekle</button>
                </div>

                {/* Hesaplamalar */}
                <div style={{ background: 'rgba(0,0,0,0.3)', padding: '20px', borderRadius: '12px', border: '1px solid rgba(255,255,255,0.05)' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px' }}>
                    <span style={{ fontSize: '13px', color: '#94a3b8' }}>Ara Toplam:</span>
                    <span style={{ fontSize: '14px', color: '#e8f1f8', fontWeight: '600' }}>{formData.subtotal.toFixed(2)} {formData.currency}</span>
                  </div>

                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                      <label style={{ fontSize: '13px', color: '#94a3b8', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <input type="checkbox" checked={formData.vatIncluded} onChange={e => setFormData({ ...formData, vatIncluded: e.target.checked })} />
                        KDV Dahil
                      </label>
                      {formData.vatIncluded && (
                        <input type="number" value={formData.vatRate} onChange={e => setFormData({ ...formData, vatRate: Number(e.target.value) })} min="0" max="100" style={{ width: '60px', padding: '6px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: '#e8f1f8', fontSize: '12px' }} />
                      )}
                    </div>
                    {formData.vatIncluded && <span style={{ fontSize: '14px', color: '#f59e0b', fontWeight: '600' }}>+{(formData.subtotal * formData.vatRate / 100).toFixed(2)} {formData.currency}</span>}
                  </div>

                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <span style={{ fontSize: '13px', color: '#94a3b8' }}>Ä°ndirim:</span>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <input type="number" value={formData.discount} onChange={e => setFormData({ ...formData, discount: Number(e.target.value) })} min="0" step="0.01" style={{ width: '100px', padding: '8px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: '#e8f1f8', fontSize: '13px', textAlign: 'right' }} />
                      <span style={{ fontSize: '13px', color: '#e8f1f8' }}>{formData.currency}</span>
                    </div>
                  </div>

                  <div style={{ borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: '12px', display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ fontSize: '16px', color: '#ffffff', fontWeight: '700' }}>TOPLAM:</span>
                    <span style={{ fontSize: '20px', color: '#10b981', fontWeight: '700' }}>{formData.total.toFixed(2)} {formData.currency}</span>
                  </div>
                </div>

                {/* Notlar */}
                <div style={{ marginTop: '20px' }}>
                  <label style={{ fontSize: '12px', color: '#94a3b8', display: 'block', marginBottom: '6px' }}>Notlar</label>
                  <textarea value={formData.notes} onChange={e => setFormData({ ...formData, notes: e.target.value })} placeholder="Ek aÃ§Ä±klamalar..." style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '13px', minHeight: '80px', resize: 'vertical', boxSizing: 'border-box' }} />
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Footer Buttons */}
        {formStep === 'details' && (
          <div style={{ position: 'fixed', bottom: 0, left: 0, right: 0, background: 'rgba(10,22,40,0.98)', backdropFilter: 'blur(20px)', borderTop: '1px solid rgba(255,255,255,0.08)', padding: '16px 20px', display: 'flex', gap: '12px' }}>
            <button onClick={handleSave} style={{ flex: 1, padding: '14px', background: 'linear-gradient(135deg, #10b981, #059669)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '700', fontSize: '15px', cursor: 'pointer' }}>ğŸ’¾ Kaydet</button>
            <button style={{ flex: 1, padding: '14px', background: 'linear-gradient(135deg, #25d366, #128c7e)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '700', fontSize: '15px', cursor: 'pointer' }}>ğŸ“± WhatsApp</button>
            <button style={{ flex: 1, padding: '14px', background: 'linear-gradient(135deg, #3b82f6, #2563eb)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '700', fontSize: '15px', cursor: 'pointer' }}>âœ‰ï¸ E-posta</button>
          </div>
        )}
      </div>
    );
  }

  return (
    <div style={{ padding: '20px' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' }}>
        <div>
          <h2 style={{ margin: 0, fontSize: '20px', color: '#ffffff' }}>ğŸ“„ Teklif & Proforma</h2>
          <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#64748b' }}>{filteredQuotes.length} / {quotes.length} kayÄ±t</p>
        </div>
        <button onClick={() => setShowForm(true)} style={{ background: 'linear-gradient(135deg, #3b82f6, #2563eb)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>â• Yeni OluÅŸtur</button>
      </div>

      {/* Filtre ButonlarÄ± */}
      {quotes.length > 0 && (
        <div style={{ marginBottom: '16px' }}>
          <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
            <button onClick={() => setFilterType('all')} style={{ padding: '10px 20px', background: filterType === 'all' ? 'linear-gradient(135deg, #3b82f6, #2563eb)' : 'rgba(255,255,255,0.05)', border: filterType === 'all' ? 'none' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: filterType === 'all' ? 'white' : '#94a3b8', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}>
              ğŸ“‹ TÃ¼mÃ¼ ({quotes.length})
            </button>
            <button onClick={() => setFilterType('teklif')} style={{ padding: '10px 20px', background: filterType === 'teklif' ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'rgba(255,255,255,0.05)', border: filterType === 'teklif' ? 'none' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: filterType === 'teklif' ? 'white' : '#94a3b8', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}>
              ğŸ“ Teklifler ({quotes.filter(q => q.type === 'teklif').length})
            </button>
            <button onClick={() => setFilterType('proforma')} style={{ padding: '10px 20px', background: filterType === 'proforma' ? 'linear-gradient(135deg, #10b981, #059669)' : 'rgba(255,255,255,0.05)', border: filterType === 'proforma' ? 'none' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: filterType === 'proforma' ? 'white' : '#94a3b8', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}>
              ğŸ’° Proformalar ({quotes.filter(q => q.type === 'proforma').length})
            </button>
          </div>

          {/* Arama */}
          <div style={{ position: 'relative' }}>
            <input
              type="text"
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              placeholder="ğŸ” Konu, mÃ¼ÅŸteri adÄ± veya belge numarasÄ± ile ara..."
              style={{ width: '100%', padding: '12px 40px 12px 16px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '12px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }}
            />
            {searchQuery && (
              <button onClick={() => setSearchQuery('')} style={{ position: 'absolute', right: '12px', top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', color: '#94a3b8', cursor: 'pointer', fontSize: '18px' }}>Ã—</button>
            )}
          </div>
        </div>
      )}

      {filteredQuotes.length === 0 ? (
        <div style={{ textAlign: 'center', padding: '60px 20px', background: 'rgba(255,255,255,0.03)', borderRadius: '16px', border: '1px solid rgba(255,255,255,0.05)' }}>
          <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ“„</div>
          <h3 style={{ margin: '0 0 8px', fontSize: '16px', color: '#ffffff' }}>
            {quotes.length === 0 ? 'HenÃ¼z teklif/proforma oluÅŸturulmamÄ±ÅŸ' : 'SonuÃ§ bulunamadÄ±'}
          </h3>
          <p style={{ margin: 0, fontSize: '13px', color: '#64748b' }}>
            {quotes.length === 0 ? 'Yeni bir teklif veya proforma oluÅŸturmak iÃ§in "Yeni OluÅŸtur" butonuna tÄ±klayÄ±n' : 'FarklÄ± bir arama terimi deneyin'}
          </p>
        </div>
      ) : (
        <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : 'repeat(auto-fill, minmax(320px, 1fr))', gap: '16px' }}>
          {filteredQuotes.map(quote => (
            <div key={quote.id} style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.05)' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px' }}>
                <span style={{ fontSize: '18px' }}>{quote.type === 'teklif' ? 'ğŸ“' : 'ğŸ’°'}</span>
                <span style={{ fontSize: '11px', color: '#64748b' }}>{quote.number}</span>
              </div>
              <h3 style={{ margin: '0 0 4px', fontSize: '15px', color: '#ffffff' }}>{quote.subject}</h3>
              <p style={{ margin: '0 0 12px', fontSize: '12px', color: '#64748b' }}>{quote.customer.firstName} {quote.customer.lastName}</p>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', background: 'rgba(16,185,129,0.1)', borderRadius: '8px', marginBottom: '12px' }}>
                <span style={{ fontSize: '12px', color: '#10b981' }}>Toplam</span>
                <span style={{ fontSize: '16px', color: '#10b981', fontWeight: '700' }}>{quote.total.toFixed(2)} {quote.currency}</span>
              </div>
              <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                <button onClick={() => setViewingQuote(quote)} style={{ flex: '1 1 auto', padding: '8px', background: 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '6px', color: '#3b82f6', cursor: 'pointer', fontSize: '11px', fontWeight: '600' }}>ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼le</button>
                <button onClick={() => downloadPDF(quote)} style={{ padding: '8px 12px', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '6px', color: '#ef4444', cursor: 'pointer', fontSize: '11px', fontWeight: '600' }}>ğŸ“„</button>
                <button onClick={() => sendWhatsApp(quote)} style={{ padding: '8px 12px', background: 'rgba(37,211,102,0.2)', border: 'none', borderRadius: '6px', color: '#25d366', cursor: 'pointer', fontSize: '11px', fontWeight: '600' }}>ğŸ“±</button>
                <button onClick={() => sendEmail(quote)} style={{ padding: '8px 12px', background: 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '6px', color: '#3b82f6', cursor: 'pointer', fontSize: '11px', fontWeight: '600' }}>âœ‰ï¸</button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// KREDÄ° KARTLARI MODÃœLÃœ
function CreditCardsModule({ creditCards, setCreditCards, isMobile, showToast, addToUndo }) {
  const [showForm, setShowForm] = useState(false);
  const [editingCard, setEditingCard] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [formData, setFormData] = useState({
    cardName: '', cardNumber: '', expiryDate: '', cvv: '', cardHolder: '', bank: '', cardType: 'Kredi KartÄ±', limit: '', notes: ''
  });

  const emptyForm = { cardName: '', cardNumber: '', expiryDate: '', cvv: '', cardHolder: '', bank: '', cardType: 'Kredi KartÄ±', limit: '', notes: '' };

  const openNewForm = () => {
    setFormData(emptyForm);
    setEditingCard(null);
    setShowForm(true);
  };

  const openEditForm = (card) => {
    setFormData(card);
    setEditingCard(card);
    setShowForm(true);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.cardName || !formData.cardNumber) {
      alert('Kart adÄ± ve numara zorunludur!');
      return;
    }

    if (editingCard) {
      const updated = creditCards.map(c => c.id === editingCard.id ? { ...formData, id: editingCard.id, updatedAt: new Date().toISOString() } : c);
      setCreditCards(updated);
      showToast?.('Kart gÃ¼ncellendi', 'success');
    } else {
      const newCard = { ...formData, id: Date.now(), createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
      setCreditCards([...creditCards, newCard]);
      showToast?.('Kart eklendi', 'success');
    }
    setShowForm(false);
    setFormData(emptyForm);
  };

  const deleteCard = (id) => {
    if (!confirm('Bu kartÄ± silmek istediÄŸinizden emin misiniz?')) return;
    const card = creditCards.find(c => c.id === id);
    const updated = creditCards.filter(c => c.id !== id);
    setCreditCards(updated);
    showToast?.('Kart silindi', 'info', {
      label: 'â†©ï¸ Geri Al',
      action: () => {
        setCreditCards([...updated, card].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
        showToast?.('Kart geri yÃ¼klendi', 'success');
      }
    });
  };

  const filteredCards = searchQuery.length >= 2
    ? creditCards.filter(c =>
        c.cardName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        c.cardNumber?.includes(searchQuery) ||
        c.cardHolder?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        c.bank?.toLowerCase().includes(searchQuery.toLowerCase())
      )
    : creditCards;

  const labelStyle = { fontSize: '12px', color: '#94a3b8', display: 'block', marginBottom: '6px' };
  const inputStyle = { width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' };

  if (showForm) {
    return (
      <div style={{ padding: '20px', minHeight: '100vh' }}>
        <div style={{ maxWidth: '800px', margin: '0 auto' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <div>
              <h2 style={{ margin: 0, fontSize: '20px', color: '#ffffff' }}>{editingCard ? 'âœï¸ Kart DÃ¼zenle' : 'â• Yeni Kredi KartÄ±'}</h2>
              <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#64748b' }}>Kredi/Banka kartÄ± bilgileri</p>
            </div>
            <button onClick={() => { setShowForm(false); setFormData(emptyForm); }} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 16px', color: '#e8f1f8', cursor: 'pointer' }}>âœ• Kapat</button>
          </div>

          <form onSubmit={handleSubmit} style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(255,255,255,0.05)' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <div>
                <label style={labelStyle}>Kart AdÄ± *</label>
                <input type="text" value={formData.cardName} onChange={e => setFormData({...formData, cardName: e.target.value})} placeholder="Ã–rn: Ä°ÅŸ BankasÄ± Platinum" style={inputStyle} required />
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '16px' }}>
                <div>
                  <label style={labelStyle}>Kart NumarasÄ± *</label>
                  <input type="text" value={formData.cardNumber} onChange={e => setFormData({...formData, cardNumber: e.target.value.replace(/\s/g, '').replace(/(.{4})/g, '$1 ').trim()})} placeholder="0000 0000 0000 0000" maxLength="19" style={{...inputStyle, fontFamily: 'monospace', letterSpacing: '2px'}} required />
                </div>

                <div>
                  <label style={labelStyle}>Kart Sahibi</label>
                  <input type="text" value={formData.cardHolder} onChange={e => setFormData({...formData, cardHolder: e.target.value.toUpperCase()})} placeholder="AD SOYAD" style={{...inputStyle, textTransform: 'uppercase'}} />
                </div>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr 1fr', gap: '16px' }}>
                <div>
                  <label style={labelStyle}>Son Kullanma (AA/YY)</label>
                  <input type="text" value={formData.expiryDate} onChange={e => {
                    let val = e.target.value.replace(/\D/g, '');
                    if (val.length >= 2) val = val.slice(0,2) + '/' + val.slice(2,4);
                    setFormData({...formData, expiryDate: val});
                  }} placeholder="12/28" maxLength="5" style={{...inputStyle, fontFamily: 'monospace'}} />
                </div>

                <div>
                  <label style={labelStyle}>CVV</label>
                  <input type="text" value={formData.cvv} onChange={e => setFormData({...formData, cvv: e.target.value.replace(/\D/g, '').slice(0,3)})} placeholder="000" maxLength="3" style={{...inputStyle, fontFamily: 'monospace', letterSpacing: '3px'}} />
                </div>

                <div>
                  <label style={labelStyle}>Kart Tipi</label>
                  <select value={formData.cardType} onChange={e => setFormData({...formData, cardType: e.target.value})} style={inputStyle}>
                    <option value="Kredi KartÄ±">Kredi KartÄ±</option>
                    <option value="Banka KartÄ±">Banka KartÄ±</option>
                  </select>
                </div>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '16px' }}>
                <div>
                  <label style={labelStyle}>Banka</label>
                  <input type="text" value={formData.bank} onChange={e => setFormData({...formData, bank: e.target.value})} placeholder="Banka adÄ±" style={inputStyle} />
                </div>

                <div>
                  <label style={labelStyle}>Limit (â‚º)</label>
                  <input type="number" value={formData.limit} onChange={e => setFormData({...formData, limit: e.target.value})} placeholder="0" style={inputStyle} />
                </div>
              </div>

              <div>
                <label style={labelStyle}>Notlar</label>
                <textarea value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} placeholder="Ek bilgiler..." style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} />
              </div>

              <button type="submit" style={{ width: '100%', padding: '16px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '700', fontSize: '16px', cursor: 'pointer' }}>
                ğŸ’¾ {editingCard ? 'GÃ¼ncelle' : 'Kaydet'}
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  }

  return (
    <div style={{ padding: '20px' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' }}>
        <div>
          <h2 style={{ margin: 0, fontSize: '20px', color: '#ffffff' }}>ğŸ’³ Kredi KartlarÄ±</h2>
          <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#64748b' }}>{creditCards.length} kayÄ±tlÄ± kart</p>
        </div>
        <button onClick={openNewForm} style={{ background: 'linear-gradient(135deg, #10b981, #059669)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>â• Yeni Kart</button>
      </div>

      {creditCards.length > 0 && (
        <div style={{ marginBottom: '16px' }}>
          <div style={{ position: 'relative' }}>
            <input
              type="text"
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              placeholder="ğŸ” Kart adÄ±, numara, banka veya kart sahibi ile ara..."
              style={{ width: '100%', padding: '12px 40px 12px 16px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '12px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }}
            />
            {searchQuery && (
              <button onClick={() => setSearchQuery('')} style={{ position: 'absolute', right: '12px', top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', color: '#94a3b8', cursor: 'pointer', fontSize: '18px' }}>Ã—</button>
            )}
          </div>
          {searchQuery.length >= 2 && (
            <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#64748b' }}>{filteredCards.length} sonuÃ§ bulundu</p>
          )}
        </div>
      )}

      {filteredCards.length === 0 ? (
        <div style={{ textAlign: 'center', padding: '60px 20px', background: 'rgba(255,255,255,0.03)', borderRadius: '16px', border: '1px solid rgba(255,255,255,0.05)' }}>
          <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ’³</div>
          <h3 style={{ margin: '0 0 8px', fontSize: '16px', color: '#ffffff' }}>
            {searchQuery.length >= 2 ? 'SonuÃ§ bulunamadÄ±' : 'HenÃ¼z kart eklenmemiÅŸ'}
          </h3>
          <p style={{ margin: 0, fontSize: '13px', color: '#64748b' }}>
            {searchQuery.length >= 2 ? 'FarklÄ± bir arama terimi deneyin' : 'Kredi/banka kartÄ± bilgilerini eklemek iÃ§in "Yeni Kart" butonuna tÄ±klayÄ±n'}
          </p>
        </div>
      ) : (
        <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', border: '1px solid rgba(255,255,255,0.05)', overflow: 'hidden' }}>
          {!isMobile && (
            <div style={{ display: 'grid', gridTemplateColumns: '200px 180px 150px 150px 120px 100px 80px', gap: '16px', padding: '16px 20px', background: 'rgba(16,185,129,0.1)', borderBottom: '1px solid rgba(255,255,255,0.05)', fontSize: '12px', fontWeight: '600', color: '#10b981' }}>
              <div>KART ADI</div>
              <div>KART NO</div>
              <div>KART SAHÄ°BÄ°</div>
              <div>BANKA</div>
              <div>SÃœRE</div>
              <div>CVV</div>
              <div style={{ textAlign: 'center' }}>Ä°ÅLEM</div>
            </div>
          )}
          
          <div style={{ maxHeight: isMobile ? 'none' : '600px', overflowY: 'auto' }}>
            {filteredCards.map((card, idx) => (
              <div key={card.id} style={{ display: isMobile ? 'block' : 'grid', gridTemplateColumns: isMobile ? '1fr' : '200px 180px 150px 150px 120px 100px 80px', gap: '16px', padding: '16px 20px', borderBottom: idx < filteredCards.length - 1 ? '1px solid rgba(255,255,255,0.05)' : 'none', background: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)', alignItems: 'center' }}>
                
                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>Kart AdÄ±</span>}
                  <span style={{ fontSize: '14px', color: '#10b981', fontWeight: '600' }}>{card.cardName}</span>
                  {card.cardType && <span style={{ fontSize: '10px', color: '#64748b' }}>{card.cardType}</span>}
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginTop: isMobile ? '12px' : '0' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>Kart NumarasÄ±</span>}
                  <span style={{ fontSize: '13px', color: '#e8f1f8', fontFamily: 'monospace', letterSpacing: '1px' }}>
                    {card.cardNumber || '-'}
                  </span>
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginTop: isMobile ? '12px' : '0' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>Kart Sahibi</span>}
                  <span style={{ fontSize: '13px', color: '#e8f1f8' }}>
                    {card.cardHolder || '-'}
                  </span>
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginTop: isMobile ? '12px' : '0' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>Banka</span>}
                  <span style={{ fontSize: '13px', color: '#e8f1f8' }}>
                    {card.bank || '-'}
                  </span>
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginTop: isMobile ? '12px' : '0' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>Son Kullanma</span>}
                  <span style={{ fontSize: '13px', color: '#e8f1f8', fontFamily: 'monospace' }}>
                    {card.expiryDate || '-'}
                  </span>
                </div>

                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop: isMobile ? '12px' : '0' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>CVV:</span>}
                  <span style={{ fontSize: '13px', color: '#e8f1f8', fontFamily: 'monospace', letterSpacing: '2px' }}>
                    {card.cvv || '-'}
                  </span>
                  {card.cvv && (
                    <button onClick={() => navigator.clipboard.writeText(card.cvv)} style={{ background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '6px', padding: '4px 8px', color: '#3b82f6', cursor: 'pointer', fontSize: '11px' }}>ğŸ“‹</button>
                  )}
                </div>

                <div style={{ display: 'flex', gap: '8px', justifyContent: isMobile ? 'flex-start' : 'center', marginTop: isMobile ? '12px' : '0' }}>
                  <button onClick={() => openEditForm(card)} style={{ background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '8px', padding: '8px 12px', color: '#3b82f6', cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>âœï¸</button>
                  <button onClick={() => deleteCard(card.id)} style={{ background: 'rgba(239,68,68,0.2)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '8px', padding: '8px 12px', color: '#ef4444', cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>ğŸ—‘ï¸</button>
                </div>

                {card.notes && (
                  <div style={{ gridColumn: isMobile ? '1' : '1 / -1', marginTop: '12px', padding: '12px', background: 'rgba(0,0,0,0.2)', borderRadius: '8px', fontSize: '12px', color: '#94a3b8', borderLeft: '3px solid rgba(16,185,129,0.5)' }}>
                    <strong style={{ color: '#10b981' }}>Not:</strong> {card.notes}
                  </div>
                )}

                {card.limit && (
                  <div style={{ gridColumn: isMobile ? '1' : '1 / -1', marginTop: '8px', fontSize: '12px', color: '#64748b' }}>
                    ğŸ’° Limit: <strong style={{ color: '#10b981' }}>{Number(card.limit).toLocaleString('tr-TR')} â‚º</strong>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

// ACENTELÄ°KLER MODÃœLÃœ
function AgenciesModule({ agencies, setAgencies, isMobile, showToast, addToUndo }) {
  const [showForm, setShowForm] = useState(false);
  const [editingAgency, setEditingAgency] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [formData, setFormData] = useState({
    name: '', link: '', institutionCode: '', userCode: '', password: '', notes: ''
  });

  const emptyForm = { name: '', link: '', institutionCode: '', userCode: '', password: '', notes: '' };

  const openNewForm = () => {
    setFormData(emptyForm);
    setEditingAgency(null);
    setShowForm(true);
  };

  const openEditForm = (agency) => {
    setFormData(agency);
    setEditingAgency(agency);
    setShowForm(true);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.name || !formData.link) {
      alert('Acente adÄ± ve link zorunludur!');
      return;
    }

    if (editingAgency) {
      const updated = agencies.map(a => a.id === editingAgency.id ? { ...formData, id: editingAgency.id, updatedAt: new Date().toISOString() } : a);
      setAgencies(updated);
      showToast?.('Acentelik gÃ¼ncellendi', 'success');
    } else {
      const newAgency = { ...formData, id: Date.now(), createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
      setAgencies([...agencies, newAgency]);
      showToast?.('Acentelik eklendi', 'success');
    }
    setShowForm(false);
    setFormData(emptyForm);
  };

  const deleteAgency = (id) => {
    if (!confirm('Bu acenteliÄŸi silmek istediÄŸinizden emin misiniz?')) return;
    const agency = agencies.find(a => a.id === id);
    const updated = agencies.filter(a => a.id !== id);
    setAgencies(updated);
    showToast?.('Acentelik silindi', 'info', {
      label: 'â†©ï¸ Geri Al',
      action: () => {
        setAgencies([...updated, agency].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
        showToast?.('Acentelik geri yÃ¼klendi', 'success');
      }
    });
  };

  const filteredAgencies = searchQuery.length >= 2
    ? agencies.filter(a =>
        a.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        a.link?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        a.institutionCode?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        a.userCode?.toLowerCase().includes(searchQuery.toLowerCase())
      )
    : agencies;

  const labelStyle = { fontSize: '12px', color: '#94a3b8', display: 'block', marginBottom: '6px' };
  const inputStyle = { width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' };

  if (showForm) {
    return (
      <div style={{ padding: '20px', minHeight: '100vh' }}>
        <div style={{ maxWidth: '800px', margin: '0 auto' }}>
          {/* Header */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <div>
              <h2 style={{ margin: 0, fontSize: '20px', color: '#ffffff' }}>{editingAgency ? 'âœï¸ Acentelik DÃ¼zenle' : 'â• Yeni Acentelik'}</h2>
              <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#64748b' }}>KayÄ±tlÄ± sistem/kurum bilgileri</p>
            </div>
            <button onClick={() => { setShowForm(false); setFormData(emptyForm); }} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 16px', color: '#e8f1f8', cursor: 'pointer' }}>âœ• Kapat</button>
          </div>

          {/* Form */}
          <form onSubmit={handleSubmit} style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(255,255,255,0.05)' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <div>
                <label style={labelStyle}>Acente/Kurum AdÄ± *</label>
                <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} placeholder="Ã–rn: VFS Global, TLScontact" style={inputStyle} required />
              </div>

              <div>
                <label style={labelStyle}>Link/URL *</label>
                <input type="url" value={formData.link} onChange={e => setFormData({...formData, link: e.target.value})} placeholder="https://example.com" style={inputStyle} required />
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '16px' }}>
                <div>
                  <label style={labelStyle}>Kurum Kodu</label>
                  <input type="text" value={formData.institutionCode} onChange={e => setFormData({...formData, institutionCode: e.target.value})} placeholder="Varsa kurum kodu" style={inputStyle} />
                </div>

                <div>
                  <label style={labelStyle}>KullanÄ±cÄ± Kodu / E-mail</label>
                  <input type="text" value={formData.userCode} onChange={e => setFormData({...formData, userCode: e.target.value})} placeholder="KullanÄ±cÄ± adÄ± veya e-posta" style={inputStyle} />
                </div>
              </div>

              <div>
                <label style={labelStyle}>Åifre</label>
                <input type="text" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style={inputStyle} />
                <p style={{ margin: '4px 0 0', fontSize: '11px', color: '#64748b' }}>âš ï¸ Åifre dÃ¼z metin olarak saklanÄ±r, gÃ¼venlik iÃ§in dikkatli olun</p>
              </div>

              <div>
                <label style={labelStyle}>Notlar</label>
                <textarea value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} placeholder="Ek bilgiler, hatÄ±rlatmalar..." style={{ ...inputStyle, minHeight: '100px', resize: 'vertical' }} />
              </div>

              <button type="submit" style={{ width: '100%', padding: '16px', background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', border: 'none', borderRadius: '12px', color: '#0c1929', fontWeight: '700', fontSize: '16px', cursor: 'pointer' }}>
                ğŸ’¾ {editingAgency ? 'GÃ¼ncelle' : 'Kaydet'}
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  }

  return (
    <div style={{ padding: '20px' }}>
      {/* Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' }}>
        <div>
          <h2 style={{ margin: 0, fontSize: '20px', color: '#ffffff' }}>ğŸ¢ Acentelikler</h2>
          <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#64748b' }}>{agencies.length} kayÄ±tlÄ± sistem</p>
        </div>
        <button onClick={openNewForm} style={{ background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: '#0c1929', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>â• Yeni Acentelik</button>
      </div>

      {/* Arama */}
      {agencies.length > 0 && (
        <div style={{ marginBottom: '16px' }}>
          <div style={{ position: 'relative' }}>
            <input
              type="text"
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              placeholder="ğŸ” Acente adÄ±, link, kurum kodu veya kullanÄ±cÄ± ile ara..."
              style={{ width: '100%', padding: '12px 40px 12px 16px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '12px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }}
            />
            {searchQuery && (
              <button onClick={() => setSearchQuery('')} style={{ position: 'absolute', right: '12px', top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', color: '#94a3b8', cursor: 'pointer', fontSize: '18px' }}>Ã—</button>
            )}
          </div>
          {searchQuery.length >= 2 && (
            <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#64748b' }}>{filteredAgencies.length} sonuÃ§ bulundu</p>
          )}
        </div>
      )}

      {/* Liste - Tablo GÃ¶rÃ¼nÃ¼mÃ¼ */}
      {filteredAgencies.length === 0 ? (
        <div style={{ textAlign: 'center', padding: '60px 20px', background: 'rgba(255,255,255,0.03)', borderRadius: '16px', border: '1px solid rgba(255,255,255,0.05)' }}>
          <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ¢</div>
          <h3 style={{ margin: '0 0 8px', fontSize: '16px', color: '#ffffff' }}>
            {searchQuery.length >= 2 ? 'SonuÃ§ bulunamadÄ±' : 'HenÃ¼z acentelik eklenmemiÅŸ'}
          </h3>
          <p style={{ margin: 0, fontSize: '13px', color: '#64748b' }}>
            {searchQuery.length >= 2 ? 'FarklÄ± bir arama terimi deneyin' : 'KayÄ±tlÄ± sistem bilgilerini eklemek iÃ§in "Yeni Acentelik" butonuna tÄ±klayÄ±n'}
          </p>
        </div>
      ) : (
        <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', border: '1px solid rgba(255,255,255,0.05)', overflow: 'hidden' }}>
          {/* Table Header */}
          {!isMobile && (
            <div style={{ display: 'grid', gridTemplateColumns: '200px 1fr 150px 200px 150px 80px', gap: '16px', padding: '16px 20px', background: 'rgba(245,158,11,0.1)', borderBottom: '1px solid rgba(255,255,255,0.05)', fontSize: '12px', fontWeight: '600', color: '#f59e0b' }}>
              <div>ACENTE ADI</div>
              <div>LÄ°NK</div>
              <div>KURUM KODU</div>
              <div>KULLANICI</div>
              <div>ÅÄ°FRE</div>
              <div style={{ textAlign: 'center' }}>Ä°ÅLEM</div>
            </div>
          )}
          
          {/* Table Rows */}
          <div style={{ maxHeight: isMobile ? 'none' : '600px', overflowY: 'auto' }}>
            {filteredAgencies.map((agency, idx) => (
              <div key={agency.id} style={{ display: isMobile ? 'block' : 'grid', gridTemplateColumns: isMobile ? '1fr' : '200px 1fr 150px 200px 150px 80px', gap: '16px', padding: '16px 20px', borderBottom: idx < filteredAgencies.length - 1 ? '1px solid rgba(255,255,255,0.05)' : 'none', background: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)', alignItems: 'center' }}>
                
                {/* Acente AdÄ± */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>Acente AdÄ±</span>}
                  <span style={{ fontSize: '14px', color: '#f59e0b', fontWeight: '600' }}>{agency.name}</span>
                </div>

                {/* Link */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginTop: isMobile ? '12px' : '0' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>Link</span>}
                  {agency.link ? (
                    <a href={agency.link} target="_blank" rel="noopener noreferrer" style={{ fontSize: '13px', color: '#3b82f6', textDecoration: 'none', wordBreak: 'break-all', display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                      ğŸ”— {agency.link}
                    </a>
                  ) : (
                    <span style={{ fontSize: '13px', color: '#64748b' }}>-</span>
                  )}
                </div>

                {/* Kurum Kodu */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginTop: isMobile ? '12px' : '0' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>Kurum Kodu</span>}
                  <span style={{ fontSize: '13px', color: '#e8f1f8', fontFamily: 'monospace', letterSpacing: '1px' }}>
                    {agency.institutionCode || '-'}
                  </span>
                </div>

                {/* KullanÄ±cÄ± */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginTop: isMobile ? '12px' : '0' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>KullanÄ±cÄ± Kodu / E-mail</span>}
                  <span style={{ fontSize: '13px', color: '#e8f1f8', fontFamily: 'monospace', wordBreak: 'break-all' }}>
                    {agency.userCode || '-'}
                  </span>
                </div>

                {/* Åifre */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginTop: isMobile ? '12px' : '0' }}>
                  {isMobile && <span style={{ fontSize: '11px', color: '#64748b' }}>Åifre</span>}
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '13px', color: '#e8f1f8', fontFamily: 'monospace', letterSpacing: '2px' }}>
                      {agency.password || '-'}
                    </span>
                    {agency.password && (
                      <button onClick={() => navigator.clipboard.writeText(agency.password)} style={{ background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '6px', padding: '4px 8px', color: '#3b82f6', cursor: 'pointer', fontSize: '11px' }}>ğŸ“‹</button>
                    )}
                  </div>
                </div>

                {/* Ä°ÅŸlemler */}
                <div style={{ display: 'flex', gap: '8px', justifyContent: isMobile ? 'flex-start' : 'center', marginTop: isMobile ? '12px' : '0' }}>
                  <button onClick={() => openEditForm(agency)} style={{ background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '8px', padding: '8px 12px', color: '#3b82f6', cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>âœï¸</button>
                  <button onClick={() => deleteAgency(agency.id)} style={{ background: 'rgba(239,68,68,0.2)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '8px', padding: '8px 12px', color: '#ef4444', cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>ğŸ—‘ï¸</button>
                </div>

                {/* Notlar (varsa) */}
                {agency.notes && (
                  <div style={{ gridColumn: isMobile ? '1' : '1 / -1', marginTop: '12px', padding: '12px', background: 'rgba(0,0,0,0.2)', borderRadius: '8px', fontSize: '12px', color: '#94a3b8', borderLeft: '3px solid rgba(245,158,11,0.5)' }}>
                    <strong style={{ color: '#f59e0b' }}>Not:</strong> {agency.notes}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

// AYARLAR MODÃœLÃœ
function SettingsModule({ users, setUsers, currentUser, setCurrentUser, isMobile, appSettings, setAppSettings }) {
  const [activeTab, setActiveTab] = useState('general');
  const [showUserForm, setShowUserForm] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [userFormData, setUserFormData] = useState({});
  const [passwordData, setPasswordData] = useState({ current: '', new: '', confirm: '' });
  const [passwordError, setPasswordError] = useState('');
  const [passwordSuccess, setPasswordSuccess] = useState('');
  const [newProcessor, setNewProcessor] = useState('');
  const [newPersonalField, setNewPersonalField] = useState('');
  const [newVisaStatus, setNewVisaStatus] = useState('');
  const [newDuration, setNewDuration] = useState({ category: 'usa', value: '', price: 0, currency: 'â‚¬' });

  const isAdmin = currentUser?.role === 'admin';

  const resetUserForm = () => {
    setUserFormData({ name: '', email: '', password: '', role: 'user' });
    setEditingUser(null);
  };

  const openNewUserForm = () => {
    resetUserForm();
    setShowUserForm(true);
  };

  const openEditUser = (user) => {
    setEditingUser(user);
    setUserFormData({ ...user, password: '' });
    setShowUserForm(true);
  };

  const handleUserSubmit = async (e) => {
    e.preventDefault();
    if (!userFormData.name || !userFormData.email) {
      alert('Ad ve e-posta zorunlu');
      return;
    }

    if (editingUser) {
      const updateData = { name: userFormData.name, email: userFormData.email, role: userFormData.role };
      if (userFormData.password) updateData.password = userFormData.password;
      
      const updated = users.map(u => u.id === editingUser.id ? { ...u, ...updateData } : u);
      setUsers(updated);
      
      // EÄŸer kendi profilini gÃ¼ncelliyorsa currentUser'Ä± da gÃ¼ncelle
      if (currentUser.id === editingUser.id) {
        const updatedCurrentUser = { ...currentUser, ...updateData };
        setCurrentUser(updatedCurrentUser);
        localStorage.setItem('paydos_current_user', JSON.stringify(updatedCurrentUser));
      }
      
      try { await supabase.from('users').update(toSnakeCase(updateData)).eq('id', editingUser.id); } catch (err) { console.error(err); }
    } else {
      if (!userFormData.password) {
        alert('Yeni kullanÄ±cÄ± iÃ§in ÅŸifre zorunlu');
        return;
      }
      const newUser = { ...userFormData, id: generateUniqueId(), createdAt: new Date().toISOString() };
      setUsers([...users, newUser]);
      try { await supabase.from('users').insert([toSnakeCase(newUser)]); } catch (err) { console.error(err); }
    }
    
    setShowUserForm(false);
    resetUserForm();
  };

  const deleteUser = async (id) => {
    if (id === currentUser.id) {
      alert('Kendi hesabÄ±nÄ±zÄ± silemezsiniz!');
      return;
    }
    if (!confirm('Bu kullanÄ±cÄ±yÄ± silmek istediÄŸinize emin misiniz?')) return;
    setUsers(users.filter(u => u.id !== id));
    try { await supabase.from('users').delete().eq('id', id); } catch (err) { console.error(err); }
  };

  const handlePasswordChange = async (e) => {
    e.preventDefault();
    setPasswordError('');
    setPasswordSuccess('');

    if (passwordData.current !== currentUser.password) {
      setPasswordError('Mevcut ÅŸifre yanlÄ±ÅŸ!');
      return;
    }
    if (passwordData.new.length < 4) {
      setPasswordError('Yeni ÅŸifre en az 4 karakter olmalÄ±');
      return;
    }
    if (passwordData.new !== passwordData.confirm) {
      setPasswordError('Yeni ÅŸifreler eÅŸleÅŸmiyor!');
      return;
    }

    const updated = users.map(u => u.id === currentUser.id ? { ...u, password: passwordData.new } : u);
    setUsers(updated);
    
    const updatedCurrentUser = { ...currentUser, password: passwordData.new };
    setCurrentUser(updatedCurrentUser);
    localStorage.setItem('paydos_current_user', JSON.stringify(updatedCurrentUser));
    
    try { await supabase.from('users').update({ password: passwordData.new }).eq('id', currentUser.id); } catch (err) { console.error(err); }
    
    setPasswordSuccess('Åifre baÅŸarÄ±yla deÄŸiÅŸtirildi!');
    setPasswordData({ current: '', new: '', confirm: '' });
    setTimeout(() => setPasswordSuccess(''), 3000);
  };

  return (
    <div style={{ padding: isMobile ? '16px' : '24px' }}>
      <h2 style={{ fontSize: '20px', margin: '0 0 16px' }}>âš™ï¸ Ayarlar</h2>

      {/* Sekmeler */}
      <div style={{ display: 'flex', gap: '8px', marginBottom: '20px', flexWrap: 'wrap' }}>
        <button onClick={() => setActiveTab('profile')} style={{ padding: '12px 16px', background: activeTab === 'profile' ? 'rgba(59,130,246,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'profile' ? '1px solid rgba(59,130,246,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'profile' ? '#3b82f6' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'profile' ? '600' : '400' }}>
          ğŸ‘¤ Profil
        </button>
        <button onClick={() => setActiveTab('password')} style={{ padding: '12px 16px', background: activeTab === 'password' ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'password' ? '1px solid rgba(245,158,11,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'password' ? '#f59e0b' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'password' ? '600' : '400' }}>
          ğŸ” Åifre
        </button>
        {isAdmin && (
          <>
            <button onClick={() => setActiveTab('users')} style={{ padding: '12px 16px', background: activeTab === 'users' ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'users' ? '1px solid rgba(16,185,129,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'users' ? '#10b981' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'users' ? '600' : '400' }}>
              ğŸ‘¥ KullanÄ±cÄ±lar
            </button>
            <button onClick={() => setActiveTab('general')} style={{ padding: '12px 16px', background: activeTab === 'general' ? 'rgba(139,92,246,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'general' ? '1px solid rgba(139,92,246,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'general' ? '#8b5cf6' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'general' ? '600' : '400' }}>
              ğŸŒ Genel
            </button>
            <button onClick={() => setActiveTab('visaDurations')} style={{ padding: '12px 16px', background: activeTab === 'visaDurations' ? 'rgba(59,130,246,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'visaDurations' ? '1px solid rgba(59,130,246,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'visaDurations' ? '#3b82f6' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'visaDurations' ? '600' : '400' }}>
              ğŸ•’ Vize TÃ¼rleri
            </button>
            <button onClick={() => setActiveTab('visaPrices')} style={{ padding: '12px 16px', background: activeTab === 'visaPrices' ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'visaPrices' ? '1px solid rgba(16,185,129,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'visaPrices' ? '#10b981' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'visaPrices' ? '600' : '400' }}>
              ğŸ’° Vize FiyatlarÄ±
            </button>
            <button onClick={() => setActiveTab('statusManagement')} style={{ padding: '12px 16px', background: activeTab === 'statusManagement' ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.05)', border: activeTab === 'statusManagement' ? '1px solid rgba(245,158,11,0.3)' : '1px solid rgba(255,255,255,0.1)', borderRadius: '10px', color: activeTab === 'statusManagement' ? '#f59e0b' : '#94a3b8', cursor: 'pointer', fontSize: '12px', fontWeight: activeTab === 'statusManagement' ? '600' : '400' }}>
              ğŸ“Š Durum YÃ¶netimi
            </button>
          </>
        )}
      </div>

      {/* VÄ°ZE AYARLARI */}

      {/* ğŸŒ GENEL AYARLAR */}
      {activeTab === 'general' && isAdmin && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
          
          {/* Ä°ÅŸlemciler */}
          <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ margin: '0 0 12px', fontSize: '15px', color: '#3b82f6' }}>ğŸ‘¨â€ğŸ’¼ Ä°ÅŸlemciler</h3>
            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '12px' }}>
              {(appSettings?.processors || []).map((p, idx) => (
                <div key={idx} style={{ display: 'flex', alignItems: 'center', gap: '6px', background: 'rgba(59,130,246,0.15)', padding: '6px 10px', borderRadius: '6px', border: '1px solid rgba(59,130,246,0.3)' }}>
                  <span style={{ fontSize: '12px', color: '#3b82f6' }}>{p}</span>
                  <button onClick={() => setAppSettings({ ...appSettings, processors: appSettings.processors.filter((_, i) => i !== idx) })} style={{ background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer', fontSize: '14px', padding: '0', lineHeight: 1 }}>Ã—</button>
                </div>
              ))}
            </div>
            <div style={{ display: 'flex', gap: '8px' }}>
              <input type="text" value={newProcessor} onChange={e => setNewProcessor(e.target.value)} placeholder="Yeni iÅŸlemci" style={{ flex: 1, padding: '8px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: '#e8f1f8', fontSize: '12px' }} onKeyPress={e => { if (e.key === 'Enter' && newProcessor.trim()) { setAppSettings({ ...appSettings, processors: [...(appSettings.processors || []), newProcessor.trim()] }); setNewProcessor(''); } }} />
              <button onClick={() => { if (newProcessor.trim()) { setAppSettings({ ...appSettings, processors: [...(appSettings.processors || []), newProcessor.trim()] }); setNewProcessor(''); } }} style={{ padding: '8px 12px', background: 'linear-gradient(135deg, #3b82f6, #2563eb)', border: 'none', borderRadius: '6px', color: 'white', cursor: 'pointer', fontSize: '12px' }}>â•</button>
            </div>
          </div>

      {/* PROFÄ°LÄ°M */}
      {activeTab === 'profile' && (
        <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(255,255,255,0.05)' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '24px' }}>
            <div style={{ width: '64px', height: '64px', borderRadius: '50%', background: 'linear-gradient(135deg, #f59e0b, #d97706)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: '700', fontSize: '24px' }}>
              {currentUser?.name?.[0] || 'U'}
            </div>
            <div>
              <h3 style={{ margin: 0, fontSize: '18px' }}>{currentUser?.name}</h3>
              <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#64748b' }}>{currentUser?.email}</p>
              <span style={{ display: 'inline-block', marginTop: '8px', fontSize: '11px', padding: '4px 12px', borderRadius: '20px', background: currentUser?.role === 'admin' ? 'rgba(139,92,246,0.2)' : 'rgba(59,130,246,0.2)', color: currentUser?.role === 'admin' ? '#8b5cf6' : '#3b82f6' }}>
                {currentUser?.role === 'admin' ? 'ğŸ‘‘ YÃ¶netici' : 'ğŸ‘¤ KullanÄ±cÄ±'}
              </span>
            </div>
          </div>

          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
            <div style={{ background: 'rgba(255,255,255,0.05)', padding: '14px', borderRadius: '10px' }}>
              <p style={{ margin: 0, fontSize: '11px', color: '#64748b' }}>Ad Soyad</p>
              <p style={{ margin: '4px 0 0', fontSize: '15px' }}>{currentUser?.name}</p>
            </div>
            <div style={{ background: 'rgba(255,255,255,0.05)', padding: '14px', borderRadius: '10px' }}>
              <p style={{ margin: 0, fontSize: '11px', color: '#64748b' }}>E-posta</p>
              <p style={{ margin: '4px 0 0', fontSize: '15px' }}>{currentUser?.email}</p>
            </div>
            <div style={{ background: 'rgba(255,255,255,0.05)', padding: '14px', borderRadius: '10px' }}>
              <p style={{ margin: 0, fontSize: '11px', color: '#64748b' }}>Rol</p>
              <p style={{ margin: '4px 0 0', fontSize: '15px' }}>{currentUser?.role === 'admin' ? 'YÃ¶netici' : 'KullanÄ±cÄ±'}</p>
            </div>
          </div>

          <button onClick={() => openEditUser(currentUser)} style={{ width: '100%', marginTop: '20px', padding: '14px', background: 'linear-gradient(135deg, #3b82f6, #2563eb)', border: 'none', borderRadius: '10px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '14px' }}>
            âœï¸ Profili DÃ¼zenle
          </button>
        </div>
      )}

      {/* ÅÄ°FRE DEÄÄ°ÅTÄ°R */}
      {activeTab === 'password' && (
        <div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(255,255,255,0.05)' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '24px' }}>
            <div style={{ width: '48px', height: '48px', borderRadius: '12px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '24px' }}>ğŸ”</div>
            <div>
              <h3 style={{ margin: 0, fontSize: '16px' }}>Åifre DeÄŸiÅŸtir</h3>
              <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>Hesap gÃ¼venliÄŸiniz iÃ§in ÅŸifrenizi dÃ¼zenli deÄŸiÅŸtirin</p>
            </div>
          </div>

          {passwordError && (
            <div style={{ background: 'rgba(239,68,68,0.15)', padding: '12px', borderRadius: '10px', marginBottom: '16px', border: '1px solid rgba(239,68,68,0.3)' }}>
              <p style={{ margin: 0, fontSize: '13px', color: '#ef4444' }}>âŒ {passwordError}</p>
            </div>
          )}

          {passwordSuccess && (
            <div style={{ background: 'rgba(16,185,129,0.15)', padding: '12px', borderRadius: '10px', marginBottom: '16px', border: '1px solid rgba(16,185,129,0.3)' }}>
              <p style={{ margin: 0, fontSize: '13px', color: '#10b981' }}>âœ… {passwordSuccess}</p>
            </div>
          )}

          <form onSubmit={handlePasswordChange}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <div>
                <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>Mevcut Åifre *</label>
                <input type="password" value={passwordData.current} onChange={e => setPasswordData({...passwordData, current: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }} required />
              </div>
              <div>
                <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>Yeni Åifre *</label>
                <input type="password" value={passwordData.new} onChange={e => setPasswordData({...passwordData, new: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }} required />
              </div>
              <div>
                <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>Yeni Åifre Tekrar *</label>
                <input type="password" value={passwordData.confirm} onChange={e => setPasswordData({...passwordData, confirm: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }} required />
              </div>
              <button type="submit" style={{ width: '100%', padding: '14px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#0c1929', fontWeight: '700', cursor: 'pointer', fontSize: '14px' }}>
                ğŸ” Åifreyi DeÄŸiÅŸtir
              </button>
            </div>
          </form>
        </div>
      )}

      {/* KULLANICILAR (Sadece Admin) */}
      {activeTab === 'users' && isAdmin && (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <p style={{ margin: 0, fontSize: '14px', color: '#94a3b8' }}>Toplam {users.length} kullanÄ±cÄ±</p>
            <button onClick={openNewUserForm} style={{ background: 'linear-gradient(135deg, #10b981, #059669)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>
              â• Yeni KullanÄ±cÄ±
            </button>
          </div>

          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
            {users.map(user => (
              <div key={user.id} style={{ background: 'rgba(255,255,255,0.03)', padding: '16px', borderRadius: '12px', border: user.id === currentUser.id ? '1px solid rgba(245,158,11,0.3)' : '1px solid rgba(255,255,255,0.05)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <div style={{ width: '42px', height: '42px', borderRadius: '50%', background: user.role === 'admin' ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'linear-gradient(135deg, #3b82f6, #2563eb)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: '700', fontSize: '16px' }}>
                      {user.name?.[0] || 'U'}
                    </div>
                    <div>
                      <h4 style={{ margin: 0, fontSize: '14px' }}>
                        {user.name}
                        {user.id === currentUser.id && <span style={{ marginLeft: '8px', fontSize: '10px', color: '#f59e0b' }}>(Sen)</span>}
                      </h4>
                      <p style={{ margin: '2px 0 0', fontSize: '12px', color: '#64748b' }}>{user.email}</p>
                    </div>
                  </div>
                  <span style={{ fontSize: '10px', padding: '4px 10px', borderRadius: '20px', background: user.role === 'admin' ? 'rgba(139,92,246,0.2)' : 'rgba(59,130,246,0.2)', color: user.role === 'admin' ? '#8b5cf6' : '#3b82f6' }}>
                    {user.role === 'admin' ? 'YÃ¶netici' : 'KullanÄ±cÄ±'}
                  </span>
                </div>
                <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
                  <button onClick={() => openEditUser(user)} style={{ flex: 1, padding: '8px', background: 'rgba(59,130,246,0.15)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '8px', color: '#3b82f6', cursor: 'pointer', fontSize: '12px' }}>âœï¸ DÃ¼zenle</button>
                  {user.id !== currentUser.id && (
                    <button onClick={() => deleteUser(user.id)} style={{ flex: 1, padding: '8px', background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '8px', color: '#ef4444', cursor: 'pointer', fontSize: '12px' }}>ğŸ—‘ï¸ Sil</button>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* KULLANICI FORM MODAL */}
      {showUserForm && (
        <div onClick={() => setShowUserForm(false)} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 400, padding: '20px' }}>
          <div onClick={e => e.stopPropagation()} style={{ background: 'linear-gradient(135deg, #0c1929, #1a3a5c)', borderRadius: '16px', padding: '24px', maxWidth: '400px', width: '100%', maxHeight: '80vh', overflow: 'auto' }}>
            <h3 style={{ margin: '0 0 20px', fontSize: '18px' }}>{editingUser ? 'âœï¸ KullanÄ±cÄ± DÃ¼zenle' : 'â• Yeni KullanÄ±cÄ±'}</h3>
            
            <form onSubmit={handleUserSubmit}>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '14px' }}>
                <div>
                  <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>Ad Soyad *</label>
                  <input type="text" value={userFormData.name || ''} onChange={e => setUserFormData({...userFormData, name: e.target.value})} placeholder="Ad Soyad" style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }} required />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>E-posta *</label>
                  <input type="email" value={userFormData.email || ''} onChange={e => setUserFormData({...userFormData, email: e.target.value})} placeholder="email@ornek.com" style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }} required />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>{editingUser ? 'Yeni Åifre (boÅŸ bÄ±rakÄ±lÄ±rsa deÄŸiÅŸmez)' : 'Åifre *'}</label>
                  <input type="password" value={userFormData.password || ''} onChange={e => setUserFormData({...userFormData, password: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', boxSizing: 'border-box' }} {...(!editingUser && { required: true })} />
                </div>
                {isAdmin && editingUser?.id !== currentUser.id && (
                  <div>
                    <label style={{ display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px' }}>Rol</label>
                    <select value={userFormData.role || 'user'} onChange={e => setUserFormData({...userFormData, role: e.target.value})} style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px' }}>
                      <option value="user">KullanÄ±cÄ±</option>
                      <option value="admin">YÃ¶netici</option>
                    </select>
                  </div>
                )}
                <div style={{ display: 'flex', gap: '10px', marginTop: '8px' }}>
                  <button type="button" onClick={() => setShowUserForm(false)} style={{ flex: 1, padding: '12px', background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '10px', color: '#e8f1f8', cursor: 'pointer', fontSize: '14px' }}>Ä°ptal</button>
                  <button type="submit" style={{ flex: 1, padding: '12px', background: 'linear-gradient(135deg, #10b981, #059669)', border: 'none', borderRadius: '10px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '14px' }}>
                    {editingUser ? 'ğŸ’¾ Kaydet' : 'â• Ekle'}
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

export default function App() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [activeModule, setActiveModule] = useState('dashboard');
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [customers, setCustomers] = useState(defaultCustomers);
  const [visaApplications, setVisaApplications] = useState([]);
  const [agencies, setAgencies] = useState([]);
  const [creditCards, setCreditCards] = useState([]);
  const [quotes, setQuotes] = useState([]);
  const [users, setUsers] = useState(defaultUsers);
  const [isLoading, setIsLoading] = useState(true);
  const [toasts, setToasts] = useState([]);
  const [undoStack, setUndoStack] = useState([]);
  const [appSettings, setAppSettings] = useState({
    processors: ['Paydos', 'Ä°data', 'OÄŸuz'],
    whatsappTemplate: 'SayÄ±n {isim},\n\n{ulke} vize randevunuz {tarih} tarihinde saat {saat} iÃ§in alÄ±nmÄ±ÅŸtÄ±r.\n\nPNR: {pnr}\n\nLÃ¼tfen randevu tarihinden 7 gÃ¼n Ã¶nce evraklarÄ±nÄ±zÄ± hazÄ±rlayÄ±p bize teslim etmeniz gerekmektedir.\n\nPaydos Turizm',
    visaPrices: {
      schengen: { cost: 0, price: 0, currency: 'â‚¬' },
      usa: { cost: 0, price: 0, currency: '$' },
      russia: { cost: 0, price: 0, currency: 'â‚¬' },
      uk: { 
        '6 Ay Standart': { cost: 0, price: 0, currency: 'Â£' },
        '2 YÄ±l Standart': { cost: 0, price: 0, currency: 'Â£' },
        '5 YÄ±l Standart': { cost: 0, price: 0, currency: 'Â£' },
        '10 YÄ±l Standart': { cost: 0, price: 0, currency: 'Â£' }
      },
      uae: { cost: 0, price: 0, currency: '$' },
      other: { cost: 0, price: 0, currency: 'â‚¬' }
    },
    visaDurations: {
      usa: [
        {name: 'B1/B2 Turistik ve Ticari', price: 0, currency: '$'}
      ],
      russia: [
        {name: 'E-Vize Tek GiriÅŸli', price: 0, currency: 'â‚¬'}
      ],
      uk: [
        {name: '6 Ay Standart', price: 0, currency: 'Â£'},
        {name: '2 YÄ±l Standart', price: 0, currency: 'Â£'},
        {name: '5 YÄ±l Standart', price: 0, currency: 'Â£'},
        {name: '10 YÄ±l Standart', price: 0, currency: 'Â£'}
      ],
      uae: [
        {name: '14 GÃ¼nlÃ¼k Vize', price: 0, currency: '$'},
        {name: '30 GÃ¼nlÃ¼k Tek GiriÅŸ', price: 0, currency: '$'},
        {name: '30 GÃ¼nlÃ¼k Ã‡ok GiriÅŸli', price: 0, currency: '$'},
        {name: '60 GÃ¼nlÃ¼k Tek GiriÅŸ', price: 0, currency: '$'},
        {name: '60 GÃ¼nlÃ¼k Ã‡ok GiriÅŸli', price: 0, currency: '$'},
        {name: '96 Saat (Transit) Vize', price: 0, currency: '$'},
        {name: '30 GÃ¼nlÃ¼k GCC VatandaÅŸlarÄ±', price: 0, currency: '$'}
      ],
      china: [
        {name: 'Turistik Vize', price: 0, currency: 'â‚¬'},
        {name: 'Ticari Vize', price: 0, currency: 'â‚¬'},
        {name: 'Transit Vize', price: 0, currency: 'â‚¬'}
      ]
    },
    personalDetailsFields: ['DoÄŸum Tarihi', 'DoÄŸum Yeri', 'Ä°kametgah Ä°li', 'TK Ãœyelik No'],
    visaStatuses: ['Evrak Topluyor', 'Evrak TamamlandÄ±', 'Randevu AlÄ±ndÄ±', 'BaÅŸvuru YapÄ±ldÄ±', 'SonuÃ§ Bekliyor', 'OnaylandÄ±', 'Reddedildi'],
    bankInfo: {
      bankName: 'Ziraat BankasÄ±',
      accountName: 'PAYDOS TURÄ°ZM',
      iban: 'TR00 0000 0000 0000 0000 0000 00',
      swift: 'TCZBTR2AXXX'
    }
  });

  // Toast fonksiyonlarÄ±
  const showToast = useCallback((message, type = 'info', undo = null) => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, message, type, undo }]);
    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), undo ? 8000 : 4000);
  }, []);

  const removeToast = useCallback((id) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);

  // Undo fonksiyonu
  const addToUndo = useCallback((action) => {
    setUndoStack(prev => [...prev.slice(-9), action]);
  }, []);

  const performUndo = useCallback(() => {
    if (undoStack.length === 0) return;
    const lastAction = undoStack[undoStack.length - 1];
    if (lastAction) {
      lastAction.undo();
      setUndoStack(prev => prev.slice(0, -1));
      showToast('Ä°ÅŸlem geri alÄ±ndÄ±', 'success');
    }
  }, [undoStack, showToast]);

  // Klavye kÄ±sayollarÄ±
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Ctrl/Cmd + Z = Undo
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        performUndo();
      }
      // Ctrl/Cmd + 1-7 = ModÃ¼l deÄŸiÅŸtir
      if ((e.ctrlKey || e.metaKey) && ['1', '2', '3', '4', '5', '6', '7'].includes(e.key)) {
        e.preventDefault();
        const modules = ['dashboard', 'customers', 'visa', 'quotes', 'agencies', 'cards', 'settings'];
        setActiveModule(modules[parseInt(e.key) - 1]);
        showToast(`${['Dashboard', 'MÃ¼ÅŸteriler', 'Vize', 'Teklif & Proforma', 'Acentelikler', 'Kredi KartlarÄ±', 'Ayarlar'][parseInt(e.key) - 1]} aÃ§Ä±ldÄ±`, 'info');
      }
      // Escape = Sidebar kapat
      if (e.key === 'Escape' && sidebarOpen) {
        setSidebarOpen(false);
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [performUndo, sidebarOpen, showToast]);

  useEffect(() => { const handleResize = () => setIsMobile(window.innerWidth < 768); window.addEventListener('resize', handleResize); return () => window.removeEventListener('resize', handleResize); }, []);
  useEffect(() => { const loggedIn = localStorage.getItem('paydos_logged_in'); const savedUser = localStorage.getItem('paydos_current_user'); if (loggedIn === 'true' && savedUser) { try { setCurrentUser(JSON.parse(savedUser)); setIsLoggedIn(true); } catch (e) { console.error(e); } } }, []);
  
  // localStorage'dan yÃ¼kle - EN Ã–NCE
  useEffect(() => { const saved = localStorage.getItem('paydos_customers'); if (saved) { try { setCustomers(JSON.parse(saved)); } catch (e) { console.error(e); } } }, []);
  useEffect(() => { const saved = localStorage.getItem('paydos_visa_applications'); if (saved) { try { setVisaApplications(JSON.parse(saved)); } catch (e) { console.error(e); } } }, []);
  useEffect(() => { 
    const saved = localStorage.getItem('paydos_app_settings'); 
    if (saved) { 
      try { 
        const settings = JSON.parse(saved);
        
        // MIGRATION: String array â†’ Object array
        if (settings.visaDurations) {
          Object.keys(settings.visaDurations).forEach(country => {
            const durations = settings.visaDurations[country];
            if (durations && durations.length > 0 && typeof durations[0] === 'string') {
              // Eski format: string array
              settings.visaDurations[country] = durations.map(name => ({
                name: name,
                price: 0,
                currency: country === 'usa' ? '$' : country === 'uk' ? 'Â£' : 'â‚¬'
              }));
              console.log(`âœ… Migrated ${country}: ${durations.length} items`);
            }
          });
        }
        
        setAppSettings(settings);
      } catch (e) { 
        console.error(e); 
      } 
    } 
  }, []);
  useEffect(() => { const saved = localStorage.getItem('paydos_agencies'); if (saved) { try { setAgencies(JSON.parse(saved)); } catch (e) { console.error(e); } } }, []);
  useEffect(() => { const saved = localStorage.getItem('paydos_credit_cards'); if (saved) { try { setCreditCards(JSON.parse(saved)); } catch (e) { console.error(e); } } }, []);
  useEffect(() => { const saved = localStorage.getItem('paydos_quotes'); if (saved) { try { setQuotes(JSON.parse(saved)); } catch (e) { console.error(e); } } }, []);
  
  // Supabase'den yÃ¼kle - SONRA (localStorage'Ä± override eder)
  useEffect(() => { loadDataFromSupabase(); }, []);
  
  // localStorage'a kaydet - deÄŸiÅŸtiÄŸinde
  useEffect(() => { localStorage.setItem('paydos_customers', JSON.stringify(customers)); }, [customers]);
  useEffect(() => { localStorage.setItem('paydos_visa_applications', JSON.stringify(visaApplications)); }, [visaApplications]);
  useEffect(() => { localStorage.setItem('paydos_app_settings', JSON.stringify(appSettings)); }, [appSettings]);
  useEffect(() => { localStorage.setItem('paydos_agencies', JSON.stringify(agencies)); }, [agencies]);
  useEffect(() => { localStorage.setItem('paydos_credit_cards', JSON.stringify(creditCards)); }, [creditCards]);
  useEffect(() => { localStorage.setItem('paydos_quotes', JSON.stringify(quotes)); }, [quotes]);

  const loadDataFromSupabase = async () => {
    setIsLoading(true);
    try {
      // Supabase'den yÃ¼kle - sadece veri varsa gÃ¼ncelle
      const { data: customersData } = await supabase.from('customers').select('*').order('created_at', { ascending: false });
      if (customersData && customersData.length > 0) {
        setCustomers(customersData.map(c => ({ ...toCamelCase(c), tags: safeParseTags(c.tags), activities: safeParseActivities(c.activities) })));
      }
      
      const { data: visaData } = await supabase.from('visa_applications').select('*').order('created_at', { ascending: false });
      if (visaData && visaData.length > 0) {
        setVisaApplications(visaData.map(toCamelCase));
      }
      
      const { data: usersData } = await supabase.from('users').select('*');
      if (usersData && usersData.length > 0) {
        setUsers(usersData.map(toCamelCase));
      }
    } catch (err) { 
      console.error('Load error:', err); 
      // Hata olursa localStorage'daki veri zaten yÃ¼klenmiÅŸ olacak
    }
    setIsLoading(false);
  };

  const handleLogin = (user) => { setIsLoggedIn(true); setCurrentUser(user); localStorage.setItem('paydos_logged_in', 'true'); localStorage.setItem('paydos_current_user', JSON.stringify(user)); };
  const handleLogout = () => { setIsLoggedIn(false); setCurrentUser(null); localStorage.removeItem('paydos_logged_in'); localStorage.removeItem('paydos_current_user'); };

  if (!isLoggedIn) return <LoginScreen onLogin={handleLogin} users={users} />;
  if (isLoading) return (<div style={{ position: 'fixed', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #0c1929 0%, #1a3a5c 50%, #0d2137 100%)' }}><div style={{ textAlign: 'center' }}><div style={{ fontSize: '48px', marginBottom: '16px' }}>âœˆï¸</div><p style={{ color: '#94a3b8' }}>YÃ¼kleniyor...</p></div></div>);

  const menuItems = [
    { id: 'dashboard', icon: 'ğŸ“Š', label: 'Dashboard' }, 
    { id: 'customers', icon: 'ğŸ‘¥', label: 'MÃ¼ÅŸteriler' },
    { id: 'visa', icon: 'ğŸŒ', label: 'Vize' },
    { id: 'quotes', icon: 'ğŸ“„', label: 'Teklif & Proforma' },
    { id: 'agencies', icon: 'ğŸ¢', label: 'Acentelikler' },
    { id: 'cards', icon: 'ğŸ’³', label: 'Kredi KartlarÄ±' },
    { id: 'settings', icon: 'âš™ï¸', label: 'Ayarlar' }
  ];

  const renderModule = () => {
    switch (activeModule) {
      case 'dashboard': return <DashboardModule customers={customers} isMobile={isMobile} />;
      case 'customers': return <CustomerModule customers={customers} setCustomers={setCustomers} isMobile={isMobile} showToast={showToast} addToUndo={addToUndo} appSettings={appSettings} />;
      case 'visa': return <VisaModule customers={customers} visaApplications={visaApplications} setVisaApplications={setVisaApplications} isMobile={isMobile} onNavigateToCustomers={() => setActiveModule('customers')} appSettings={appSettings} showToast={showToast} addToUndo={addToUndo} />;
      case 'quotes': return <QuotesModule quotes={quotes} setQuotes={setQuotes} customers={customers} isMobile={isMobile} showToast={showToast} />;
      case 'agencies': return <AgenciesModule agencies={agencies} setAgencies={setAgencies} isMobile={isMobile} showToast={showToast} addToUndo={addToUndo} />;
      case 'cards': return <CreditCardsModule creditCards={creditCards} setCreditCards={setCreditCards} isMobile={isMobile} showToast={showToast} addToUndo={addToUndo} />;
      case 'settings': return <SettingsModule users={users} setUsers={setUsers} currentUser={currentUser} setCurrentUser={setCurrentUser} isMobile={isMobile} appSettings={appSettings} setAppSettings={setAppSettings} showToast={showToast} />;
      default: return <DashboardModule customers={customers} isMobile={isMobile} />;
    }
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #0c1929 0%, #1a3a5c 50%, #0d2137 100%)', color: '#e8f1f8', fontFamily: "'Segoe UI', system-ui, sans-serif" }}>
      {/* Toast Bildirimleri */}
      <Toast toasts={toasts} removeToast={removeToast} />
      
      {/* Klavye KÄ±sayollarÄ± Bilgisi */}
      {!isMobile && (
        <div style={{ position: 'fixed', bottom: '20px', left: '280px', fontSize: '10px', color: '#64748b', zIndex: 50 }}>
          âŒ¨ï¸ Ctrl+1-7: ModÃ¼l | Ctrl+Z: Geri Al
        </div>
      )}
      
      {isMobile && sidebarOpen && <div onClick={() => setSidebarOpen(false)} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 100 }} />}
      <aside style={{ position: 'fixed', left: isMobile ? (sidebarOpen ? 0 : '-280px') : 0, top: 0, bottom: 0, width: '260px', background: 'rgba(0,0,0,0.3)', backdropFilter: 'blur(10px)', borderRight: '1px solid rgba(255,255,255,0.1)', zIndex: 200, transition: 'left 0.3s ease', display: 'flex', flexDirection: 'column' }}>
        <div style={{ padding: '20px', borderBottom: '1px solid rgba(255,255,255,0.1)' }}><div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}><span style={{ fontSize: '32px' }}>âœˆï¸</span><div><h1 style={{ margin: 0, fontSize: '18px', fontWeight: '700' }}>Paydos</h1><p style={{ margin: 0, fontSize: '11px', color: '#94a3b8' }}>Turizm CRM</p></div></div></div>
        <nav style={{ flex: 1, padding: '16px 12px' }}>{menuItems.map((item, idx) => (<button key={item.id} onClick={() => { setActiveModule(item.id); if (isMobile) setSidebarOpen(false); }} style={{ width: '100%', display: 'flex', alignItems: 'center', gap: '12px', padding: '12px 16px', marginBottom: '4px', background: activeModule === item.id ? 'rgba(245,158,11,0.15)' : 'transparent', border: activeModule === item.id ? '1px solid rgba(245,158,11,0.3)' : '1px solid transparent', borderRadius: '10px', color: activeModule === item.id ? '#f59e0b' : '#94a3b8', cursor: 'pointer', fontSize: '14px', fontWeight: activeModule === item.id ? '600' : '400' }}><span style={{ fontSize: '18px' }}>{item.icon}</span>{item.label}{!isMobile && <span style={{ marginLeft: 'auto', fontSize: '10px', color: '#64748b' }}>âŒ˜{idx+1}</span>}</button>))}</nav>
        <div style={{ padding: '16px', borderTop: '1px solid rgba(255,255,255,0.1)' }}><div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}><div style={{ width: '36px', height: '36px', borderRadius: '50%', background: 'linear-gradient(135deg, #f59e0b, #d97706)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: '700', fontSize: '14px' }}>{currentUser?.name?.[0] || 'U'}</div><div><p style={{ margin: 0, fontSize: '13px', fontWeight: '600' }}>{currentUser?.name}</p><p style={{ margin: 0, fontSize: '10px', color: '#64748b' }}>{currentUser?.role === 'admin' ? 'YÃ¶netici' : 'KullanÄ±cÄ±'}</p></div></div><button onClick={handleLogout} style={{ width: '100%', padding: '10px', background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.2)', borderRadius: '8px', color: '#ef4444', cursor: 'pointer', fontSize: '12px' }}>ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button></div>
      </aside>
      <main style={{ marginLeft: isMobile ? 0 : '260px', minHeight: '100vh' }}>
        {isMobile && <header style={{ position: 'sticky', top: 0, background: 'rgba(12,25,41,0.95)', backdropFilter: 'blur(10px)', borderBottom: '1px solid rgba(255,255,255,0.1)', padding: '12px 16px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', zIndex: 50 }}><button onClick={() => setSidebarOpen(true)} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '8px 12px', color: '#e8f1f8', cursor: 'pointer', fontSize: '18px' }}>â˜°</button><div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}><span style={{ fontSize: '24px' }}>âœˆï¸</span><span style={{ fontWeight: '700' }}>Paydos</span></div><div style={{ width: '40px' }} /></header>}
        {renderModule()}
      </main>
    </div>
  );
}
